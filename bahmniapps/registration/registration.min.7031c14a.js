"use strict";function getWatchers(e){var t=e?angular.element(e):angular.element(document.getElementsByTagName("body")),n=[],r=function(e){angular.forEach(["$scope","$isolateScope"],function(t){e.data()&&e.data().hasOwnProperty(t)&&angular.forEach(e.data()[t].$$watchers,function(e){n.push(e)})}),angular.forEach(e.children(),function(e){r(angular.element(e))})};r(t);var i=[];return angular.forEach(n,function(e){i.indexOf(e)<0&&i.push(e)}),console.log(i),i}(Bahmni=Bahmni||{}).Common=Bahmni.Common||{},function(){var e=localStorage.getItem("host")?"https://"+localStorage.getItem("host"):"",t=localStorage.getItem("rootDir")||"",n=e+"/openmrs/ws/rest/v1",r=n+"/bahmnicore",i=e+"/openmrs/ws/rest"+"/emrapi",o=n,a=e+"/bahmni_config/openmrs/apps/",s=e+"/implementation_config/openmrs/apps/",u=n+"/bahmniie",c={"/openmrs/ws/rest/v1/idgen/identifiertype":"IdentifierTypes","/openmrs/module/addresshierarchy/ajax/getOrderedAddressHierarchyLevels.form":"AddressHierarchyLevels","/openmrs/ws/rest/v1/bahmnicore/sql/globalproperty?property=mrs.genders":"Genders","/openmrs/ws/rest/v1/bahmnicore/sql/globalproperty?property=bahmni.encountersession.duration":"encounterSessionDuration","/openmrs/ws/rest/v1/bahmnicore/sql/globalproperty?property=bahmni.relationshipTypeMap":"RelationshipTypeMap","/openmrs/ws/rest/v1/bahmnicore/config/bahmniencounter?callerContext=REGISTRATION_CONCEPTS":"RegistrationConcepts","/openmrs/ws/rest/v1/relationshiptype?v=custom:(aIsToB,bIsToA,uuid)":"RelationshipType","/openmrs/ws/rest/v1/personattributetype?v=custom:(uuid,name,sortWeight,description,format,concept)":"PersonAttributeType","/openmrs/ws/rest/v1/entitymapping?mappingType=loginlocation_visittype&s=byEntityAndMappingType":"LoginLocationToVisitTypeMapping","/openmrs/ws/rest/v1/bahmnicore/config/patient":"PatientConfig","/openmrs/ws/rest/v1/concept?s=byFullySpecifiedName&name=Consultation+Note&v=custom:(uuid,name,answers)":"ConsultationNote","/openmrs/ws/rest/v1/concept?s=byFullySpecifiedName&name=Lab+Order+Notes&v=custom:(uuid,name)":"LabOrderNotes","/openmrs/ws/rest/v1/concept?s=byFullySpecifiedName&name=Impression&v=custom:(uuid,name)":"RadiologyImpressionConfig","/openmrs/ws/rest/v1/concept?s=byFullySpecifiedName&name=All_Tests_and_Panels&v=custom:(uuid,name:(uuid,name),setMembers:(uuid,name:(uuid,name)))":"AllTestsAndPanelsConcept","/openmrs/ws/rest/v1/concept?s=byFullySpecifiedName&name=Dosage+Frequency&v=custom:(uuid,name,answers)":"DosageFrequencyConfig","/openmrs/ws/rest/v1/concept?s=byFullySpecifiedName&name=Dosage+Instructions&v=custom:(uuid,name,answers)":"DosageInstructionConfig","/openmrs/ws/rest/v1/bahmnicore/sql/globalproperty?property=bahmni.encounterType.default":"DefaultEncounterType","/openmrs/ws/rest/v1/concept?s=byFullySpecifiedName&name=Stopped+Order+Reason&v=custom:(uuid,name,answers)":"StoppedOrderReasonConfig","/openmrs/ws/rest/v1/ordertype":"OrderType","/openmrs/ws/rest/v1/bahmnicore/config/drugOrders":"DrugOrderConfig","/openmrs/ws/rest/v1/bahmnicore/sql/globalproperty?property=drugOrder.drugOther":"NonCodedDrugConcept"};c["/openmrs/ws/rest/v1/entitymapping?mappingType=location_encountertype&s=byEntityAndMappingType&entityUuid="+(localStorage.getItem("LoginInformation")?JSON.parse(localStorage.getItem("LoginInformation")).currentLocation.uuid:"")]="LoginLocationToEncounterTypeMapping",Bahmni.Common.Constants={hostURL:e,dateFormat:"dd/mm/yyyy",dateDisplayFormat:"DD-MMM-YYYY",timeDisplayFormat:"hh:mm",emrapiDiagnosisUrl:i+"/diagnosis",bahmniDiagnosisUrl:r+"/diagnosis/search",bahmniDeleteDiagnosisUrl:r+"/diagnosis/delete",diseaseTemplateUrl:r+"/diseaseTemplates",AllDiseaseTemplateUrl:r+"/diseaseTemplate",emrapiConceptUrl:i+"/concept",encounterConfigurationUrl:r+"/config/bahmniencounter",patientConfigurationUrl:r+"/config/patient",drugOrderConfigurationUrl:r+"/config/drugOrders",emrEncounterUrl:i+"/encounter",encounterUrl:n+"/encounter",locationUrl:n+"/location",bahmniVisitLocationUrl:r+"/visitLocation",bahmniOrderUrl:r+"/orders",bahmniDrugOrderUrl:r+"/drugOrders",bahmniDispositionByVisitUrl:r+"/disposition/visitWithLocale",bahmniDispositionByPatientUrl:r+"/disposition/patientWithLocale",bahmniSearchUrl:r+"/search",bahmniLabOrderResultsUrl:r+"/labOrderResults",bahmniEncounterUrl:r+"/bahmniencounter",conceptUrl:n+"/concept",bahmniConceptAnswerUrl:n+"/bahmniconceptanswer",conceptSearchByFullNameUrl:n+"/concept?s=byFullySpecifiedName",visitUrl:n+"/visit",endVisitUrl:r+"/visit/endVisit",endVisitAndCreateEncounterUrl:r+"/visit/endVisitAndCreateEncounter",visitTypeUrl:n+"/visittype",patientImageUrlByPatientUuid:n+"/patientImage?patientUuid=",labResultUploadedFileNameUrl:"/uploaded_results/",visitSummaryUrl:r+"/visit/summary",encounterModifierUrl:r+"/bahmniencountermodifier",openmrsUrl:e+"/openmrs",loggingUrl:e+"/log/",idgenConfigurationURL:n+"/idgen/identifiertype",bahmniRESTBaseURL:r+"",observationsUrl:r+"/observations",obsRelationshipUrl:r+"/obsrelationships",encounterImportUrl:r+"/admin/upload/encounter",programImportUrl:r+"/admin/upload/program",conceptImportUrl:r+"/admin/upload/concept",conceptSetImportUrl:r+"/admin/upload/conceptset",drugImportUrl:r+"/admin/upload/drug",labResultsImportUrl:r+"/admin/upload/labResults",referenceTermsImportUrl:r+"/admin/upload/referenceterms",updateReferenceTermsImportUrl:r+"/admin/upload/referenceterms/new",relationshipImportUrl:r+"/admin/upload/relationship",conceptSetExportUrl:r+"/admin/export/conceptset?conceptName=:conceptName",patientImportUrl:r+"/admin/upload/patient",adminImportStatusUrl:r+"/admin/upload/status",programUrl:n+"/program",programEnrollPatientUrl:n+"/bahmniprogramenrollment",programStateDeletionUrl:n+"/programenrollment",programEnrollmentDefaultInformation:"default",programEnrollmentFullInformation:"full",programAttributeTypes:n+"/programattributetype",relationshipTypesUrl:n+"/relationshiptype",personAttributeTypeUrl:n+"/personattributetype",diseaseSummaryPivotUrl:r+"/diseaseSummaryData",allTestsAndPanelsConceptName:"All_Tests_and_Panels",dosageFrequencyConceptName:"Dosage Frequency",dosageInstructionConceptName:"Dosage Instructions",stoppedOrderReasonConceptName:"Stopped Order Reason",consultationNoteConceptName:"Consultation Note",diagnosisConceptSet:"Diagnosis Concept Set",radiologyOrderType:"Radiology Order",radiologyResultConceptName:"Radiology Result",investigationEncounterType:"INVESTIGATION",validationNotesEncounterType:"VALIDATION NOTES",labOrderNotesConcept:"Lab Order Notes",impressionConcept:"Impression",qualifiedByRelationshipType:"qualified-by",dispositionConcept:"Disposition",dispositionGroupConcept:"Disposition Set",dispositionNoteConcept:"Disposition Note",ruledOutDiagnosisConceptName:"Ruled Out Diagnosis",emrapiConceptMappingSource:"org.openmrs.module.emrapi",abbreviationConceptMappingSource:"Abbreviation",includeAllObservations:!1,openmrsObsUrl:n+"/obs",openmrsObsRepresentation:"custom:(uuid,obsDatetime,value:(uuid,name:(uuid,name)))",admissionCode:"ADMIT",dischargeCode:"DISCHARGE",transferCode:"TRANSFER",undoDischargeCode:"UNDO_DISCHARGE",vitalsConceptName:"Vitals",heightConceptName:"HEIGHT",weightConceptName:"WEIGHT",bmiConceptName:"BMI",bmiStatusConceptName:"BMI STATUS",abnormalObservationConceptName:"IS_ABNORMAL",documentsPath:"/document_images",documentsConceptName:"Document",miscConceptClassName:"Misc",abnormalConceptClassName:"Abnormal",unknownConceptClassName:"Unknown",durationConceptClassName:"Duration",conceptDetailsClassName:"Concept Details",admissionEncounterTypeName:"ADMISSION",dischargeEncounterTypeName:"DISCHARGE",imageClassName:"Image",videoClassName:"Video",locationCookieName:"bahmni.user.location",retrospectiveEntryEncounterDateCookieName:"bahmni.clinical.retrospectiveEncounterDate",JSESSIONID:"JSESSIONID",rootScopeRetrospectiveEntry:"retrospectiveEntry.encounterDate",patientFileConceptName:"Patient file",serverErrorMessages:[{serverMessage:"Cannot have more than one active order for the same orderable and care setting at same time",clientMessage:"One or more drugs you are trying to order are already active. Please change the start date of the conflicting drug or remove them from the new prescription."},{serverMessage:"[Order.cannot.have.more.than.one]",clientMessage:"One or more drugs you are trying to order are already active. Please change the start date of the conflicting drug or remove them from the new prescription."}],currentUser:"bahmni.user",retrospectivePrivilege:"app:clinical:retrospective",locationPickerPrivilege:"app:clinical:locationpicker",onBehalfOfPrivilege:"app:clinical:onbehalf",nutritionalConceptName:"Nutritional Values",messageForNoObservation:"NO_OBSERVATIONS_CAPTURED",messageForNoDisposition:"NO_DISPOSTIONS_AVAILABLE_MESSAGE_KEY",messageForNoFulfillment:"NO_FULFILMENT_MESSAGE",reportsUrl:"/bahmnireports",uploadReportTemplateUrl:"/bahmnireports/upload",ruledOutdiagnosisStatus:"Ruled Out Diagnosis",registartionConsultationPrivilege:"app:common:registration_consultation_link",manageIdentifierSequencePrivilege:"Manage Identifier Sequence",closeVisitPrivilege:"app:common:closeVisit",deleteDiagnosisPrivilege:"app:clinical:deleteDiagnosis",viewPatientsPrivilege:"View Patients",editPatientsPrivilege:"Edit Patients",addVisitsPrivilege:"Add Visits",deleteVisitsPrivilege:"Delete Visits",grantProviderAccess:"app:clinical:grantProviderAccess",grantProviderAccessDataCookieName:"app.clinical.grantProviderAccessData",globalPropertyUrl:r+"/sql/globalproperty",passwordPolicyUrl:r+"/globalProperty/passwordPolicyProperties",fulfillmentConfiguration:"fulfillment",fulfillmentFormSuffix:" Fulfillment Form",noNavigationLinksMessage:"NO_NAVIGATION_LINKS_AVAILABLE_MESSAGE",conceptSetRepresentationForOrderFulfillmentConfig:"custom:(uuid,name,names,conceptClass,setMembers:(uuid,name,names,conceptClass,setMembers:(uuid,name,names,conceptClass,setMembers:(uuid,name,names,conceptClass))))",entityMappingUrl:n+"/entitymapping",encounterTypeUrl:n+"/encountertype",defaultExtensionName:"default",orderSetMemberAttributeTypeUrl:n+"/ordersetmemberattributetype",orderSetUrl:n+"/bahmniorderset",primaryOrderSetMemberAttributeTypeName:"Primary",bahmniBacteriologyResultsUrl:o+"/specimen",bedFromVisit:n+"/beds",ordersUrl:n+"/order",formDataUrl:n+"/obs",providerUrl:n+"/provider",drugUrl:n+"/drug",orderTypeUrl:n+"/ordertype",userUrl:n+"/user",passwordUrl:n+"/password",formUrl:n+"/form",allFormsUrl:n+"/bahmniie/form/allForms",latestPublishedForms:n+"/bahmniie/form/latestPublishedForms",formTranslationsUrl:n+"/bahmniie/form/translations",sqlUrl:r+"/sql",patientAttributeDateFieldFormat:"org.openmrs.util.AttributableDate",platform:"user.platform",RESTWS_V1:n,baseUrl:a,customUrl:s,faviconUrl:e+"/bahmni/favicon.ico",platformType:{other:"other"},numericDataType:"Numeric",encryptionType:{SHA3:"SHA3"},LoginInformation:"LoginInformation",ServerDateTimeFormat:"YYYY-MM-DDTHH:mm:ssZZ",calculateDose:r+"/calculateDose",unAuthenticatedReferenceDataMap:{"/openmrs/ws/rest/v1/location?tags=Login+Location&s=byTags&v=default":"LoginLocations","/openmrs/ws/rest/v1/bahmnicore/sql/globalproperty?property=locale.allowed.list":"LocaleList"},authenticatedReferenceDataMap:c,rootDir:t,dischargeUrl:r+"/discharge",uuidRegex:"[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}",eventlogFilterUrl:e+"/openmrs/ws/rest/v1/eventlog/filter",bahmniConnectMetaDataDb:"metaData",serverDateTimeUrl:"/cgi-bin/systemdate",loginText:"/bahmni_config/openmrs/apps/home/whiteLabel.json",auditLogUrl:n+"/auditlog",appointmentServiceUrl:n+"/appointmentService",conditionUrl:i+"/condition",conditionHistoryUrl:i+"/conditionhistory",followUpConditionConcept:"Follow-up Condition",localeLangs:"/bahmni_config/openmrs/apps/home/locale_languages.json",privilegeRequiredErrorMessage:"PRIVILEGE_REQUIRED",patientFormsUrl:r+"/patient/{patientUuid}/forms",defaultPossibleRelativeSearchLimit:10,formBuilderDisplayControlType:"formsV2",formBuilderType:"v2",formBuilderTranslationApi:u+"/form/translate",disposition:"DISPOSITION",registration:"REGISTRATION",clinical:"CLINICAL",diagnosis:"DIAGNOSIS",ot:"OT",patientAttribute:"PATIENT_ATTRIBUTE",program:"PROGRAM",visitType:"VISIT_TYPE",bedmanagement:"BEDMANAGEMENT",bedmanagementDisposition:"BEDMANAGEMENT_DISPOSITION",loginConfig:"/bahmni_config/openmrs/apps/home/login_config.json",visit:"VISIT"}}(),function(){function e(e,t){return e.set(t[0],t[1]),e}function t(e,t){return e.add(t),e}function n(e,t,n){switch(n.length){case 0:return e.call(t);case 1:return e.call(t,n[0]);case 2:return e.call(t,n[0],n[1]);case 3:return e.call(t,n[0],n[1],n[2])}return e.apply(t,n)}function r(e,t,n,r){for(var i=-1,o=e.length;++i<o;){var a=e[i];t(r,a,n(a),e)}return r}function i(e,t){for(var n=-1,r=e.length;++n<r&&!1!==t(e[n],n,e););return e}function o(e,t){for(var n=-1,r=e.length;++n<r;)if(!t(e[n],n,e))return!1;return!0}function a(e,t){for(var n=-1,r=e.length,i=-1,o=[];++n<r;){var a=e[n];t(a,n,e)&&(o[++i]=a)}return o}function s(e,t){return!!e.length&&-1<v(e,t,0)}function u(e,t,n){for(var r=-1,i=e.length;++r<i;)if(n(t,e[r]))return!0;return!1}function c(e,t){for(var n=-1,r=e.length,i=Array(r);++n<r;)i[n]=t(e[n],n,e);return i}function l(e,t){for(var n=-1,r=t.length,i=e.length;++n<r;)e[i+n]=t[n];return e}function m(e,t,n,r){var i=-1,o=e.length;for(r&&o&&(n=e[++i]);++i<o;)n=t(n,e[i],i,e);return n}function f(e,t,n,r){var i=e.length;for(r&&i&&(n=e[--i]);i--;)n=t(n,e[i],i,e);return n}function p(e,t){for(var n=-1,r=e.length;++n<r;)if(t(e[n],n,e))return!0;return!1}function d(e,t,n){for(var r=-1,i=e.length;++r<i;){var o=e[r],a=t(o);if(null!=a&&(s===$?a==a:n(a,s)))var s=a,u=o}return u}function h(e,t,n,r){var i;return n(e,function(e,n,o){return t(e,n,o)?(i=r?n:e,!1):void 0}),i}function g(e,t,n){for(var r=e.length,i=n?r:-1;n?i--:++i<r;)if(t(e[i],i,e))return i;return-1}function v(e,t,n){if(t!=t)return U(e,n);--n;for(var r=e.length;++n<r;)if(e[n]===t)return n;return-1}function b(e,t,n,r,i){return i(e,function(e,i,o){n=r?(r=!1,e):t(n,e,i,o)}),n}function y(e,t){for(var n,r=-1,i=e.length;++r<i;){var o=t(e[r]);o!==$&&(n=n===$?o:n+o)}return n}function C(e,t){for(var n=-1,r=Array(e);++n<e;)r[n]=t(n);return r}function _(e,t){return c(t,function(t){return[t,e[t]]})}function S(e){return function(t){return e(t)}}function T(e,t){return c(t,function(t){return e[t]})}function E(e,t){for(var n=-1,r=e.length;++n<r&&-1<v(t,e[n],0););return n}function A(e,t){for(var n=e.length;n--&&-1<v(t,e[n],0););return n}function D(e){return e&&e.Object===Object?e:null}function w(e,t){if(e!==t){var n=null===e,r=e===$,i=e==e,o=null===t,a=t===$,s=t==t;if(e>t&&!o||!i||n&&!a&&s||r&&s)return 1;if(t>e&&!n||!s||o&&!r&&i||a&&i)return-1}return 0}function O(e){return Ie[e]}function N(e){return Ue[e]}function I(e){return"\\"+Me[e]}function U(e,t,n){var r=e.length;for(t+=n?0:-1;n?t--:++t<r;){var i=e[t];if(i!=i)return t}return-1}function B(e){var t=!1;if(null!=e&&"function"!=typeof e.toString)try{t=!!(e+"")}catch(e){}return t}function P(e,t){return(e="number"==typeof e||he.test(e)?+e:-1)>-1&&0==e%1&&(null==t?9007199254740991:t)>e}function M(e){for(var t,n=[];!(t=e.next()).done;)n.push(t.value);return n}function V(e){var t=-1,n=Array(e.size);return e.forEach(function(e,r){n[++t]=[r,e]}),n}function R(e,t){for(var n=-1,r=e.length,i=-1,o=[];++n<r;)e[n]===t&&(e[n]="__lodash_placeholder__",o[++i]=n);return o}function x(e){var t=-1,n=Array(e.size);return e.forEach(function(e){n[++t]=e}),n}function L(e){if(!e||!Te.test(e))return e.length;for(var t=Se.lastIndex=0;Se.test(e);)t++;return t}function F(e){return Be[e]}var $,k=1/0,j=NaN,G=/\b__p\+='';/g,W=/\b(__p\+=)''\+/g,Y=/(__e\(.*?\)|\b__t\))\+'';/g,H=/&(?:amp|lt|gt|quot|#39|#96);/g,q=/[&<>"'`]/g,z=RegExp(H.source),K=RegExp(q.source),Z=/<%-([\s\S]+?)%>/g,J=/<%([\s\S]+?)%>/g,Q=/<%=([\s\S]+?)%>/g,X=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,ee=/^\w*$/,te=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]/g,ne=/[\\^$.*+?()[\]{}|]/g,re=RegExp(ne.source),ie=/^\s+|\s+$/g,oe=/^\s+/,ae=/\s+$/,se=/\\(\\)?/g,ue=/\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g,ce=/\w*$/,le=/^0x/i,me=/^[-+]0x[0-9a-f]+$/i,fe=/^0b[01]+$/i,pe=/^\[object .+?Constructor\]$/,de=/^0o[0-7]+$/i,he=/^(?:0|[1-9]\d*)$/,ge=/[\xc0-\xd6\xd8-\xde\xdf-\xf6\xf8-\xff]/g,ve=/($^)/,be=/['\n\r\u2028\u2029\\]/g,ye="[\\ufe0e\\ufe0f]?(?:[\\u0300-\\u036f\\ufe20-\\ufe23\\u20d0-\\u20f0]|\\ud83c[\\udffb-\\udfff])?(?:\\u200d(?:[^\\ud800-\\udfff]|(?:\\ud83c[\\udde6-\\uddff]){2}|[\\ud800-\\udbff][\\udc00-\\udfff])[\\ufe0e\\ufe0f]?(?:[\\u0300-\\u036f\\ufe20-\\ufe23\\u20d0-\\u20f0]|\\ud83c[\\udffb-\\udfff])?)*",Ce="(?:[\\u2700-\\u27bf]|(?:\\ud83c[\\udde6-\\uddff]){2}|[\\ud800-\\udbff][\\udc00-\\udfff])"+ye,_e=RegExp("[\\u0300-\\u036f\\ufe20-\\ufe23\\u20d0-\\u20f0]","g"),Se=RegExp("\\ud83c[\\udffb-\\udfff](?=\\ud83c[\\udffb-\\udfff])|(?:[^\\ud800-\\udfff][\\u0300-\\u036f\\ufe20-\\ufe23\\u20d0-\\u20f0]?|[\\u0300-\\u036f\\ufe20-\\ufe23\\u20d0-\\u20f0]|(?:\\ud83c[\\udde6-\\uddff]){2}|[\\ud800-\\udbff][\\udc00-\\udfff]|[\\ud800-\\udfff])"+ye,"g"),Te=RegExp("[\\u200d\\ud800-\\udfff\\u0300-\\u036f\\ufe20-\\ufe23\\u20d0-\\u20f0\\ufe0e\\ufe0f]"),Ee=/[a-zA-Z0-9]+/g,Ae=RegExp(["[A-Z\\xc0-\\xd6\\xd8-\\xde]?[a-z\\xdf-\\xf6\\xf8-\\xff]+(?=[\\xac\\xb1\\xd7\\xf7\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf\\u2018\\u2019\\u201c\\u201d \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000]|[A-Z\\xc0-\\xd6\\xd8-\\xde]|$)|(?:[A-Z\\xc0-\\xd6\\xd8-\\xde]|[^\\ud800-\\udfff\\xac\\xb1\\xd7\\xf7\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf\\u2018\\u2019\\u201c\\u201d \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000\\d+\\u2700-\\u27bfa-z\\xdf-\\xf6\\xf8-\\xffA-Z\\xc0-\\xd6\\xd8-\\xde])+(?=[\\xac\\xb1\\xd7\\xf7\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf\\u2018\\u2019\\u201c\\u201d \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000]|[A-Z\\xc0-\\xd6\\xd8-\\xde](?:[a-z\\xdf-\\xf6\\xf8-\\xff]|[^\\ud800-\\udfff\\xac\\xb1\\xd7\\xf7\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf\\u2018\\u2019\\u201c\\u201d \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000\\d+\\u2700-\\u27bfa-z\\xdf-\\xf6\\xf8-\\xffA-Z\\xc0-\\xd6\\xd8-\\xde])|$)|[A-Z\\xc0-\\xd6\\xd8-\\xde]?(?:[a-z\\xdf-\\xf6\\xf8-\\xff]|[^\\ud800-\\udfff\\xac\\xb1\\xd7\\xf7\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf\\u2018\\u2019\\u201c\\u201d \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000\\d+\\u2700-\\u27bfa-z\\xdf-\\xf6\\xf8-\\xffA-Z\\xc0-\\xd6\\xd8-\\xde])+|[A-Z\\xc0-\\xd6\\xd8-\\xde]+|\\d+",Ce].join("|"),"g"),De=/[a-z][A-Z]|[0-9][a-zA-Z]|[a-zA-Z][0-9]|[^a-zA-Z0-9 ]/,we="Array Buffer Date Error Float32Array Float64Array Function Int8Array Int16Array Int32Array Map Math Object Reflect RegExp Set String Symbol TypeError Uint8Array Uint8ClampedArray Uint16Array Uint32Array WeakMap _ clearTimeout isFinite parseInt setTimeout".split(" "),Oe={};Oe["[object Float32Array]"]=Oe["[object Float64Array]"]=Oe["[object Int8Array]"]=Oe["[object Int16Array]"]=Oe["[object Int32Array]"]=Oe["[object Uint8Array]"]=Oe["[object Uint8ClampedArray]"]=Oe["[object Uint16Array]"]=Oe["[object Uint32Array]"]=!0,Oe["[object Arguments]"]=Oe["[object Array]"]=Oe["[object ArrayBuffer]"]=Oe["[object Boolean]"]=Oe["[object Date]"]=Oe["[object Error]"]=Oe["[object Function]"]=Oe["[object Map]"]=Oe["[object Number]"]=Oe["[object Object]"]=Oe["[object RegExp]"]=Oe["[object Set]"]=Oe["[object String]"]=Oe["[object WeakMap]"]=!1;var Ne={};Ne["[object Arguments]"]=Ne["[object Array]"]=Ne["[object ArrayBuffer]"]=Ne["[object Boolean]"]=Ne["[object Date]"]=Ne["[object Float32Array]"]=Ne["[object Float64Array]"]=Ne["[object Int8Array]"]=Ne["[object Int16Array]"]=Ne["[object Int32Array]"]=Ne["[object Map]"]=Ne["[object Number]"]=Ne["[object Object]"]=Ne["[object RegExp]"]=Ne["[object Set]"]=Ne["[object String]"]=Ne["[object Symbol]"]=Ne["[object Uint8Array]"]=Ne["[object Uint8ClampedArray]"]=Ne["[object Uint16Array]"]=Ne["[object Uint32Array]"]=!0,Ne["[object Error]"]=Ne["[object Function]"]=Ne["[object WeakMap]"]=!1;var Ie={"À":"A","Á":"A","Â":"A","Ã":"A","Ä":"A","Å":"A","à":"a","á":"a","â":"a","ã":"a","ä":"a","å":"a","Ç":"C","ç":"c","Ð":"D","ð":"d","È":"E","É":"E","Ê":"E","Ë":"E","è":"e","é":"e","ê":"e","ë":"e","Ì":"I","Í":"I","Î":"I","Ï":"I","ì":"i","í":"i","î":"i","ï":"i","Ñ":"N","ñ":"n","Ò":"O","Ó":"O","Ô":"O","Õ":"O","Ö":"O","Ø":"O","ò":"o","ó":"o","ô":"o","õ":"o","ö":"o","ø":"o","Ù":"U","Ú":"U","Û":"U","Ü":"U","ù":"u","ú":"u","û":"u","ü":"u","Ý":"Y","ý":"y","ÿ":"y","Æ":"Ae","æ":"ae","Þ":"Th","þ":"th","ß":"ss"},Ue={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","`":"&#96;"},Be={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'","&#96;":"`"},Pe={function:!0,object:!0},Me={"\\":"\\","'":"'","\n":"n","\r":"r","\u2028":"u2028","\u2029":"u2029"},Ve=parseFloat,Re=parseInt,xe=Pe[typeof exports]&&exports&&!exports.nodeType?exports:null,Le=Pe[typeof module]&&module&&!module.nodeType?module:null,Fe=D(xe&&Le&&"object"==typeof global&&global),$e=D(Pe[typeof self]&&self),ke=D(Pe[typeof window]&&window),je=Le&&Le.exports===xe?xe:null,Ge=D(Pe[typeof this]&&this),We=Fe||ke!==(Ge&&Ge.window)&&ke||$e||Ge||Function("return this")(),Ye=function D(he){function ye(e){if(ar(e)&&!Ao(e)&&!(e instanceof Ue)){if(e instanceof Ie)return e;if(qr.call(e,"__wrapped__"))return In(e)}return new Ie(e)}function Ce(){}function Ie(e,t){this.__wrapped__=e,this.__actions__=[],this.__chain__=!!t,this.__index__=0,this.__values__=$}function Ue(e){this.__wrapped__=e,this.__actions__=[],this.__dir__=1,this.__filtered__=!1,this.__iteratees__=[],this.__takeCount__=4294967295,this.__views__=[]}function Be(){}function Pe(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}function Me(e){var t=-1,n=e?e.length:0;for(this.__data__=new Pe;++t<n;)this.push(e[t])}function xe(e,t){var n=e.__data__;return Sn(t)?(n=n.__data__,"__lodash_hash_undefined__"===("string"==typeof t?n.string:n.hash)[t]):n.has(t)}function Le(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}function Fe(e,t){var n=ke(e,t);return!(0>n||(n==e.length-1?e.pop():li.call(e,n,1),0))}function $e(e,t){var n=ke(e,t);return 0>n?$:e[n][1]}function ke(e,t){for(var n=e.length;n--;)if(Zn(e[n][0],t))return n;return-1}function Ge(e,t,n){var r=ke(e,t);0>r?e.push([t,n]):e[r][1]=n}function He(e,t,n,r){return e===$||Zn(e,Yr[n])&&!qr.call(r,n)?t:e}function qe(e,t,n){(n!==$&&!Zn(e[t],n)||"number"==typeof t&&n===$&&!(t in e))&&(e[t]=n)}function ze(e,t,n){var r=e[t];(!Zn(r,n)||Zn(r,Yr[t])&&!qr.call(e,t)||n===$&&!(t in e))&&(e[t]=n)}function Ke(e,t,n,r){return Mi(e,function(e,i,o){t(r,e,n(e),o)}),r}function Ze(e,t){return e&&Wt(t,Er(t),e)}function Je(e,t){for(var n=-1,r=null==e,i=t.length,o=Array(i);++n<i;)o[n]=r?$:_r(e,t[n]);return o}function Qe(e,t,n){return e==e&&(n!==$&&(e=e>n?n:e),t!==$&&(e=t>e?t:e)),e}function Xe(e,t,n,r,o,a){var s;if(n&&(s=o?n(e,r,o,a):n(e)),s!==$)return s;if(!or(e))return e;if(r=Ao(e)){if(s=function(e){var t=e.length,n=e.constructor(t);return t&&"string"==typeof e[0]&&qr.call(e,"index")&&(n.index=e.index,n.input=e.input),n}(e),!t)return Gt(e,s)}else{var u=gn(e),c="[object Function]"==u||"[object GeneratorFunction]"==u;if(Do(e))return function(e,t){if(t)return e.slice();var n=new e.constructor(e.length);return e.copy(n),n}(e,t);if("[object Object]"!=u&&"[object Arguments]"!=u&&(!c||o))return Ne[u]?bn(e,u,t):o?e:{};if(B(e))return o?e:{};if(s=function(e){return En(e)?{}:(e=e.constructor,Pi(nr(e)?e.prototype:$))}(c?{}:e),!t)return Ht(e,Ze(s,e))}return a||(a=new Le),(o=a.get(e))?o:(a.set(e,s),(r?i:ot)(e,function(r,i){ze(s,i,Xe(r,t,n,i,e,a))}),r?s:Ht(e,s))}function et(e,t,n){if("function"!=typeof e)throw new Gr("Expected a function");return ci(function(){e.apply($,n)},t)}function tt(e,t,n,r){var i=-1,o=s,a=!0,l=e.length,m=[],f=t.length;if(!l)return m;n&&(t=c(t,S(n))),r?(o=u,a=!1):t.length>=200&&(o=xe,a=!1,t=new Me(t));e:for(;++i<l;){var p=e[i],d=n?n(p):p;if(a&&d==d){for(var h=f;h--;)if(t[h]===d)continue e;m.push(p)}else o(t,d,r)||m.push(p)}return m}function nt(e,t){var n=!0;return Mi(e,function(e,r,i){return n=!!t(e,r,i)}),n}function rt(e,t){var n=[];return Mi(e,function(e,r,i){t(e,r,i)&&n.push(e)}),n}function it(e,t,n,r){r||(r=[]);for(var i=-1,o=e.length;++i<o;){var a=e[i];er(a)&&(n||Ao(a)||Qn(a))?t?it(a,t,n,r):l(r,a):n||(r[r.length]=a)}return r}function ot(e,t){return e&&Ri(e,t,Er)}function at(e,t){return e&&xi(e,t,Er)}function st(e,t){return a(t,function(t){return nr(e[t])})}function ut(e,t){for(var n=0,r=(t=_n(t,e)?[t+""]:Mt(t)).length;null!=e&&r>n;)e=e[t[n++]];return n&&n==r?e:$}function ct(e,t){return qr.call(e,t)||"object"==typeof e&&t in e&&null===oi(e)}function lt(e,t){return t in Object(e)}function mt(e,t,n){for(var r=n?u:s,i=e.length,o=i,a=Array(i),l=[];o--;){var m=e[o];o&&t&&(m=c(m,S(t))),a[o]=n||!t&&120>m.length?$:new Me(o&&m)}var f=-1,p=(m=e[0]).length,d=a[0];e:for(;++f<p;){var h=m[f],g=t?t(h):h;if(d?!xe(d,g):!r(l,g,n)){for(o=i;--o;){var v=a[o];if(v?!xe(v,g):!r(e[o],g,n))continue e}d&&d.push(g),l.push(h)}}return l}function ft(e,t,r){return _n(t,e)||(e=Dn(e,t=Mt(t)),t=Mn(t)),null==(t=null==e?e:e[t])?$:n(t,e,r)}function pt(e,t,n,r,i){if(e===t)return!0;if(null==e||null==t||!or(e)&&!ar(t))return e!=e&&t!=t;e:{var o=Ao(e),a=Ao(t),s="[object Array]",u="[object Array]";o||("[object Arguments]"==(s=gn(e))?s="[object Object]":"[object Object]"!=s&&(o=pr(e))),a||("[object Arguments]"==(u=gn(t))?u="[object Object]":"[object Object]"!=u&&pr(t));var c="[object Object]"==s&&!B(e);if(a="[object Object]"==u&&!B(t),!(u=s==u)||o||c){if(!(2&r)&&(s=c&&qr.call(e,"__wrapped__"),a=a&&qr.call(t,"__wrapped__"),s||a)){e=pt(s?e.value():e,a?t.value():t,n,r,i);break e}u?(i||(i=new Le),e=(o?function(e,t,n,r,i,o){var a=-1,s=2&i,u=1&i,c=e.length,l=t.length;if(!(c==l||s&&l>c))return!1;if(l=o.get(e))return l==t;for(l=!0,o.set(e,t);++a<c;){var m=e[a],f=t[a];if(r)var d=s?r(f,m,a,t,e,o):r(m,f,a,e,t,o);if(d!==$){if(d)continue;l=!1;break}if(u){if(!p(t,function(e){return m===e||n(m,e,r,i,o)})){l=!1;break}}else if(m!==f&&!n(m,f,r,i,o)){l=!1;break}}return o.delete(e),l}:function(e,t,n,r,i,o){var a=2&i,s=Er(e),u=s.length,c=Er(t).length;if(u!=c&&!a)return!1;for(var l=u;l--;){var m=s[l];if(!(a?m in t:ct(t,m)))return!1}if(c=o.get(e))return c==t;c=!0,o.set(e,t);for(var f=a;++l<u;){var m=s[l],p=e[m],d=t[m];if(r)var h=a?r(d,p,m,t,e,o):r(p,d,m,e,t,o);if(h===$?p!==d&&!n(p,d,r,i,o):!h){c=!1;break}f||(f="constructor"==m)}return c&&!f&&(n=e.constructor,r=t.constructor,n!=r&&"constructor"in e&&"constructor"in t&&!("function"==typeof n&&n instanceof n&&"function"==typeof r&&r instanceof r)&&(c=!1)),o.delete(e),c})(e,t,pt,n,r,i)):e=!1}else e=function(e,t,n,r,i,o){switch(n){case"[object ArrayBuffer]":if(e.byteLength!=t.byteLength||!r(new ni(e),new ni(t)))break;return!0;case"[object Boolean]":case"[object Date]":return+e==+t;case"[object Error]":return e.name==t.name&&e.message==t.message;case"[object Number]":return e!=+e?t!=+t:e==+t;case"[object RegExp]":case"[object String]":return e==t+"";case"[object Map]":var a=V;case"[object Set]":return a||(a=x),(2&o||e.size==t.size)&&r(a(e),a(t),i,1|o);case"[object Symbol]":return!!ti&&Ii.call(e)==Ii.call(t)}return!1}(e,t,s,pt,n,r)}return e}function dt(e,t,n,r){var i=n.length,o=i,a=!r;if(null==e)return!o;for(e=Object(e);i--;){var s=n[i];if(a&&s[2]?s[1]!==e[s[0]]:!(s[0]in e))return!1}for(;++i<o;){var u=(s=n[i])[0],c=e[u],l=s[1];if(a&&s[2]){if(c===$&&!(u in e))return!1}else if(s=new Le,(u=r?r(c,l,u,e,t,s):$)===$?!pt(l,c,r,3,s):!u)return!1}return!0}function ht(e){var t=typeof e;return"function"==t?e:null==e?Pr:"object"==t?Ao(e)?yt(e[0],e[1]):bt(e):xr(e)}function gt(e){e=null==e?e:Object(e);var t,n=[];for(t in e)n.push(t);return n}function vt(e,t){var n=-1,r=Xn(e)?Array(e.length):[];return Mi(e,function(e,i,o){r[++n]=t(e,i,o)}),r}function bt(e){var t=dn(e);if(1==t.length&&t[0][2]){var n=t[0][0],r=t[0][1];return function(e){return null!=e&&e[n]===r&&(r!==$||n in Object(e))}}return function(n){return n===e||dt(n,e,t)}}function yt(e,t){return function(n){var r=_r(n,e);return r===$&&r===t?Tr(n,e):pt(t,r,$,3)}}function Ct(e,t,n,r,o){if(e!==t){var a=Ao(t)||pr(t)?$:Ar(t);i(a||t,function(i,s){if(a&&(i=t[s=i]),or(i)){o||(o=new Le);var u=s,c=o,l=e[u],m=t[u];if(!(f=c.get(m))){var f,p=(f=r?r(l,m,u+"",e,t,c):$)===$;p&&(f=m,Ao(m)||pr(m)?Ao(l)?f=n?Gt(l):l:er(l)?f=Gt(l):(p=!1,f=Xe(m)):cr(m)||Qn(m)?Qn(l)?f=yr(l):!or(l)||n&&nr(l)?(p=!1,f=Xe(m)):f=n?Xe(l):l:p=!1),c.set(m,f),p&&Ct(f,m,n,r,c)}qe(e,u,f)}else(u=r?r(e[s],i,s+"",e,t,o):$)===$&&(u=i),qe(e,s,u)})}}function _t(e,t,n){var r=-1,i=pn();return t=c(t.length?t:Array(1),function(e){return i(e)}),function(e,t){var n=e.length;for(e.sort(t);n--;)e[n]=e[n].c;return e}(e=vt(e,function(e,n,i){return{a:c(t,function(t){return t(e)}),b:++r,c:e}}),function(e,t){var r;e:{r=-1;for(var i=e.a,o=t.a,a=i.length,s=n.length;++r<a;){var u=w(i[r],o[r]);if(u){if(r>=s){r=u;break e}r=u*("desc"==n[r]?-1:1);break e}}r=e.b-t.b}return r})}function St(e,t){return e=Object(e),m(t,function(t,n){return n in e&&(t[n]=e[n]),t},{})}function Tt(e,t){var n={};return function(e,t){null==e||Ri(e,t,Ar)}(e,function(e,r){t(e,r)&&(n[r]=e)}),n}function Et(e){return function(t){return null==t?$:t[e]}}function At(e,t,n){var r=-1,i=t.length,o=e;for(n&&(o=c(e,function(e){return n(e)}));++r<i;){var a=0,s=t[r];for(s=n?n(s):s;-1<(a=v(o,s,a));)o!==e&&li.call(o,a,1),li.call(e,a,1)}return e}function Dt(e,t){for(var n=e?t.length:0,r=n-1;n--;){var i=t[n];if(r==n||i!=o){var o=i;if(P(i))li.call(e,i,1);else if(_n(i,e))delete e[i];else{var a=Dn(e,i=Mt(i));null!=a&&delete a[Mn(i)]}}}return e}function wt(e,t){return e+fi(yi()*(t-e+1))}function Ot(e,t,n,r){for(var i=-1,o=(t=_n(t,e)?[t+""]:Mt(t)).length,a=o-1,s=e;null!=s&&++i<o;){var u=t[i];if(or(s)){var c=n;if(i!=a){var l=s[u];(c=r?r(l,u,s):$)===$&&(c=null==l?P(t[i+1])?[]:{}:l)}ze(s,u,c)}s=s[u]}return e}function Nt(e,t,n){var r=-1,i=e.length;for(0>t&&(t=-t>i?0:i+t),0>(n=n>i?i:n)&&(n+=i),i=t>n?0:n-t>>>0,t>>>=0,n=Array(i);++r<i;)n[r]=e[r+t];return n}function It(e,t){var n;return Mi(e,function(e,r,i){return!(n=t(e,r,i))}),!!n}function Ut(e,t,n){var r=0,i=e?e.length:r;if("number"==typeof t&&t==t&&2147483647>=i){for(;i>r;){var o=r+i>>>1,a=e[o];(n?t>=a:t>a)&&null!==a?r=o+1:i=o}return i}return Bt(e,t,Pr,n)}function Bt(e,t,n,r){t=n(t);for(var i=0,o=e?e.length:0,a=t!=t,s=null===t,u=t===$;o>i;){var c=fi((i+o)/2),l=n(e[c]),m=l!==$,f=l==l;(a?f||r:s?f&&m&&(r||null!=l):u?f&&(r||m):null!=l&&(r?t>=l:t>l))?i=c+1:o=c}return vi(o,4294967294)}function Pt(e,t){for(var n=0,r=e.length,i=e[0],o=t?t(i):i,a=o,s=0,u=[i];++n<r;)i=e[n],Zn(o=t?t(i):i,a)||(a=o,u[++s]=i);return u}function Mt(e){return Ao(e)?e:wn(e)}function Vt(e,t,n){var r=-1,i=s,o=e.length,a=!0,c=[],l=c;if(n)a=!1,i=u;else if(o<200)l=t?[]:c;else{if(i=t?null:Fi(e))return x(i);a=!1,i=xe,l=new Me}e:for(;++r<o;){var m=e[r],f=t?t(m):m;if(a&&f==f){for(var p=l.length;p--;)if(l[p]===f)continue e;t&&l.push(f),c.push(m)}else i(l,f,n)||(l!==c&&l.push(f),c.push(m))}return c}function Rt(e,t,n,r){for(var i=e.length,o=r?i:-1;(r?o--:++o<i)&&t(e[o],o,e););return n?Nt(e,r?0:o,r?o+1:i):Nt(e,r?o+1:0,r?i:o)}function xt(e,t){var n=e;return n instanceof Ue&&(n=n.value()),m(t,function(e,t){return t.func.apply(t.thisArg,l([e],t.args))},n)}function Lt(e,t,n){for(var r=-1,i=e.length;++r<i;)var o=o?l(tt(o,e[r],t,n),tt(e[r],o,t,n)):e[r];return o&&o.length?Vt(o,t,n):[]}function Ft(e,t,n){for(var r=-1,i=e.length,o=t.length,a={};++r<i;)n(a,e[r],o>r?t[r]:$);return a}function $t(e){var t=new e.constructor(e.byteLength);return new ni(t).set(new ni(e)),t}function kt(e,t,n){for(var r=n.length,i=-1,o=gi(e.length-r,0),a=-1,s=t.length,u=Array(s+o);++a<s;)u[a]=t[a];for(;++i<r;)u[n[i]]=e[i];for(;o--;)u[a++]=e[i++];return u}function jt(e,t,n){for(var r=-1,i=n.length,o=-1,a=gi(e.length-i,0),s=-1,u=t.length,c=Array(a+u);++o<a;)c[o]=e[o];for(a=o;++s<u;)c[a+s]=t[s];for(;++r<i;)c[a+n[r]]=e[o++];return c}function Gt(e,t){var n=-1,r=e.length;for(t||(t=Array(r));++n<r;)t[n]=e[n];return t}function Wt(e,t,n){return Yt(e,t,n)}function Yt(e,t,n,r){n||(n={});for(var i=-1,o=t.length;++i<o;){var a=t[i];ze(n,a,r?r(n[a],e[a],a,n,e):e[a])}return n}function Ht(e,t){return Wt(e,ji(e),t)}function qt(e,t){return function(n,i){var o=Ao(n)?r:Ke,a=t?t():{};return o(n,e,pn(i),a)}}function zt(e){return Kn(function(t,n){var r=-1,i=n.length,o=i>1?n[i-1]:$,a=i>2?n[2]:$;for(o="function"==typeof o?(i--,o):$,a&&Cn(n[0],n[1],a)&&(o=3>i?$:o,i=1),t=Object(t);++r<i;)(a=n[r])&&e(t,a,r,o);return t})}function Kt(e,t){return function(n,r){if(null==n)return n;if(!Xn(n))return e(n,r);for(var i=n.length,o=t?i:-1,a=Object(n);(t?o--:++o<i)&&!1!==r(a[o],o,a););return n}}function Zt(e){return function(t,n,r){for(var i=-1,o=Object(t),a=(r=r(t)).length;a--;){var s=r[e?a:++i];if(!1===n(o[s],s,o))break}return t}}function Jt(e){return function(t){t=Cr(t);var n=Te.test(t)?t.match(Se):$,r=n?n[0]:t.charAt(0);return t=n?n.slice(1).join(""):t.slice(1),r[e]()+t}}function Qt(e){return function(t){return m(Ur(Nr(t)),e,"")}}function Xt(e){return function(){switch((t=arguments).length){case 0:return new e;case 1:return new e(t[0]);case 2:return new e(t[0],t[1]);case 3:return new e(t[0],t[1],t[2]);case 4:return new e(t[0],t[1],t[2],t[3]);case 5:return new e(t[0],t[1],t[2],t[3],t[4]);case 6:return new e(t[0],t[1],t[2],t[3],t[4],t[5]);case 7:return new e(t[0],t[1],t[2],t[3],t[4],t[5],t[6])}var t,n=Pi(e.prototype);return or(t=e.apply(n,t))?t:n}}function en(e,t,r){var i=Xt(e);return function o(){for(var a=arguments.length,s=a,u=Array(a),c=this&&this!==We&&this instanceof o?i:e,l=ye.placeholder||o.placeholder;s--;)u[s]=arguments[s];return a-=(s=3>a&&u[0]!==l&&u[a-1]!==l?[]:R(u,l)).length,r>a?cn(e,t,nn,l,$,u,s,$,$,r-a):n(c,this,u)}}function tn(e){return Kn(function(t){var n=(t=it(t)).length,r=n,i=Ie.prototype.thru;for(e&&t.reverse();r--;){if("function"!=typeof(a=t[r]))throw new Gr("Expected a function");if(i&&!o&&"wrapper"==fn(a))var o=new Ie([],!0)}for(r=o?r:n;++r<n;){var a,s="wrapper"==(i=fn(a=t[r]))?$i(a):$;o=s&&Tn(s[0])&&424==s[1]&&!s[4].length&&1==s[9]?o[fn(s[0])].apply(o,s[3]):1==a.length&&Tn(a)?o[i]():o.thru(a)}return function(){var e=(i=arguments)[0];if(o&&1==i.length&&Ao(e)&&e.length>=200)return o.plant(e).value();for(var r=0,i=n?t[r].apply(this,i):e;++r<n;)i=t[r].call(this,i);return i}})}function nn(e,t,n,r,i,o,a,s,u,c){var l=128&t,m=1&t,f=2&t,p=8&t,d=16&t,h=512&t,g=f?$:Xt(e);return function v(){for(var b=C=arguments.length,y=Array(C);b--;)y[b]=arguments[b];if(r&&(y=kt(y,r,i)),o&&(y=jt(y,o,a)),p||d){var C=C-(_=R(y,b=ye.placeholder||v.placeholder)).length;if(c>C)return cn(e,t,nn,b,n,y,_,s,u,c-C)}if(C=m?n:this,b=f?C[e]:e,s)for(var _=y.length,S=vi(s.length,_),T=Gt(y);S--;){var E=s[S];y[S]=P(E,_)?T[E]:$}else h&&y.length>1&&y.reverse();return l&&y.length>u&&(y.length=u),this&&this!==We&&this instanceof v&&(b=g||Xt(b)),b.apply(C,y)}}function rn(e,t){return function(n,r){return function(e,t,n,r){return ot(e,function(e,i,o){t(r,n(e),i,o)}),r}(n,e,t(r),{})}}function on(e){return Kn(function(t){return t=c(it(t),pn()),Kn(function(r){var i=this;return e(t,function(e){return n(e,i,r)})})})}function an(e,t,n){return t=gr(t),e=L(e),t&&t>e?(e=Ir(n=n===$?" ":n+"",mi((t-=e)/L(n))),Te.test(n)?e.match(Se).slice(0,t).join(""):e.slice(0,t)):""}function sn(e,t,r,i){var o=1&t,a=Xt(e);return function t(){for(var s=-1,u=arguments.length,c=-1,l=i.length,m=Array(l+u),f=this&&this!==We&&this instanceof t?a:e;++c<l;)m[c]=i[c];for(;u--;)m[c++]=arguments[++s];return n(f,o?r:this,m)}}function un(e){return function(t,n,r){r&&"number"!=typeof r&&Cn(t,n,r)&&(n=r=$),t=(t=br(t))==t?t:0,n===$?(n=t,t=0):n=br(n)||0,r=r===$?n>t?1:-1:br(r)||0;var i=-1;n=gi(mi((n-t)/(r||1)),0);for(var o=Array(n);n--;)o[e?n:++i]=t,t+=r;return o}}function cn(e,t,n,r,i,o,a,s,u,c){var l=8&t;return s=s?Gt(s):$,4&(t=(t|(l?32:64))&~(l?64:32))||(t&=-4),t=[e,t,i,l?o:$,l?a:$,o=l?$:o,a=l?$:a,s,u,c],n=n.apply($,t),Tn(e)&&Gi(n,t),n.placeholder=r,n}function ln(e){var t=kr[e];return function(e,n){if(e=br(e),n=gr(n)){var r=(Cr(e)+"e").split("e");return+((r=(Cr(r=t(r[0]+"e"+(+r[1]+n)))+"e").split("e"))[0]+"e"+(+r[1]-n))}return t(e)}}function mn(e,t,n,r,i,o,a,s){var u=2&t;if(!u&&"function"!=typeof e)throw new Gr("Expected a function");var c=r?r.length:0;if(c||(t&=-97,r=i=$),a=a===$?a:gi(gr(a),0),s=s===$?s:gr(s),c-=i?i.length:0,64&t){var l=r,m=i;r=i=$}var f=u?$:$i(e);return o=[e,t,n,r,i,l,m,o,a,s],f&&(t=(n=o[1])|(e=f[1]),r=128==e&&8==n||128==e&&256==n&&f[8]>=o[7].length||384==e&&f[8]>=f[7].length&&8==n,131>t||r)&&(1&e&&(o[2]=f[2],t|=1&n?0:4),(n=f[3])&&(r=o[3],o[3]=r?kt(r,n,f[4]):Gt(n),o[4]=r?R(o[3],"__lodash_placeholder__"):Gt(f[4])),(n=f[5])&&(r=o[5],o[5]=r?jt(r,n,f[6]):Gt(n),o[6]=r?R(o[5],"__lodash_placeholder__"):Gt(f[6])),(n=f[7])&&(o[7]=Gt(n)),128&e&&(o[8]=null==o[8]?f[8]:vi(o[8],f[8])),null==o[9]&&(o[9]=f[9]),o[0]=f[0],o[1]=t),e=o[0],t=o[1],n=o[2],r=o[3],i=o[4],!(s=o[9]=null==o[9]?u?0:e.length:gi(o[9]-c,0))&&24&t&&(t&=-25),u=t&&1!=t?8==t||16==t?en(e,t,s):32!=t&&33!=t||i.length?nn.apply($,o):sn(e,t,n,r):function(e,t,n){var r=1&t,i=Xt(e);return function t(){return(this&&this!==We&&this instanceof t?i:e).apply(r?n:this,arguments)}}(e,t,n),(f?Li:Gi)(u,o)}function fn(e){for(var t=e.name+"",n=Bi[t],r=qr.call(Bi,t)?n.length:0;r--;){var i=n[r],o=i.func;if(null==o||o==e)return i.name}return t}function pn(){var e=(e=ye.iteratee||Mr)===Mr?ht:e;return arguments.length?e(arguments[0],arguments[1]):e}function dn(e){for(var t=(e=Dr(e)).length;t--;){var n,r=e[t];n=(n=e[t][1])==n&&!or(n),r[2]=n}return e}function hn(e,t){var n=null==e?$:e[t];return sr(n)?n:$}function gn(e){return Zr.call(e)}function vn(e,t,n){if(null==e)return!1;var r=n(e,t);return r||_n(t)||null!=(e=Dn(e,t=Mt(t)))&&(r=n(e,t=Mn(t))),n=e?e.length:$,r||!!n&&ir(n)&&P(t,n)&&(Ao(e)||mr(e)||Qn(e))}function bn(n,r,i){var o=n.constructor;switch(r){case"[object ArrayBuffer]":return $t(n);case"[object Boolean]":case"[object Date]":return new o(+n);case"[object Float32Array]":case"[object Float64Array]":case"[object Int8Array]":case"[object Int16Array]":case"[object Int32Array]":case"[object Uint8Array]":case"[object Uint8ClampedArray]":case"[object Uint16Array]":case"[object Uint32Array]":return r=n.buffer,new n.constructor(i?$t(r):r,n.byteOffset,n.length);case"[object Map]":return i=n.constructor,m(V(n),e,new i);case"[object Number]":case"[object String]":return new o(n);case"[object RegExp]":return(i=new n.constructor(n.source,ce.exec(n))).lastIndex=n.lastIndex,i;case"[object Set]":return i=n.constructor,m(x(n),t,new i);case"[object Symbol]":return ti?Object(Ii.call(n)):{}}}function yn(e){var t=e?e.length:$;return ir(t)&&(Ao(e)||mr(e)||Qn(e))?C(t,String):null}function Cn(e,t,n){if(!or(n))return!1;var r=typeof t;return!!("number"==r?Xn(n)&&P(t,n.length):"string"==r&&t in n)&&Zn(n[t],e)}function _n(e,t){return"number"==typeof e||!Ao(e)&&(ee.test(e)||!X.test(e)||null!=t&&e in Object(t))}function Sn(e){var t=typeof e;return"number"==t||"boolean"==t||"string"==t&&"__proto__"!==e||null==e}function Tn(e){var t=fn(e),n=ye[t];return"function"==typeof n&&t in Ue.prototype&&(e===n||!!(t=$i(n))&&e===t[0])}function En(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||Yr)}function An(e,t,n,r,i,o){return or(e)&&or(t)&&(o.set(t,e),Ct(e,t,$,An,o)),e}function Dn(e,t){return 1==t.length?e:_r(e,Nt(t,0,-1))}function wn(e){var t=[];return Cr(e).replace(te,function(e,n,r,i){t.push(r?i.replace(se,"$1"):n||e)}),t}function On(e){return er(e)?e:[]}function Nn(e){return"function"==typeof e?e:Pr}function In(e){if(e instanceof Ue)return e.clone();var t=new Ie(e.__wrapped__,e.__chain__);return t.__actions__=Gt(e.__actions__),t.__index__=e.__index__,t.__values__=e.__values__,t}function Un(e,t,n){var r=e?e.length:0;return r?Nt(e,0>(t=n||t===$?1:gr(t))?0:t,r):[]}function Bn(e,t,n){var r=e?e.length:0;return r?Nt(e,0,0>(t=r-(t=n||t===$?1:gr(t)))?0:t):[]}function Pn(e){return e?e[0]:$}function Mn(e){var t=e?e.length:0;return t?e[t-1]:$}function Vn(e,t){return e&&e.length&&t&&t.length?At(e,t):e}function Rn(e){return e?Ci.call(e):e}function xn(e){if(!e||!e.length)return[];var t=0;return e=a(e,function(e){return er(e)?(t=gi(e.length,t),!0):void 0}),C(t,function(t){return c(e,Et(t))})}function Ln(e,t){if(!e||!e.length)return[];var r=xn(e);return null==t?r:c(r,function(e){return n(t,$,e)})}function Fn(e){return(e=ye(e)).__chain__=!0,e}function $n(e,t){return t(e)}function kn(e,t){return"function"==typeof t&&Ao(e)?i(e,t):Mi(e,Nn(t))}function jn(e,t){var n;if("function"==typeof t&&Ao(e)){for(n=e.length;n--&&!1!==t(e[n],n,e););n=e}else n=Vi(e,Nn(t));return n}function Gn(e,t){return(Ao(e)?c:vt)(e,pn(t,3))}function Wn(e,t){var n=-1,r=hr(e),i=(o=r.length)-1;for(t=Qe(gr(t),0,o);++n<t;){var o,a=r[o=wt(n,i)];r[o]=r[n],r[n]=a}return r.length=t,r}function Yn(e,t,n){return t=n?$:t,t=e&&null==t?e.length:t,mn(e,128,$,$,$,$,t)}function Hn(e,t){var n;if("function"!=typeof t)throw new Gr("Expected a function");return e=gr(e),function(){return 0<--e&&(n=t.apply(this,arguments)),1>=e&&(t=$),n}}function qn(e,t,n){function r(){p&&ri(p),c&&ri(c),h=0,u=c=f=p=d=$}function i(t,n){n&&ri(n),c=p=d=$,t&&(h=go(),l=e.apply(f,u),p||c||(u=f=$))}function o(){var e=t-(go()-m);0>=e||e>t?i(d,c):p=ci(o,e)}function a(){i(b,p)}function s(){if(u=arguments,m=go(),f=this,d=b&&(p||!g),!1===v)var n=g&&!p;else{h||c||g||(h=m);var r=v-(m-h),i=0>=r||r>v;i?(c&&(c=ri(c)),h=m,l=e.apply(f,u)):c||(c=ci(a,r))}return i&&p?p=ri(p):p||t===v||(p=ci(o,t)),n&&(i=!0,l=e.apply(f,u)),!i||p||c||(u=f=$),l}var u,c,l,m,f,p,d,h=0,g=!1,v=!1,b=!0;if("function"!=typeof e)throw new Gr("Expected a function");return t=br(t)||0,or(n)&&(g=!!n.leading,v="maxWait"in n&&gi(br(n.maxWait)||0,t),b="trailing"in n?!!n.trailing:b),s.cancel=r,s.flush=function(){return(p&&d||c&&b)&&(l=e.apply(f,u)),r(),l},s}function zn(e,t){if("function"!=typeof e||t&&"function"!=typeof t)throw new Gr("Expected a function");var n=function(){var r=arguments,i=t?t.apply(this,r):r[0],o=n.cache;return o.has(i)?o.get(i):(r=e.apply(this,r),n.cache=o.set(i,r),r)};return n.cache=new zn.Cache,n}function Kn(e,t){if("function"!=typeof e)throw new Gr("Expected a function");return t=gi(t===$?e.length-1:gr(t),0),function(){for(var r=arguments,i=-1,o=gi(r.length-t,0),a=Array(o);++i<o;)a[i]=r[t+i];switch(t){case 0:return e.call(this,a);case 1:return e.call(this,r[0],a);case 2:return e.call(this,r[0],r[1],a)}for(o=Array(t+1),i=-1;++i<t;)o[i]=r[i];return o[t]=a,n(e,this,o)}}function Zn(e,t){return e===t||e!=e&&t!=t}function Jn(e,t){return e>t}function Qn(e){return er(e)&&qr.call(e,"callee")&&(!ui.call(e,"callee")||"[object Arguments]"==Zr.call(e))}function Xn(e){return null!=e&&!("function"==typeof e&&nr(e))&&ir(ki(e))}function er(e){return ar(e)&&Xn(e)}function tr(e){return ar(e)&&"string"==typeof e.message&&"[object Error]"==Zr.call(e)}function nr(e){return"[object Function]"==(e=or(e)?Zr.call(e):"")||"[object GeneratorFunction]"==e}function rr(e){return"number"==typeof e&&e==gr(e)}function ir(e){return"number"==typeof e&&e>-1&&0==e%1&&9007199254740991>=e}function or(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function ar(e){return!!e&&"object"==typeof e}function sr(e){return null!=e&&(nr(e)?Qr.test(Hr.call(e)):ar(e)&&(B(e)?Qr:pe).test(e))}function ur(e){return"number"==typeof e||ar(e)&&"[object Number]"==Zr.call(e)}function cr(e){if(!ar(e)||"[object Object]"!=Zr.call(e)||B(e))return!1;var t=Yr;return"function"==typeof e.constructor&&(t=oi(e)),null===t||"function"==typeof(e=t.constructor)&&e instanceof e&&Hr.call(e)==Kr}function lr(e){return or(e)&&"[object RegExp]"==Zr.call(e)}function mr(e){return"string"==typeof e||!Ao(e)&&ar(e)&&"[object String]"==Zr.call(e)}function fr(e){return"symbol"==typeof e||ar(e)&&"[object Symbol]"==Zr.call(e)}function pr(e){return ar(e)&&ir(e.length)&&!!Oe[Zr.call(e)]}function dr(e,t){return t>e}function hr(e){if(!e)return[];if(Xn(e))return mr(e)?e.match(Se):Gt(e);if(si&&e[si])return M(e[si]());var t=gn(e);return("[object Map]"==t?V:"[object Set]"==t?x:wr)(e)}function gr(e){if(!e)return 0===e?e:0;if((e=br(e))===k||e===-k)return 1.7976931348623157e308*(0>e?-1:1);var t=e%1;return e==e?t?e-t:e:0}function vr(e){return e?Qe(gr(e),0,4294967295):0}function br(e){if(or(e)&&(e=or(e=nr(e.valueOf)?e.valueOf():e)?e+"":e),"string"!=typeof e)return 0===e?e:+e;e=e.replace(ie,"");var t=fe.test(e);return t||de.test(e)?Re(e.slice(2),t?2:8):me.test(e)?j:+e}function yr(e){return Wt(e,Ar(e))}function Cr(e){if("string"==typeof e)return e;if(null==e)return"";if(fr(e))return ti?Ui.call(e):"";var t=e+"";return"0"==t&&1/e==-k?"-0":t}function _r(e,t,n){return(e=null==e?$:ut(e,t))===$?n:e}function Sr(e,t){return vn(e,t,ct)}function Tr(e,t){return vn(e,t,lt)}function Er(e){var t=En(e);if(!t&&!Xn(e))return hi(Object(e));var n,r,i=!!(r=yn(e)),o=(r=r||[]).length;for(n in e)!ct(e,n)||i&&("length"==n||P(n,o))||t&&"constructor"==n||r.push(n);return r}function Ar(e){for(var t,n=-1,r=En(e),i=gt(e),o=i.length,a=!!(t=yn(e)),s=(t=t||[]).length;++n<o;){var u=i[n];a&&("length"==u||P(u,s))||"constructor"==u&&(r||!qr.call(e,u))||t.push(u)}return t}function Dr(e){return _(e,Er(e))}function wr(e){return e?T(e,Er(e)):[]}function Or(e){return Yo(Cr(e).toLowerCase())}function Nr(e){return(e=Cr(e))&&e.replace(ge,O).replace(_e,"")}function Ir(e,t){e=Cr(e),t=gr(t);var n="";if(!e||1>t||t>9007199254740991)return n;do{t%2&&(n+=e),t=fi(t/2),e+=e}while(t);return n}function Ur(e,t,n){return e=Cr(e),(t=n?$:t)===$&&(t=De.test(e)?Ae:Ee),e.match(t)||[]}function Br(e){return function(){return e}}function Pr(e){return e}function Mr(e){return ht("function"==typeof e?e:Xe(e,!0))}function Vr(e,t,n){var r=Er(t),o=st(t,r);null!=n||or(t)&&(o.length||!r.length)||(n=t,t=e,e=this,o=st(t,Er(t)));var a=!(or(n)&&"chain"in n)||n.chain,s=nr(e);return i(o,function(n){var r=t[n];e[n]=r,s&&(e.prototype[n]=function(){var t=this.__chain__;if(a||t){var n=e(this.__wrapped__);return(n.__actions__=Gt(this.__actions__)).push({func:r,args:arguments,thisArg:e}),n.__chain__=t,n}return r.apply(e,l([this.value()],arguments))})}),e}function Rr(){}function xr(e){return _n(e)?Et(e):function(e){return function(t){return ut(t,e)}}(e)}function Lr(e){return e&&e.length?y(e,Pr):0}var Fr=(he=he?Ye.defaults({},he,Ye.pick(We,we)):We).Date,$r=he.Error,kr=he.Math,jr=he.RegExp,Gr=he.TypeError,Wr=he.Array.prototype,Yr=he.Object.prototype,Hr=he.Function.prototype.toString,qr=Yr.hasOwnProperty,zr=0,Kr=Hr.call(Object),Zr=Yr.toString,Jr=We._,Qr=jr("^"+Hr.call(qr).replace(ne,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),Xr=je?he.Buffer:$,ei=he.Reflect,ti=he.Symbol,ni=he.Uint8Array,ri=he.clearTimeout,ii=ei?ei.enumerate:$,oi=Object.getPrototypeOf,ai=Object.getOwnPropertySymbols,si="symbol"==typeof(si=ti&&ti.iterator)?si:$,ui=Yr.propertyIsEnumerable,ci=he.setTimeout,li=Wr.splice,mi=kr.ceil,fi=kr.floor,pi=he.isFinite,di=Wr.join,hi=Object.keys,gi=kr.max,vi=kr.min,bi=he.parseInt,yi=kr.random,Ci=Wr.reverse,_i=hn(he,"Map"),Si=hn(he,"Set"),Ti=hn(he,"WeakMap"),Ei=hn(Object,"create"),Ai=Ti&&new Ti,Di=_i?Hr.call(_i):"",wi=Si?Hr.call(Si):"",Oi=Ti?Hr.call(Ti):"",Ni=ti?ti.prototype:$,Ii=ti?Ni.valueOf:$,Ui=ti?Ni.toString:$,Bi={};ye.templateSettings={escape:Z,evaluate:J,interpolate:Q,variable:"",imports:{_:ye}};var Pi=function(){function e(){}return function(t){if(or(t)){e.prototype=t;var n=new e;e.prototype=$}return n||{}}}(),Mi=Kt(ot),Vi=Kt(at,!0),Ri=Zt(),xi=Zt(!0);ii&&!ui.call({valueOf:1},"valueOf")&&(gt=function(e){return M(ii(e))});var Li=Ai?function(e,t){return Ai.set(e,t),e}:Pr,Fi=Si&&2===new Si([1,2]).size?function(e){return new Si(e)}:Rr,$i=Ai?function(e){return Ai.get(e)}:Rr,ki=Et("length"),ji=ai||function(){return[]};(_i&&"[object Map]"!=gn(new _i)||Si&&"[object Set]"!=gn(new Si)||Ti&&"[object WeakMap]"!=gn(new Ti))&&(gn=function(e){var t=Zr.call(e);if(e="function"==typeof(e="[object Object]"==t?e.constructor:null)?Hr.call(e):"")switch(e){case Di:return"[object Map]";case wi:return"[object Set]";case Oi:return"[object WeakMap]"}return t});var Gi=function(){var e=0,t=0;return function(n,r){var i=go(),o=16-(i-t);if(t=i,o>0){if(150<=++e)return n}else e=0;return Li(n,r)}}(),Wi=Kn(function(e,t){Ao(e)||(e=null==e?[]:[Object(e)]);for(var n=e,r=t=it(t),i=-1,o=n.length,a=-1,s=r.length,u=Array(o+s);++i<o;)u[i]=n[i];for(;++a<s;)u[i++]=r[a];return u}),Yi=Kn(function(e,t){return er(e)?tt(e,it(t,!1,!0)):[]}),Hi=Kn(function(e,t){var n=Mn(t);return er(n)&&(n=$),er(e)?tt(e,it(t,!1,!0),pn(n)):[]}),qi=Kn(function(e,t){var n=Mn(t);return er(n)&&(n=$),er(e)?tt(e,it(t,!1,!0),$,n):[]}),zi=Kn(function(e){var t=c(e,On);return t.length&&t[0]===e[0]?mt(t):[]}),Ki=Kn(function(e){var t=Mn(e),n=c(e,On);return t===Mn(n)?t=$:n.pop(),n.length&&n[0]===e[0]?mt(n,pn(t)):[]}),Zi=Kn(function(e){var t=Mn(e),n=c(e,On);return t===Mn(n)?t=$:n.pop(),n.length&&n[0]===e[0]?mt(n,$,t):[]}),Ji=Kn(Vn),Qi=Kn(function(e,t){var n=Je(e,t=c(it(t),String));return Dt(e,t.sort(w)),n}),Xi=Kn(function(e){return Vt(it(e,!1,!0))}),eo=Kn(function(e){var t=Mn(e);return er(t)&&(t=$),Vt(it(e,!1,!0),pn(t))}),to=Kn(function(e){var t=Mn(e);return er(t)&&(t=$),Vt(it(e,!1,!0),$,t)}),no=Kn(function(e,t){return er(e)?tt(e,t):[]}),ro=Kn(function(e){return Lt(a(e,er))}),io=Kn(function(e){var t=Mn(e);return er(t)&&(t=$),Lt(a(e,er),pn(t))}),oo=Kn(function(e){var t=Mn(e);return er(t)&&(t=$),Lt(a(e,er),$,t)}),ao=Kn(xn),so=Kn(function(e){var t="function"==typeof(t=(t=e.length)>1?e[t-1]:$)?(e.pop(),t):$;return Ln(e,t)}),uo=Kn(function(e){var t=(e=it(e)).length,n=t?e[0]:0,r=this.__wrapped__,i=function(t){return Je(t,e)};return 1>=t&&!this.__actions__.length&&r instanceof Ue&&P(n)?((r=r.slice(n,+n+(t?1:0))).__actions__.push({func:$n,args:[i],thisArg:$}),new Ie(r,this.__chain__).thru(function(e){return t&&!e.length&&e.push($),e})):this.thru(i)}),co=qt(function(e,t,n){qr.call(e,n)?++e[n]:e[n]=1}),lo=qt(function(e,t,n){qr.call(e,n)?e[n].push(t):e[n]=[t]}),mo=Kn(function(e,t,r){var i=-1,o="function"==typeof t,a=_n(t),s=Xn(e)?Array(e.length):[];return Mi(e,function(e){var u=o?t:a&&null!=e?e[t]:$;s[++i]=u?n(u,e,r):ft(e,t,r)}),s}),fo=qt(function(e,t,n){e[n]=t}),po=qt(function(e,t,n){e[n?0:1].push(t)},function(){return[[],[]]}),ho=Kn(function(e,t){if(null==e)return[];var n=t.length;return n>1&&Cn(e,t[0],t[1])?t=[]:n>2&&Cn(t[0],t[1],t[2])&&(t.length=1),_t(e,it(t),[])}),go=Fr.now,vo=Kn(function(e,t,n){var r=1;if(n.length){var i=R(n,ye.placeholder||vo.placeholder);r|=32}return mn(e,r,t,n,i)}),bo=Kn(function(e,t,n){var r=3;if(n.length){var i=R(n,ye.placeholder||bo.placeholder);r|=32}return mn(t,r,e,n,i)}),yo=Kn(function(e,t){return et(e,1,t)}),Co=Kn(function(e,t,n){return et(e,br(t)||0,n)}),_o=Kn(function(e,t){var r=(t=c(it(t),pn())).length;return Kn(function(i){for(var o=-1,a=vi(i.length,r);++o<a;)i[o]=t[o].call(this,i[o]);return n(e,this,i)})}),So=Kn(function(e,t){var n=R(t,ye.placeholder||So.placeholder);return mn(e,32,$,t,n)}),To=Kn(function(e,t){var n=R(t,ye.placeholder||To.placeholder);return mn(e,64,$,t,n)}),Eo=Kn(function(e,t){return mn(e,256,$,$,$,it(t))}),Ao=Array.isArray,Do=Xr?function(e){return e instanceof Xr}:Br(!1),wo=zt(function(e,t){Wt(t,Er(t),e)}),Oo=zt(function(e,t){Wt(t,Ar(t),e)}),No=zt(function(e,t,n,r){Yt(t,Ar(t),e,r)}),Io=zt(function(e,t,n,r){Yt(t,Er(t),e,r)}),Uo=Kn(function(e,t){return Je(e,it(t))}),Bo=Kn(function(e){return e.push($,He),n(No,$,e)}),Po=Kn(function(e){return e.push($,An),n(Lo,$,e)}),Mo=rn(function(e,t,n){e[t]=n},Br(Pr)),Vo=rn(function(e,t,n){qr.call(e,t)?e[t].push(n):e[t]=[n]},pn),Ro=Kn(ft),xo=zt(function(e,t,n){Ct(e,t,n)}),Lo=zt(function(e,t,n,r){Ct(e,t,n,r)}),Fo=Kn(function(e,t){return null==e?{}:(t=c(it(t),String),St(e,tt(Ar(e),t)))}),$o=Kn(function(e,t){return null==e?{}:St(e,it(t))}),ko=Qt(function(e,t,n){return t=t.toLowerCase(),e+(n?Or(t):t)}),jo=Qt(function(e,t,n){return e+(n?"-":"")+t.toLowerCase()}),Go=Qt(function(e,t,n){return e+(n?" ":"")+t.toLowerCase()}),Wo=Jt("toLowerCase"),Yo=Jt("toUpperCase"),Ho=Qt(function(e,t,n){return e+(n?"_":"")+t.toLowerCase()}),qo=Qt(function(e,t,n){return e+(n?" ":"")+Or(t)}),zo=Qt(function(e,t,n){return e+(n?" ":"")+t.toUpperCase()}),Ko=Kn(function(e,t){try{return n(e,$,t)}catch(e){return or(e)?e:new $r(e)}}),Zo=Kn(function(e,t){return i(it(t),function(t){e[t]=vo(e[t],e)}),e}),Jo=tn(),Qo=tn(!0),Xo=Kn(function(e,t){return function(n){return ft(n,e,t)}}),ea=Kn(function(e,t){return function(n){return ft(e,n,t)}}),ta=on(c),na=on(o),ra=on(p),ia=un(),oa=un(!0),aa=ln("ceil"),sa=ln("floor"),ua=ln("round");return ye.prototype=Ce.prototype,Ie.prototype=Pi(Ce.prototype),Ie.prototype.constructor=Ie,Ue.prototype=Pi(Ce.prototype),Ue.prototype.constructor=Ue,Be.prototype=Ei?Ei(null):Yr,Pe.prototype.clear=function(){this.__data__={hash:new Be,map:_i?new _i:[],string:new Be}},Pe.prototype.delete=function(e){var t=this.__data__;return Sn(e)?(t="string"==typeof e?t.string:t.hash,(Ei?t[e]!==$:qr.call(t,e))&&delete t[e]):_i?t.map.delete(e):Fe(t.map,e)},Pe.prototype.get=function(e){var t=this.__data__;return Sn(e)?(t="string"==typeof e?t.string:t.hash,e=Ei?"__lodash_hash_undefined__"===(e=t[e])?$:e:qr.call(t,e)?t[e]:$):_i?t.map.get(e):$e(t.map,e)},Pe.prototype.has=function(e){var t=this.__data__;return Sn(e)?(t="string"==typeof e?t.string:t.hash,e=Ei?t[e]!==$:qr.call(t,e)):e=_i?t.map.has(e):-1<ke(t.map,e),e},Pe.prototype.set=function(e,t){var n=this.__data__;return Sn(e)?("string"==typeof e?n.string:n.hash)[e]=Ei&&t===$?"__lodash_hash_undefined__":t:_i?n.map.set(e,t):Ge(n.map,e,t),this},Me.prototype.push=function(e){var t=this.__data__;Sn(e)?(t=t.__data__,("string"==typeof e?t.string:t.hash)[e]="__lodash_hash_undefined__"):t.set(e,"__lodash_hash_undefined__")},Le.prototype.clear=function(){this.__data__={array:[],map:null}},Le.prototype.delete=function(e){var t=this.__data__,n=t.array;return n?Fe(n,e):t.map.delete(e)},Le.prototype.get=function(e){var t=this.__data__,n=t.array;return n?$e(n,e):t.map.get(e)},Le.prototype.has=function(e){var t=this.__data__,n=t.array;return n?-1<ke(n,e):t.map.has(e)},Le.prototype.set=function(e,t){var n=this.__data__,r=n.array;return r&&(199>r.length?Ge(r,e,t):(n.array=null,n.map=new Pe(r))),(n=n.map)&&n.set(e,t),this},zn.Cache=Pe,ye.after=function(e,t){if("function"!=typeof t)throw new Gr("Expected a function");return e=gr(e),function(){return 1>--e?t.apply(this,arguments):void 0}},ye.ary=Yn,ye.assign=wo,ye.assignIn=Oo,ye.assignInWith=No,ye.assignWith=Io,ye.at=Uo,ye.before=Hn,ye.bind=vo,ye.bindAll=Zo,ye.bindKey=bo,ye.chain=Fn,ye.chunk=function(e,t){t=gi(gr(t),0);var n=e?e.length:0;if(!n||1>t)return[];for(var r=0,i=-1,o=Array(mi(n/t));n>r;)o[++i]=Nt(e,r,r+=t);return o},ye.compact=function(e){for(var t=-1,n=e?e.length:0,r=-1,i=[];++t<n;){var o=e[t];o&&(i[++r]=o)}return i},ye.concat=Wi,ye.cond=function(e){var t=e?e.length:0,r=pn();return e=t?c(e,function(e){if("function"!=typeof e[1])throw new Gr("Expected a function");return[r(e[0]),e[1]]}):[],Kn(function(r){for(var i=-1;++i<t;){var o=e[i];if(n(o[0],this,r))return n(o[1],this,r)}})},ye.conforms=function(e){return function(e){var t=Er(e),n=t.length;return function(r){if(null==r)return!n;for(var i=n;i--;){var o=t[i],a=e[o],s=r[o];if(s===$&&!(o in Object(r))||!a(s))return!1}return!0}}(Xe(e,!0))},ye.constant=Br,ye.countBy=co,ye.create=function(e,t){var n=Pi(e);return t?Ze(n,t):n},ye.curry=function e(t,n,r){return(t=mn(t,8,$,$,$,$,$,n=r?$:n)).placeholder=ye.placeholder||e.placeholder,t},ye.curryRight=function e(t,n,r){return(t=mn(t,16,$,$,$,$,$,n=r?$:n)).placeholder=ye.placeholder||e.placeholder,t},ye.debounce=qn,ye.defaults=Bo,ye.defaultsDeep=Po,ye.defer=yo,ye.delay=Co,ye.difference=Yi,ye.differenceBy=Hi,ye.differenceWith=qi,ye.drop=Un,ye.dropRight=Bn,ye.dropRightWhile=function(e,t){return e&&e.length?Rt(e,pn(t,3),!0,!0):[]},ye.dropWhile=function(e,t){return e&&e.length?Rt(e,pn(t,3),!0):[]},ye.fill=function(e,t,n,r){var i=e?e.length:0;if(!i)return[];for(n&&"number"!=typeof n&&Cn(e,t,n)&&(n=0,r=i),i=e.length,0>(n=gr(n))&&(n=-n>i?0:i+n),0>(r=r===$||r>i?i:gr(r))&&(r+=i),r=n>r?0:vr(r);r>n;)e[n++]=t;return e},ye.filter=function(e,t){return(Ao(e)?a:rt)(e,pn(t,3))},ye.flatMap=function(e,t){return it(Gn(e,t))},ye.flatten=function(e){return e&&e.length?it(e):[]},ye.flattenDeep=function(e){return e&&e.length?it(e,!0):[]},ye.flip=function(e){return mn(e,512)},ye.flow=Jo,ye.flowRight=Qo,ye.fromPairs=function(e){for(var t=-1,n=e?e.length:0,r={};++t<n;){var i=e[t];r[i[0]]=i[1]}return r},ye.functions=function(e){return null==e?[]:st(e,Er(e))},ye.functionsIn=function(e){return null==e?[]:st(e,Ar(e))},ye.groupBy=lo,ye.initial=function(e){return Bn(e,1)},ye.intersection=zi,ye.intersectionBy=Ki,ye.intersectionWith=Zi,ye.invert=Mo,ye.invertBy=Vo,ye.invokeMap=mo,ye.iteratee=Mr,ye.keyBy=fo,ye.keys=Er,ye.keysIn=Ar,ye.map=Gn,ye.mapKeys=function(e,t){var n={};return t=pn(t,3),ot(e,function(e,r,i){n[t(e,r,i)]=e}),n},ye.mapValues=function(e,t){var n={};return t=pn(t,3),ot(e,function(e,r,i){n[r]=t(e,r,i)}),n},ye.matches=function(e){return bt(Xe(e,!0))},ye.matchesProperty=function(e,t){return yt(e,Xe(t,!0))},ye.memoize=zn,ye.merge=xo,ye.mergeWith=Lo,ye.method=Xo,ye.methodOf=ea,ye.mixin=Vr,ye.negate=function(e){if("function"!=typeof e)throw new Gr("Expected a function");return function(){return!e.apply(this,arguments)}},ye.nthArg=function(e){return e=gr(e),function(){return arguments[e]}},ye.omit=Fo,ye.omitBy=function(e,t){return t=pn(t,2),Tt(e,function(e,n){return!t(e,n)})},ye.once=function(e){return Hn(2,e)},ye.orderBy=function(e,t,n,r){return null==e?[]:(Ao(t)||(t=null==t?[]:[t]),Ao(n=r?$:n)||(n=null==n?[]:[n]),_t(e,t,n))},ye.over=ta,ye.overArgs=_o,ye.overEvery=na,ye.overSome=ra,ye.partial=So,ye.partialRight=To,ye.partition=po,ye.pick=$o,ye.pickBy=function(e,t){return null==e?{}:Tt(e,pn(t,2))},ye.property=xr,ye.propertyOf=function(e){return function(t){return null==e?$:ut(e,t)}},ye.pull=Ji,ye.pullAll=Vn,ye.pullAllBy=function(e,t,n){return e&&e.length&&t&&t.length?At(e,t,pn(n)):e},ye.pullAt=Qi,ye.range=ia,ye.rangeRight=oa,ye.rearg=Eo,ye.reject=function(e,t){var n=Ao(e)?a:rt;return t=pn(t,3),n(e,function(e,n,r){return!t(e,n,r)})},ye.remove=function(e,t){var n=[];if(!e||!e.length)return n;var r=-1,i=[],o=e.length;for(t=pn(t,3);++r<o;){var a=e[r];t(a,r,e)&&(n.push(a),i.push(r))}return Dt(e,i),n},ye.rest=Kn,ye.reverse=Rn,ye.sampleSize=Wn,ye.set=function(e,t,n){return null==e?e:Ot(e,t,n)},ye.setWith=function(e,t,n,r){return r="function"==typeof r?r:$,null==e?e:Ot(e,t,n,r)},ye.shuffle=function(e){return Wn(e,4294967295)},ye.slice=function(e,t,n){var r=e?e.length:0;return r?(n&&"number"!=typeof n&&Cn(e,t,n)?(t=0,n=r):(t=null==t?0:gr(t),n=n===$?r:gr(n)),Nt(e,t,n)):[]},ye.sortBy=ho,ye.sortedUniq=function(e){return e&&e.length?Pt(e):[]},ye.sortedUniqBy=function(e,t){return e&&e.length?Pt(e,pn(t)):[]},ye.split=function(e,t,n){return Cr(e).split(t,n)},ye.spread=function(e,t){if("function"!=typeof e)throw new Gr("Expected a function");return t=t===$?0:gi(gr(t),0),Kn(function(r){var i=r[t];return r=r.slice(0,t),i&&l(r,i),n(e,this,r)})},ye.tail=function(e){return Un(e,1)},ye.take=function(e,t,n){return e&&e.length?Nt(e,0,0>(t=n||t===$?1:gr(t))?0:t):[]},ye.takeRight=function(e,t,n){var r=e?e.length:0;return r?Nt(e,0>(t=r-(t=n||t===$?1:gr(t)))?0:t,r):[]},ye.takeRightWhile=function(e,t){return e&&e.length?Rt(e,pn(t,3),!1,!0):[]},ye.takeWhile=function(e,t){return e&&e.length?Rt(e,pn(t,3)):[]},ye.tap=function(e,t){return t(e),e},ye.throttle=function(e,t,n){var r=!0,i=!0;if("function"!=typeof e)throw new Gr("Expected a function");return or(n)&&(r="leading"in n?!!n.leading:r,i="trailing"in n?!!n.trailing:i),qn(e,t,{leading:r,maxWait:t,trailing:i})},ye.thru=$n,ye.toArray=hr,ye.toPairs=Dr,ye.toPairsIn=function(e){return _(e,Ar(e))},ye.toPath=function(e){return Ao(e)?c(e,String):wn(e)},ye.toPlainObject=yr,ye.transform=function(e,t,n){var r=Ao(e)||pr(e);if(t=pn(t,4),null==n)if(r||or(e)){var o=e.constructor;n=r?Ao(e)?new o:[]:Pi(nr(o)?o.prototype:$)}else n={};return(r?i:ot)(e,function(e,r,i){return t(n,e,r,i)}),n},ye.unary=function(e){return Yn(e,1)},ye.union=Xi,ye.unionBy=eo,ye.unionWith=to,ye.uniq=function(e){return e&&e.length?Vt(e):[]},ye.uniqBy=function(e,t){return e&&e.length?Vt(e,pn(t)):[]},ye.uniqWith=function(e,t){return e&&e.length?Vt(e,$,t):[]},ye.unset=function(e,t){var n,r;return null==e?n=!0:(n=Dn(n=e,r=_n(r=t,n)?[r+""]:Mt(r)),r=Mn(r),n=null==n||!Sr(n,r)||delete n[r]),n},ye.unzip=xn,ye.unzipWith=Ln,ye.values=wr,ye.valuesIn=function(e){return null==e?T(e,Ar(e)):[]},ye.without=no,ye.words=Ur,ye.wrap=function(e,t){return So(t=null==t?Pr:t,e)},ye.xor=ro,ye.xorBy=io,ye.xorWith=oo,ye.zip=ao,ye.zipObject=function(e,t){return Ft(e||[],t||[],ze)},ye.zipObjectDeep=function(e,t){return Ft(e||[],t||[],Ot)},ye.zipWith=so,ye.extend=Oo,ye.extendWith=No,Vr(ye,ye),ye.add=function(e,t){var n;return e===$&&t===$?0:(e!==$&&(n=e),t!==$&&(n=n===$?t:n+t),n)},ye.attempt=Ko,ye.camelCase=ko,ye.capitalize=Or,ye.ceil=aa,ye.clamp=function(e,t,n){return n===$&&(n=t,t=$),n!==$&&(n=(n=br(n))==n?n:0),t!==$&&(t=(t=br(t))==t?t:0),Qe(br(e),t,n)},ye.clone=function(e){return Xe(e)},ye.cloneDeep=function(e){return Xe(e,!0)},ye.cloneDeepWith=function(e,t){return Xe(e,!0,t)},ye.cloneWith=function(e,t){return Xe(e,!1,t)},ye.deburr=Nr,ye.endsWith=function(e,t,n){t="string"==typeof t?t:t+"";var r=(e=Cr(e)).length;return n=n===$?r:Qe(gr(n),0,r),(n-=t.length)>=0&&e.indexOf(t,n)==n},ye.eq=Zn,ye.escape=function(e){return(e=Cr(e))&&K.test(e)?e.replace(q,N):e},ye.escapeRegExp=function(e){return(e=Cr(e))&&re.test(e)?e.replace(ne,"\\$&"):e},ye.every=function(e,t,n){var r=Ao(e)?o:nt;return n&&Cn(e,t,n)&&(t=$),r(e,pn(t,3))},ye.find=function(e,t){if(t=pn(t,3),Ao(e)){var n=g(e,t);return n>-1?e[n]:$}return h(e,t,Mi)},ye.findIndex=function(e,t){return e&&e.length?g(e,pn(t,3)):-1},ye.findKey=function(e,t){return h(e,pn(t,3),ot,!0)},ye.findLast=function(e,t){if(t=pn(t,3),Ao(e)){var n=g(e,t,!0);return n>-1?e[n]:$}return h(e,t,Vi)},ye.findLastIndex=function(e,t){return e&&e.length?g(e,pn(t,3),!0):-1},ye.findLastKey=function(e,t){return h(e,pn(t,3),at,!0)},ye.floor=sa,ye.forEach=kn,ye.forEachRight=jn,ye.forIn=function(e,t){return null==e?e:Ri(e,Nn(t),Ar)},ye.forInRight=function(e,t){return null==e?e:xi(e,Nn(t),Ar)},ye.forOwn=function(e,t){return e&&ot(e,Nn(t))},ye.forOwnRight=function(e,t){return e&&at(e,Nn(t))},ye.get=_r,ye.gt=Jn,ye.gte=function(e,t){return e>=t},ye.has=Sr,ye.hasIn=Tr,ye.head=Pn,ye.identity=Pr,ye.includes=function(e,t,n,r){return e=Xn(e)?e:wr(e),n=n&&!r?gr(n):0,r=e.length,0>n&&(n=gi(r+n,0)),mr(e)?r>=n&&-1<e.indexOf(t,n):!!r&&-1<v(e,t,n)},ye.indexOf=function(e,t,n){var r=e?e.length:0;return r?(0>(n=gr(n))&&(n=gi(r+n,0)),v(e,t,n)):-1},ye.inRange=function(e,t,n){return t=br(t)||0,n===$?(n=t,t=0):n=br(n)||0,(e=br(e))>=vi(t,n)&&e<gi(t,n)},ye.invoke=Ro,ye.isArguments=Qn,ye.isArray=Ao,ye.isArrayBuffer=function(e){return ar(e)&&"[object ArrayBuffer]"==Zr.call(e)},ye.isArrayLike=Xn,ye.isArrayLikeObject=er,ye.isBoolean=function(e){return!0===e||!1===e||ar(e)&&"[object Boolean]"==Zr.call(e)},ye.isBuffer=Do,ye.isDate=function(e){return ar(e)&&"[object Date]"==Zr.call(e)},ye.isElement=function(e){return!!e&&1===e.nodeType&&ar(e)&&!cr(e)},ye.isEmpty=function(e){if(Xn(e)&&(Ao(e)||mr(e)||nr(e.splice)||Qn(e)))return!e.length;for(var t in e)if(qr.call(e,t))return!1;return!0},ye.isEqual=function(e,t){return pt(e,t)},ye.isEqualWith=function(e,t,n){var r=(n="function"==typeof n?n:$)?n(e,t):$;return r===$?pt(e,t,n):!!r},ye.isError=tr,ye.isFinite=function(e){return"number"==typeof e&&pi(e)},ye.isFunction=nr,ye.isInteger=rr,ye.isLength=ir,ye.isMap=function(e){return ar(e)&&"[object Map]"==gn(e)},ye.isMatch=function(e,t){return e===t||dt(e,t,dn(t))},ye.isMatchWith=function(e,t,n){return n="function"==typeof n?n:$,dt(e,t,dn(t),n)},ye.isNaN=function(e){return ur(e)&&e!=+e},ye.isNative=sr,ye.isNil=function(e){return null==e},ye.isNull=function(e){return null===e},ye.isNumber=ur,ye.isObject=or,ye.isObjectLike=ar,ye.isPlainObject=cr,ye.isRegExp=lr,ye.isSafeInteger=function(e){return rr(e)&&e>=-9007199254740991&&9007199254740991>=e},ye.isSet=function(e){return ar(e)&&"[object Set]"==gn(e)},ye.isString=mr,ye.isSymbol=fr,ye.isTypedArray=pr,ye.isUndefined=function(e){return e===$},ye.isWeakMap=function(e){return ar(e)&&"[object WeakMap]"==gn(e)},ye.isWeakSet=function(e){return ar(e)&&"[object WeakSet]"==Zr.call(e)},ye.join=function(e,t){return e?di.call(e,t):""},ye.kebabCase=jo,ye.last=Mn,ye.lastIndexOf=function(e,t,n){var r=e?e.length:0;if(!r)return-1;var i=r;if(n!==$&&(i=(0>(i=gr(n))?gi(r+i,0):vi(i,r-1))+1),t!=t)return U(e,i,!0);for(;i--;)if(e[i]===t)return i;return-1},ye.lowerCase=Go,ye.lowerFirst=Wo,ye.lt=dr,ye.lte=function(e,t){return t>=e},ye.max=function(e){return e&&e.length?d(e,Pr,Jn):$},ye.maxBy=function(e,t){return e&&e.length?d(e,pn(t),Jn):$},ye.mean=function(e){return Lr(e)/(e?e.length:0)},ye.min=function(e){return e&&e.length?d(e,Pr,dr):$},ye.minBy=function(e,t){return e&&e.length?d(e,pn(t),dr):$},ye.noConflict=function(){return We._===this&&(We._=Jr),this},ye.noop=Rr,ye.now=go,ye.pad=function(e,t,n){e=Cr(e),t=gr(t);var r=L(e);return t&&t>r?(t=fi(r=(t-r)/2),r=mi(r),an("",t,n)+e+an("",r,n)):e},ye.padEnd=function(e,t,n){return(e=Cr(e))+an(e,t,n)},ye.padStart=function(e,t,n){return an(e=Cr(e),t,n)+e},ye.parseInt=function(e,t,n){return n||null==t?t=0:t&&(t=+t),e=Cr(e).replace(ie,""),bi(e,t||(le.test(e)?16:10))},ye.random=function(e,t,n){if(n&&"boolean"!=typeof n&&Cn(e,t,n)&&(t=n=$),n===$&&("boolean"==typeof t?(n=t,t=$):"boolean"==typeof e&&(n=e,e=$)),e===$&&t===$?(e=0,t=1):(e=br(e)||0,t===$?(t=e,e=0):t=br(t)||0),e>t){var r=e;e=t,t=r}return n||e%1||t%1?(n=yi(),vi(e+n*(t-e+Ve("1e-"+((n+"").length-1))),t)):wt(e,t)},ye.reduce=function(e,t,n){var r=Ao(e)?m:b,i=3>arguments.length;return r(e,pn(t,4),n,i,Mi)},ye.reduceRight=function(e,t,n){var r=Ao(e)?f:b,i=3>arguments.length;return r(e,pn(t,4),n,i,Vi)},ye.repeat=Ir,ye.replace=function(){var e=arguments,t=Cr(e[0]);return 3>e.length?t:t.replace(e[1],e[2])},ye.result=function(e,t,n){if(_n(t,e))r=null==e?$:e[t];else{var r=_r(e,t=Mt(t));e=Dn(e,t)}return r===$&&(r=n),nr(r)?r.call(e):r},ye.round=ua,ye.runInContext=D,ye.sample=function(e){var t=(e=Xn(e)?e:wr(e)).length;return t>0?e[wt(0,t-1)]:$},ye.size=function(e){if(null==e)return 0;if(Xn(e)){var t=e.length;return t&&mr(e)?L(e):t}return Er(e).length},ye.snakeCase=Ho,ye.some=function(e,t,n){var r=Ao(e)?p:It;return n&&Cn(e,t,n)&&(t=$),r(e,pn(t,3))},ye.sortedIndex=function(e,t){return Ut(e,t)},ye.sortedIndexBy=function(e,t,n){return Bt(e,t,pn(n))},ye.sortedIndexOf=function(e,t){var n=e?e.length:0;if(n){var r=Ut(e,t);if(n>r&&Zn(e[r],t))return r}return-1},ye.sortedLastIndex=function(e,t){return Ut(e,t,!0)},ye.sortedLastIndexBy=function(e,t,n){return Bt(e,t,pn(n),!0)},ye.sortedLastIndexOf=function(e,t){if(e&&e.length){var n=Ut(e,t,!0)-1;if(Zn(e[n],t))return n}return-1},ye.startCase=qo,ye.startsWith=function(e,t,n){return e=Cr(e),n=Qe(gr(n),0,e.length),e.lastIndexOf(t,n)==n},ye.subtract=function(e,t){var n;return e===$&&t===$?0:(e!==$&&(n=e),t!==$&&(n=n===$?t:n-t),n)},ye.sum=Lr,ye.sumBy=function(e,t){return e&&e.length?y(e,pn(t)):0},ye.template=function(e,t,n){var r=ye.templateSettings;n&&Cn(e,t,n)&&(t=$),e=Cr(e),t=No({},t,r,He);var i,o,a=Er(n=No({},t.imports,r.imports,He)),s=T(n,a),u=0;n=t.interpolate||ve;var c="__p+='";n=jr((t.escape||ve).source+"|"+n.source+"|"+(n===Q?ue:ve).source+"|"+(t.evaluate||ve).source+"|$","g");var l="sourceURL"in t?"//# sourceURL="+t.sourceURL+"\n":"";if(e.replace(n,function(t,n,r,a,s,l){return r||(r=a),c+=e.slice(u,l).replace(be,I),n&&(i=!0,c+="'+__e("+n+")+'"),s&&(o=!0,c+="';"+s+";\n__p+='"),r&&(c+="'+((__t=("+r+"))==null?'':__t)+'"),u=l+t.length,t}),c+="';",(t=t.variable)||(c="with(obj){"+c+"}"),c=(o?c.replace(G,""):c).replace(W,"$1").replace(Y,"$1;"),c="function("+(t||"obj")+"){"+(t?"":"obj||(obj={});")+"var __t,__p=''"+(i?",__e=_.escape":"")+(o?",__j=Array.prototype.join;function print(){__p+=__j.call(arguments,'')}":";")+c+"return __p}",(t=Ko(function(){return Function(a,l+"return "+c).apply($,s)})).source=c,tr(t))throw t;return t},ye.times=function(e,t){if(1>(e=gr(e))||e>9007199254740991)return[];var n=4294967295,r=vi(e,4294967295);for(e-=4294967295,r=C(r,t=Nn(t));++n<e;)t(n);return r},ye.toInteger=gr,ye.toLength=vr,ye.toLower=function(e){return Cr(e).toLowerCase()},ye.toNumber=br,ye.toSafeInteger=function(e){return Qe(gr(e),-9007199254740991,9007199254740991)},ye.toString=Cr,ye.toUpper=function(e){return Cr(e).toUpperCase()},ye.trim=function(e,t,n){return(e=Cr(e))?n||t===$?e.replace(ie,""):(t+="")?(e=e.match(Se),t=t.match(Se),e.slice(E(e,t),A(e,t)+1).join("")):e:e},ye.trimEnd=function(e,t,n){return(e=Cr(e))?n||t===$?e.replace(ae,""):(t+="")?(e=e.match(Se)).slice(0,A(e,t.match(Se))+1).join(""):e:e},ye.trimStart=function(e,t,n){return(e=Cr(e))?n||t===$?e.replace(oe,""):(t+="")?(e=e.match(Se)).slice(E(e,t.match(Se))).join(""):e:e},ye.truncate=function(e,t){var n=30,r="...";if(or(t)){var i="separator"in t?t.separator:i;n="length"in t?gr(t.length):n,r="omission"in t?Cr(t.omission):r}var o=(e=Cr(e)).length;if(Te.test(e)){var a=e.match(Se);o=a.length}if(n>=o)return e;if(1>(o=n-L(r)))return r;if(n=a?a.slice(0,o).join(""):e.slice(0,o),i===$)return n+r;if(a&&(o+=n.length-o),lr(i)){if(e.slice(o).search(i)){var s=n;for(i.global||(i=jr(i.source,Cr(ce.exec(i))+"g")),i.lastIndex=0;a=i.exec(s);)var u=a.index;n=n.slice(0,u===$?o:u)}}else e.indexOf(i,o)!=o&&(i=n.lastIndexOf(i))>-1&&(n=n.slice(0,i));return n+r},ye.unescape=function(e){return(e=Cr(e))&&z.test(e)?e.replace(H,F):e},ye.uniqueId=function(e){var t=++zr;return Cr(e)+t},ye.upperCase=zo,ye.upperFirst=Yo,ye.each=kn,ye.eachRight=jn,ye.first=Pn,Vr(ye,function(){var e={};return ot(ye,function(t,n){qr.call(ye.prototype,n)||(e[n]=t)}),e}(),{chain:!1}),ye.VERSION="4.3.0",i("bind bindKey curry curryRight partial partialRight".split(" "),function(e){ye[e].placeholder=ye}),i(["drop","take"],function(e,t){Ue.prototype[e]=function(n){var r=this.__filtered__;if(r&&!t)return new Ue(this);n=n===$?1:gi(gr(n),0);var i=this.clone();return r?i.__takeCount__=vi(n,i.__takeCount__):i.__views__.push({size:vi(n,4294967295),type:e+(0>i.__dir__?"Right":"")}),i},Ue.prototype[e+"Right"]=function(t){return this.reverse()[e](t).reverse()}}),i(["filter","map","takeWhile"],function(e,t){var n=t+1,r=1==n||3==n;Ue.prototype[e]=function(e){var t=this.clone();return t.__iteratees__.push({iteratee:pn(e,3),type:n}),t.__filtered__=t.__filtered__||r,t}}),i(["head","last"],function(e,t){var n="take"+(t?"Right":"");Ue.prototype[e]=function(){return this[n](1).value()[0]}}),i(["initial","tail"],function(e,t){var n="drop"+(t?"":"Right");Ue.prototype[e]=function(){return this.__filtered__?new Ue(this):this[n](1)}}),Ue.prototype.compact=function(){return this.filter(Pr)},Ue.prototype.find=function(e){return this.filter(e).head()},Ue.prototype.findLast=function(e){return this.reverse().find(e)},Ue.prototype.invokeMap=Kn(function(e,t){return"function"==typeof e?new Ue(this):this.map(function(n){return ft(n,e,t)})}),Ue.prototype.reject=function(e){return e=pn(e,3),this.filter(function(t){return!e(t)})},Ue.prototype.slice=function(e,t){e=gr(e);var n=this;return n.__filtered__&&(e>0||0>t)?new Ue(n):(0>e?n=n.takeRight(-e):e&&(n=n.drop(e)),t!==$&&(n=0>(t=gr(t))?n.dropRight(-t):n.take(t-e)),n)},Ue.prototype.takeRightWhile=function(e){return this.reverse().takeWhile(e).reverse()},Ue.prototype.toArray=function(){return this.take(4294967295)},ot(Ue.prototype,function(e,t){var n=/^(?:filter|find|map|reject)|While$/.test(t),r=/^(?:head|last)$/.test(t),i=ye[r?"take"+("last"==t?"Right":""):t],o=r||/^find/.test(t);i&&(ye.prototype[t]=function(){var t=this.__wrapped__,a=r?[1]:arguments,s=t instanceof Ue,u=a[0],c=s||Ao(t),m=function(e){return e=i.apply(ye,l([e],a)),r&&f?e[0]:e};c&&n&&"function"==typeof u&&1!=u.length&&(s=c=!1);var f=this.__chain__,p=!!this.__actions__.length;return u=o&&!f,s=s&&!p,!o&&c?(t=s?t:new Ue(this),(t=e.apply(t,a)).__actions__.push({func:$n,args:[m],thisArg:$}),new Ie(t,f)):u&&s?e.apply(this,a):(t=this.thru(m),u?r?t.value()[0]:t.value():t)})}),i("pop push shift sort splice unshift".split(" "),function(e){var t=Wr[e],n=/^(?:push|sort|unshift)$/.test(e)?"tap":"thru",r=/^(?:pop|shift)$/.test(e);ye.prototype[e]=function(){var e=arguments;return r&&!this.__chain__?t.apply(this.value(),e):this[n](function(n){return t.apply(n,e)})}}),ot(Ue.prototype,function(e,t){var n=ye[t];if(n){var r=n.name+"";(Bi[r]||(Bi[r]=[])).push({name:t,func:n})}}),Bi[nn($,2).name]=[{name:"wrapper",func:$}],Ue.prototype.clone=function(){var e=new Ue(this.__wrapped__);return e.__actions__=Gt(this.__actions__),e.__dir__=this.__dir__,e.__filtered__=this.__filtered__,e.__iteratees__=Gt(this.__iteratees__),e.__takeCount__=this.__takeCount__,e.__views__=Gt(this.__views__),e},Ue.prototype.reverse=function(){if(this.__filtered__){var e=new Ue(this);e.__dir__=-1,e.__filtered__=!0}else(e=this.clone()).__dir__*=-1;return e},Ue.prototype.value=function(){var e,t=this.__wrapped__.value(),n=this.__dir__,r=Ao(t),i=0>n,o=r?t.length:0;e=0;for(var a=o,s=this.__views__,u=-1,c=s.length;++u<c;){var l=s[u],m=l.size;switch(l.type){case"drop":e+=m;break;case"dropRight":a-=m;break;case"take":a=vi(a,e+m);break;case"takeRight":e=gi(e,a-m)}}if(a=(e={start:e,end:a}).start,e=(s=e.end)-a,i=i?s:a-1,s=(a=this.__iteratees__).length,u=0,c=vi(e,this.__takeCount__),!r||200>o||o==e&&c==e)return xt(t,this.__actions__);r=[];e:for(;e--&&c>u;){for(o=-1,l=t[i+=n];++o<s;){m=(f=a[o]).type;var f=(0,f.iteratee)(l);if(2==m)l=f;else if(!f){if(1==m)continue e;break e}}r[u++]=l}return r},ye.prototype.at=uo,ye.prototype.chain=function(){return Fn(this)},ye.prototype.commit=function(){return new Ie(this.value(),this.__chain__)},ye.prototype.flatMap=function(e){return this.map(e).flatten()},ye.prototype.next=function(){this.__values__===$&&(this.__values__=hr(this.value()));var e=this.__index__>=this.__values__.length;return{done:e,value:e?$:this.__values__[this.__index__++]}},ye.prototype.plant=function(e){for(var t,n=this;n instanceof Ce;){var r=In(n);r.__index__=0,r.__values__=$,t?i.__wrapped__=r:t=r;var i=r;n=n.__wrapped__}return i.__wrapped__=e,t},ye.prototype.reverse=function(){var e=this.__wrapped__;return e instanceof Ue?(this.__actions__.length&&(e=new Ue(this)),(e=e.reverse()).__actions__.push({func:$n,args:[Rn],thisArg:$}),new Ie(e,this.__chain__)):this.thru(Rn)},ye.prototype.toJSON=ye.prototype.valueOf=ye.prototype.value=function(){return xt(this.__wrapped__,this.__actions__)},si&&(ye.prototype[si]=function(){return this}),ye}();(ke||$e||{})._=Ye,"function"==typeof define&&"object"==typeof define.amd&&define.amd?define(function(){return Ye}):xe&&Le?(je&&((Le.exports=Ye)._=Ye),xe._=Ye):We._=Ye}.call(this),(Bahmni=Bahmni||{}).Common=Bahmni.Common||{},Bahmni.Common.Util=Bahmni.Common.Util||{},angular.module("bahmni.common.util",[]).provider("$bahmniCookieStore",[function(){var e=this;e.defaultOptions={};e.setDefaultOptions=function(t){e.defaultOptions=t},e.$get=function(){return{get:function(e){var t=$.cookie(e);return t?angular.fromJson(decodeURIComponent(t)):null},put:function(t,n,r){var i;r=$.extend({},e.defaultOptions,r),$.cookie.raw=!0,$.cookie(t,(i=angular.toJson(n),encodeURIComponent(i).replace(/[!'()*]/g,function(e){return"%"+e.charCodeAt(0).toString(16)})),r)},remove:function(t,n){n=$.extend({},e.defaultOptions,n),$.removeCookie(t,n)}}}}]),(Bahmni=Bahmni||{}).Common=Bahmni.Common||{},Bahmni.Common.Models=Bahmni.Common.Models||{},angular.module("bahmni.common.models",[]),angular.module("bahmni.common.models").factory("age",[function(){var e=Bahmni.Common.Util.DateUtil,t=function(e,t,n){return{years:e,months:t,days:n,isEmpty:function(){return!(this.years||this.months||this.days)}}};return{fromBirthDate:function(n){var r=e.now(),i=e.diffInYearsMonthsDays(n,r);return t(i.years,i.months,i.days)},create:t,calculateBirthDate:function(t){var n=e.now();return n=e.subtractYears(n,t.years),n=e.subtractMonths(n,t.months),e.subtractDays(n,t.days)}}}]),Bahmni.Common.AuditLogEventDetails={USER_LOGIN_SUCCESS:{eventType:"USER_LOGIN_SUCCESS",message:"USER_LOGIN_SUCCESS_MESSAGE"},USER_LOGIN_FAILED:{eventType:"USER_LOGIN_FAILED",message:"USER_LOGIN_FAILED_MESSAGE"},USER_LOGOUT_SUCCESS:{eventType:"USER_LOGOUT_SUCCESS",message:"USER_LOGOUT_SUCCESS_MESSAGE"},OPEN_VISIT:{eventType:"OPEN_VISIT",message:"OPEN_VISIT_MESSAGE"},EDIT_VISIT:{eventType:"EDIT_VISIT",message:"EDIT_VISIT_MESSAGE"},CLOSE_VISIT:{eventType:"CLOSE_VISIT",message:"CLOSE_VISIT_MESSAGE"},CLOSE_VISIT_FAILED:{eventType:"CLOSE_VISIT_FAILED",message:"CLOSE_VISIT_FAILED_MESSAGE"},EDIT_ENCOUNTER:{eventType:"EDIT_ENCOUNTER",message:"EDIT_ENCOUNTER_MESSAGE"},VIEWED_REGISTRATION_PATIENT_SEARCH:{eventType:"VIEWED_REGISTRATION_PATIENT_SEARCH",message:"VIEWED_REGISTRATION_PATIENT_SEARCH_MESSAGE"},VIEWED_NEW_PATIENT_PAGE:{eventType:"VIEWED_NEW_PATIENT_PAGE",message:"VIEWED_NEW_PATIENT_PAGE_MESSAGE"},REGISTER_NEW_PATIENT:{eventType:"REGISTER_NEW_PATIENT",message:"REGISTER_NEW_PATIENT_MESSAGE"},EDIT_PATIENT_DETAILS:{eventType:"EDIT_PATIENT_DETAILS",message:"EDIT_PATIENT_DETAILS_MESSAGE"},ACCESSED_REGISTRATION_SECOND_PAGE:{eventType:"ACCESSED_REGISTRATION_SECOND_PAGE",message:"ACCESSED_REGISTRATION_SECOND_PAGE_MESSAGE"},VIEWED_PATIENT_DETAILS:{eventType:"VIEWED_PATIENT_DETAILS",message:"VIEWED_PATIENT_DETAILS_MESSAGE"},PRINT_PATIENT_STICKER:{eventType:"PRINT_PATIENT_STICKER",message:"PRINT_PATIENT_STICKER_MESSAGE"},VIEWED_CLINICAL_PATIENT_SEARCH:{eventType:"VIEWED_CLINICAL_PATIENT_SEARCH",message:"VIEWED_PATIENT_SEARCH_MESSAGE"},VIEWED_CLINICAL_DASHBOARD:{eventType:"VIEWED_CLINICAL_DASHBOARD",message:"VIEWED_CLINICAL_DASHBOARD_MESSAGE"},VIEWED_OBSERVATIONS_TAB:{eventType:"VIEWED_OBSERVATIONS_TAB",message:"VIEWED_OBSERVATIONS_TAB_MESSAGE"},VIEWED_DIAGNOSIS_TAB:{eventType:"VIEWED_DIAGNOSIS_TAB",message:"VIEWED_DIAGNOSIS_TAB_MESSAGE"},VIEWED_TREATMENT_TAB:{eventType:"VIEWED_TREATMENT_TAB",message:"VIEWED_TREATMENT_TAB_MESSAGE"},VIEWED_DISPOSITION_TAB:{eventType:"VIEWED_DISPOSITION_TAB",message:"VIEWED_DISPOSITION_TAB_MESSAGE"},VIEWED_DASHBOARD_SUMMARY:{eventType:"VIEWED_DASHBOARD_SUMMARY",message:"VIEWED_DASHBOARD_SUMMARY_MESSAGE"},VIEWED_ORDERS_TAB:{eventType:"VIEWED_ORDERS_TAB",message:"VIEWED_ORDERS_TAB_MESSAGE"},VIEWED_BACTERIOLOGY_TAB:{eventType:"VIEWED_BACTERIOLOGY_TAB",message:"VIEWED_BACTERIOLOGY_TAB_MESSAGE"},VIEWED_INVESTIGATION_TAB:{eventType:"VIEWED_INVESTIGATION_TAB",message:"VIEWED_INVESTIGATION_TAB_MESSAGE"},VIEWED_SUMMARY_PRINT:{eventType:"VIEWED_SUMMARY_PRINT",message:"VIEWED_SUMMARY_PRINT_MESSAGE"},VIEWED_VISIT_DASHBOARD:{eventType:"VIEWED_VISIT_DASHBOARD",message:"VIEWED_VISIT_DASHBOARD_MESSAGE"},VIEWED_VISIT_PRINT:{eventType:"VIEWED_VISIT_PRINT",message:"VIEWED_VISIT_PRINT_MESSAGE"},VIEWED_DASHBOARD_OBSERVATION:{eventType:"VIEWED_DASHBOARD_OBSERVATION",message:"VIEWED_DASHBOARD_OBSERVATION_MESSAGE"},VIEWED_PATIENTPROGRAM:{eventType:"VIEWED_PATIENTPROGRAM",message:"VIEWED_PATIENTPROGRAM_MESSAGE"},RUN_REPORT:{eventType:"RUN_REPORT",message:"RUN_REPORT_MESSAGE"}},angular.module("FredrikSandell.worker-pool",[]).service("WorkerService",["$q",function(e){function t(e){var t="";return angular.forEach(s,function(e){t+="importScripts('"+e+"');"}),angular.forEach(e,function(e){o[e]&&(t+="importScripts('"+o[e].url+"');")}),t}function n(e,t){return u.replace("<URL_TO_ANGULAR>",i).replace("<CUSTOM_DEP_INCLUDES>",t.servicesIncludeStatements).replace("<DEP_MODULES>",t.moduleList).replace("<STRING_DEP_NAMES>",t.angularDepsAsStrings).replace("<DEP_NAMES>",t.angularDepsAsParamList).replace("<STORAGE>",JSON.stringify(a)).replace("<WORKER_FUNCTION>",e.toString())}var r={},i="http://localhost:9876/base/bower_components/angular/angular.js",o={},a={},s=[];r.setAngularUrl=function(e){i=e};var u=["","//try {","var window = self;","self.history = {};","var Node = function() {};","var app","var localStorage = {storage: <STORAGE>, getItem: function(key) {return this.storage[key]}, setItem: function(key, value) {this.storage[key]=value}}","var document = {","      readyState: 'complete',","      cookie: '',","      querySelector: function () {},","      createElement: function () {","          return {","              pathname: '',","              setAttribute: function () {}","          };","      }","};","importScripts('<URL_TO_ANGULAR>');","<CUSTOM_DEP_INCLUDES>","angular = window.angular;","var workerApp = angular.module('WorkerApp', [<DEP_MODULES>]);","workerApp.run(['$q'<STRING_DEP_NAMES>, function ($q<DEP_NAMES>) {","  self.addEventListener('message', function(e) {","    var input = e.data;","    var output = $q.defer();","    var promise = output.promise;","    promise.then(function(success) {","      self.postMessage({event:'success', data : success});","    }, function(reason) {","      self.postMessage({event:'failure', data : reason});","    }, function(update) {","      self.postMessage({event:'update', data : update});","    });","    <WORKER_FUNCTION>;","  });","  self.postMessage({event:'initDone'});","}]);","angular.bootstrap(null, ['WorkerApp']);","//} catch(e) {self.postMessage(JSON.stringify(e));}"].join("\n");r.addDependency=function(e,t,n){return o[e]={url:n,moduleName:t},r},r.includeScripts=function(e){s.push(e)},r.addToLocalStorage=function(e,t){a[e]=t};return r.createAngularWorker=function(r){if(!Array.isArray(r)||r.length<3||"function"!=typeof r[r.length-1])throw"Input needs to be: ['workerInput','deferredOutput'/*optional additional dependencies*/,\n    function(workerInput, deferredOutput /*optional additional dependencies*/)\n        {/*worker body*/}]";var i,a,s,u,c,l,m,f=e.defer(),p=(s=function(e){return e.slice(0,e.length-1)}(r),l=s.filter(function(e){return"input"!==e&&"output"!==e&&"$q"!==e}),(m={dependencies:l,moduleList:(u=l,c=[],angular.forEach(u,function(e){o[e]&&c.push("'"+o[e].moduleName+"'")}),c.join(",")),angularDepsAsStrings:l.length>0?","+l.map(function(e){return"'"+e+"'"}).join(","):"",angularDepsAsParamList:l.length>0?","+l.join(","):"",servicesIncludeStatements:t(l)}).workerFuncParamList="input,output"+m.angularDepsAsParamList,m),d=(window.webkitURL?webkitURL:URL).createObjectURL(new Blob([n((i=r[r.length-1],a=p.workerFuncParamList,"("+i.toString()+")("+a+")"),p)],{type:"application/javascript"})),h=new Worker(d);return h.addEventListener("message",function(t){var n,r,i=t.data.event;console.log(t.data),"initDone"===i?f.resolve(((r={}).worker=n=h,r.run=function(t){var r=e.defer();return n.addEventListener("message",function(e){var t=e.data.event;if("initDone"===t)throw"Received worker initialization in run method. This should already have occurred!";"success"===t?r.resolve(e.data.data):"failure"===t?r.reject(e.data.data):"update"===t?r.notify(e.data.data):r.reject(e)}),n.postMessage(t),r.promise},r.terminate=function(){n.terminate()},r)):f.reject(t)}),f.promise},r}]),angular.module("bahmni.common.routeErrorHandler",["ui.router"]).run(["$rootScope",function(e){e.$on("$stateChangeError",function(e){e.preventDefault()})}]),Bahmni.Common.Util.DateUtil={diffInDays:function(e,t){return Math.floor((this.parse(t)-this.parse(e))/864e5)},diffInMinutes:function(e,t){return moment(t).diff(moment(e),"minutes")},diffInSeconds:function(e,t){return moment(e).diff(moment(t),"seconds")},isInvalid:function(e){return"Invalid Date"==e},diffInDaysRegardlessOfTime:function(e,t){var n=new Date(e),r=new Date(t);return n.setHours(0,0,0,0),r.setHours(0,0,0,0),Math.floor((r-n)/864e5)},addSeconds:function(e,t){return moment(e).add(t,"seconds").toDate()},addMinutes:function(e,t){return this.addSeconds(e,60*t)},addDays:function(e,t){return moment(e).add(t,"day").toDate()},addMonths:function(e,t){return moment(e).add(t,"month").toDate()},addYears:function(e,t){return moment(e).add(t,"year").toDate()},subtractSeconds:function(e,t){return moment(e).subtract(t,"seconds").toDate()},subtractDays:function(e,t){return this.addDays(e,-1*t)},subtractISOWeekDays:function(e,t){return null==t?moment(e).isoWeekday():moment(e).isoWeekday()>=t?moment(e).isoWeekday()-t:7+moment(e).isoWeekday()-t},subtractMonths:function(e,t){return this.addMonths(e,-1*t)},subtractYears:function(e,t){return this.addYears(e,-1*t)},createDays:function(e,t){e=this.getDate(e),t=this.getDate(t);for(var n=this.diffInDays(e,t),r=[],i=0;i<=n;i++)r.push({dayNumber:i+1,date:this.addDays(e,i)});return r},getDayNumber:function(e,t){return this.diffInDays(this.getDate(e),this.getDate(t))+1},getDateWithoutTime:function(e){return e?moment(e).format("YYYY-MM-DD"):null},getDateInMonthsAndYears:function(e,t){t=t||"MMM YY";var n=isNaN(Number(e))?e:Number(e);return moment(n).isValid()?n?moment(n).format(t):null:e},formatDateWithTime:function(e){var t=isNaN(Number(e))?e:Number(e);return moment(t).isValid()?t?moment(t).format("DD MMM YY h:mm a"):null:e},formatDateWithoutTime:function(e){var t=isNaN(Number(e))?e:Number(e);return moment(t).isValid()?t?moment(t).format("DD MMM YY"):null:e},formatDateInStrictMode:function(e){var t=isNaN(Number(e))?e:Number(e);return moment(t,"YYYY-MM-DD",!0).isValid()?moment(t).format("DD MMM YY"):moment(t,"YYYY-MM-DDTHH:mm:ss.SSSZZ",!0).isValid()?moment(t).format("DD MMM YY"):e},formatTime:function(e){var t=isNaN(Number(e))?e:Number(e);return moment(t).isValid()?t?moment(t).format("h:mm a"):null:e},getDate:function(e){return moment(this.parse(e)).startOf("day").toDate()},parse:function(e){return e?moment(e).toDate():null},parseDatetime:function(e){return e?moment(e):null},now:function(){return new Date},today:function(){return this.getDate(this.now())},endOfToday:function(){return moment(this.parse(this.now())).endOf("day").toDate()},getDateWithoutHours:function(e){return moment(e).toDate().setHours(0,0,0,0)},getDateTimeWithoutSeconds:function(e){return moment(e).toDate().setSeconds(0,0)},isSameDateTime:function(e,t){if(null==e||null==t)return!1;var n=this.parse(e),r=this.parse(t);return n.getTime()==r.getTime()},isBeforeDate:function(e,t){return moment(e).isBefore(moment(t))},isSameDate:function(e,t){if(null==e||null==t)return!1;var n=this.parse(e),r=this.parse(t);return n.getFullYear()===r.getFullYear()&&n.getMonth()===r.getMonth()&&n.getDate()===r.getDate()},diffInYearsMonthsDays:function(e,t){e=this.parse(e),t=this.parse(t);var n={d:e.getDate(),m:e.getMonth(),y:e.getFullYear()},r=t.getDate(),i=t.getMonth(),o=t.getFullYear(),a={d:0,m:0,y:0},s=[31,o%4!=0||o%100==0&&o%400!=0?28:29,31,30,31,30,31,31,30,31,30,31];return a.y=o-n.y,a.m=i-n.m,n.m>i&&(a.y=a.y-1,a.m=i-n.m+12),a.d=r-n.d,n.d>r&&(a.m=a.m-1,n.m==i&&(a.y=a.y-1,a.m=a.m+12),a.d=r-n.d+s[parseInt(n.m)]),{days:a.d,months:a.m,years:a.y}},convertToUnits:function(e){var t={Years:525600,Months:43200,Weeks:10080,Days:1440,Hours:60,Minutes:1},n=function(e,n,r){return{value:e,unitName:n,unitValueInMinutes:r,allUnits:t}};for(var r in t){var i=t[r];if((e||0!==e)&&e>=i&&e%i==0)return n(e/i,r,i)}return n(void 0,void 0,void 0)},getEndDateFromDuration:function(e,t,n){var r={h:(e=this.parse(e)).getHours(),d:e.getDate(),m:e.getMonth(),y:e.getFullYear()},i=new Date(r.y,r.m,r.d,r.h);return"Months"===n?i.setMonth(r.m+t):"Weeks"===n?i.setDate(r.d+7*t):"Days"===n?i.setDate(r.d+t):"Hours"===n&&i.setHours(r.h+t),i},parseLongDateToServerFormat:function(e){return e?moment(e).format("YYYY-MM-DDTHH:mm:ss.SSS"):null},parseServerDateToDate:function(e){return e?moment(e,"YYYY-MM-DDTHH:mm:ss.SSSZZ").toDate():null},getDateTimeInSpecifiedFormat:function(e,t){return e?moment(e).format(t):null},getISOString:function(e){return e?moment(e).toDate().toISOString():null},isBeforeTime:function(e,t){return moment(e,"hh:mm a").format("YYYY-MM-DD")},getWeekStartDate:function(e,t){var n=this.subtractISOWeekDays(e,t);return moment(e).subtract(n,"days").toDate()},getWeekEndDate:function(e){return moment(e).add(6,"days").toDate()}},Bahmni.Common.Util.ValidationUtil=function(){var e=function(e){return _.includes(["string","boolean","number","object"],typeof e)},t=function(n){var r={};for(var i in n)if(n.hasOwnProperty(i)&&e(n[i]))if("object"!=typeof n[i]||n[i]instanceof Date)r[i]=n[i];else{var o=t(n[i]);for(var a in o)o.hasOwnProperty(a)&&e(o[a])&&(r[i+"."+a]=o[a])}return r};return{validate:function(e,n){var r=Bahmni.Registration.customValidator;if(!r)return[];var i=t(e),o=[];return _.every(i,function(e,t){var i=!0,a=r[t];if(!a)return i;if("function"==typeof a.method&&e){var s=_.find(n,{name:t});(i=a.method(t,e,s))||(o.push(a.errorMessage),i=!0)}return i}),o}}}(),Bahmni.Common.Util.DynamicResourceLoader={includeJs:function(e){var t=document.createElement("script");t.setAttribute("src",e),document.body.appendChild(t)},includeCss:function(e){var t=document.createElement("link");t.setAttribute("href",e),t.setAttribute("rel","stylesheet"),t.setAttribute("type","text/css"),document.head.appendChild(t)}},Bahmni.Common.Util.ArrayUtil={chunk:function(e,t){for(var n=[],r=0;r<e.length;r+=t)n.push(e.slice(r,r+t));return n},groupByPreservingOrder:function(e,t,n,r){var i=[];return e.forEach(function(e){var o=t(e),a=_.find(i,function(e){return e[n]===o});if(a)a[r].push(e);else{var s={};s[n]=o,s[r]=[e],i.push(s)}}),i}},Bahmni.Common.Util.FormFieldPathUtil={getFormNameAndVersion:function(e){var t=e.split("/")[0].split(".");return{formName:t[0],formVersion:t[1]}}},angular.module("httpErrorInterceptor",[]).config(["$httpProvider",function(e){var t=["$rootScope","$q",function(e,t){function n(e){return n=":",r=(t=e).indexOf(n),t.substr(r+1).trim();var t,n,r}var r=Bahmni.Common.Constants.serverErrorMessages,i=function(t){var n=_.find(r,function(e){return e.serverMessage===t});_.isEmpty(n)&&e.$broadcast("event:serverError",t)};return{response:function(e){return e},responseError:function(r){var o=r.data,a="There was an unexpected issue on the server. Please try again";if(500===r.status){var s=o.error&&o.error.message?n(o.error.message):a;i(s)}else 409===r.status?(s=o.error&&o.error.message?n(o.error.message):"Duplicate entry error",i(s)):0===r.status?i("Could not connect to the server. Please check your connection and try again"):405===r.status?i(a):400===r.status?(s=o.error&&o.error.message?o.error.message:o.localizedMessage||"Could not connect to the server. Please check your connection and try again",i(s)):403===r.status?(s=o.error&&o.error.message?o.error.message:a,!function(e){if((e.data.error?e.data.error.message:e.data).search("HTTP Status 403 - Session timed out")>0)return!0}(r)?i(s):e.$broadcast("event:auth-loginRequired")):404===r.status&&(_.includes(r.config.url,"implementation_config")||_.includes(r.config.url,"locale_")||_.includes(r.config.url,"offlineMetadata")||i("The requested information does not exist"));return t.reject(r)}}}];e.interceptors.push(t)}]),Bahmni.Common.VisitControl=function(e,t,n,r,i){var o=this;o.visitTypes=e,o.defaultVisitTypeName=t,o.defaultVisitType=e.filter(function(e){return e.name===t})[0],o.startButtonText=function(e){return r.instant("REGISTRATION_START_VISIT",{visitType:e.name})},o.startVisit=function(e){o.onStartVisit(),o.selectedVisitType=e},o.createVisitOnly=function(e,t){var n={patient:e,visitType:(o.selectedVisitType||o.defaultVisitType).uuid,location:t};return i.createVisit(n)}},Bahmni.Common.Util.TranslationUtil={translateAttribute:function(e,t,n){if(void 0!==e){if(null==t||void 0===t)var r=" ";else r=t;var i=r+"_"+e.toUpperCase().replace(/\s\s+/g," ").replace(/[^a-zA-Z0-9 _]/g,"").trim().replace(/ /g,"_"),o=n.instant(i);o!=i&&(e=o)}return e}},Bahmni.Common.Util.GenderUtil={translateGender:function(e,t){_.forEach(e,function(n,r){var i="GENDER_"+r.toUpperCase(),o=t.instant(i);o!=i&&(e[r]=o)})}},angular.module("bahmni.common.config",[]),angular.module("bahmni.common.config").service("configurations",["configurationService",function(e){this.configs={},this.load=function(t){var n=this;return e.getConfigurations(_.difference(t,Object.keys(this.configs))).then(function(e){angular.extend(n.configs,e)})},this.dosageInstructionConfig=function(){return this.configs.dosageInstructionConfig||[]},this.stoppedOrderReasonConfig=function(){return this.configs.stoppedOrderReasonConfig||[]},this.dosageFrequencyConfig=function(){return this.configs.dosageFrequencyConfig||[]},this.allTestsAndPanelsConcept=function(){return this.configs.allTestsAndPanelsConcept.results[0]||[]},this.impressionConcept=function(){return this.configs.radiologyImpressionConfig.results[0]||[]},this.labOrderNotesConcept=function(){return this.configs.labOrderNotesConfig.results[0]||[]},this.consultationNoteConcept=function(){return this.configs.consultationNoteConfig.results[0]||[]},this.patientConfig=function(){return this.configs.patientConfig||{}},this.encounterConfig=function(){return angular.extend(new EncounterConfig,this.configs.encounterConfig||[])},this.patientAttributesConfig=function(){return this.configs.patientAttributesConfig.results},this.identifierTypesConfig=function(){return this.configs.identifierTypesConfig},this.genderMap=function(){return this.configs.genderMap},this.addressLevels=function(){return this.configs.addressLevels},this.relationshipTypes=function(){return this.configs.relationshipTypeConfig.results||[]},this.relationshipTypeMap=function(){return this.configs.relationshipTypeMap||{}},this.loginLocationToVisitTypeMapping=function(){return this.configs.loginLocationToVisitTypeMapping||{}},this.defaultEncounterType=function(){return this.configs.defaultEncounterType}}]),(Bahmni=Bahmni||{}).Common=Bahmni.Common||{},Bahmni.Common.Domain=Bahmni.Common.Domain||{},Bahmni.Common.Domain.Helper=Bahmni.Common.Domain.Helper||{},angular.module("bahmni.common.domain",[]),function(){Bahmni.Common.Domain.ObservationFilter=function(){var t=function(e){e.forEach(function(e){t(e.groupMembers),e.voided=e.voided||e.canBeVoided(),e.voided&&n(e)})},n=function(e){e.groupMembers.forEach(function(e){e.voided=!0,n(e)})},r=function(e){return e.forEach(function(e){e.groupMembers=r(e.groupMembers)}),e.filter(function(e){return(e.isExisting()||e.hasValue()||e.hasMemberWithValue())&&!e.voided||e.isExisting()&&e.voided})},i=function(e){return e.forEach(function(e){e.groupMembers=i(e.groupMembers)}),_.reject(e,function(e){return e.isNew()&&e.voided})};this.filter=function(n){var o=n.map(e.wrap),a=r(o);return a=i(a),t(a),a}};var e=function(e){angular.extend(this,e),this.isNew=function(){return!this.uuid},this.isExisting=function(){return!this.isNew()},this.hasValue=function(){return void 0!==this.value&&null!==this.value&&""!==this.value},this.hasMemberWithValue=function(){return this.groupMembers.some(function(e){return e.hasValue()||e.hasMemberWithValue()})},this.isGroup=function(){return this.groupMembers.length>0},this.isLeaf=function(){return!this.isGroup()},this.isGroupWithOnlyVoidedMembers=function(){return this.isGroup()&&this.groupMembers.every(function(e){return e.voided})},this.isLeafNodeWithOutValue=function(){return this.isLeaf()&&!this.hasValue()},this.canBeVoided=function(){return this.isExisting()&&(this.isLeafNodeWithOutValue()||this.isGroupWithOnlyVoidedMembers())}};e.wrap=function(t){var n=new e(t);return n.groupMembers=n.groupMembers?n.groupMembers.map(e.wrap):[],n}}(),Bahmni.Common.Domain.Helper.getHintForNumericConcept=function(e){if(e)return null!=e.hiNormal&&null!=e.lowNormal?"("+e.lowNormal+" - "+e.hiNormal+")":null!=e.hiNormal&&null==e.lowNormal?"(< "+e.hiNormal+")":null==e.hiNormal&&null!=e.lowNormal?"(> "+e.lowNormal+")":""},Bahmni.Common.Domain.ConceptMapper=function(){this.map=function(t){if(!t)return null;if(e(t))return t;var n=t.descriptions?t.descriptions[0]:null,r=_.find(t.names,{conceptNameType:"SHORT"});return{uuid:t.uuid,name:t.name.name,shortName:r?r.name:null,description:n?n.description:null,set:t.set,dataType:t.datatype?t.datatype.name:null,hiAbsolute:t.hiAbsolute,lowAbsolute:t.lowAbsolute,hiNormal:t.hiNormal,handler:t.handler,allowDecimal:t.allowDecimal,lowNormal:t.lowNormal,conceptClass:t.conceptClass?t.conceptClass.name:null,answers:t.answers,units:t.units,displayString:r?r.name:t.name.name,names:t.names}};var e=function(e){return!e.name.name}},angular.module("bahmni.common.domain").factory("providerService",["$http",function(e){return{search:function(t){return e.get(Bahmni.Common.Constants.providerUrl,{method:"GET",params:{q:t,v:"full"},withCredentials:!0})},searchByUuid:function(t){return e.get(Bahmni.Common.Constants.providerUrl,{method:"GET",params:{user:t},cache:!1})},list:function(t){return e.get(Bahmni.Common.Constants.providerUrl,{method:"GET",cache:!1,params:t})}}}]);var EncounterConfig=function(){function e(e){this.encounterTypes=e}return e.prototype={getConsultationEncounterTypeUuid:function(){return this.getEncounterTypeUuid("Consultation")},getAdmissionEncounterTypeUuid:function(){return this.getEncounterTypeUuid("ADMISSION")},getDischargeEncounterTypeUuid:function(){return this.getEncounterTypeUuid("DISCHARGE")},getTransferEncounterTypeUuid:function(){return this.getEncounterTypeUuid("TRANSFER")},getRadiologyEncounterTypeUuid:function(){return this.getEncounterTypeUuid("RADIOLOGY")},getPatientDocumentEncounterTypeUuid:function(){return this.getEncounterTypeUuid("Patient Document")},getValidationEncounterTypeUuid:function(){return this.getEncounterTypeUuid(Bahmni.Common.Constants.validationNotesEncounterType)},getEncounterTypeUuid:function(e){return this.encounterTypes[e]},getVisitTypes:function(){var e=[];for(var t in this.visitTypes)e.push({name:t,uuid:this.visitTypes[t]});return e},getEncounterTypes:function(){var e=[];for(var t in this.encounterTypes)e.push({name:t,uuid:this.encounterTypes[t]});return e},getVisitTypeByUuid:function(e){return this.getVisitTypes().filter(function(t){return t.uuid===e})[0]},getEncounterTypeByUuid:function(e){return this.getEncounterTypes().filter(function(t){return t.uuid===e})[0]}},e}();!function(){var e={Date:function(e){return moment(e.value).format("D-MMM-YYYY")},Datetime:function(e){var t=Bahmni.Common.Util.DateUtil.parseDatetime(e.value);return null!=t?Bahmni.Common.Util.DateUtil.formatDateWithTime(t):""},Boolean:function(e){return!0===e.value?"Yes":!1===e.value?"No":e.value},Coded:function(e){return e.value.shortName||e.value.name||e.value},Object:function(t){return e.Coded(t)},MultiSelect:function(e){return e.getValues().join(", ")},Default:function(e){return e.value}};Bahmni.Common.Domain.ObservationValueMapper={getNameFor:e,map:function(t){var n=t.concept&&t.concept.dataType||t.type;return n in e||(n=("object"==typeof t.value?"Object":t.isMultiSelect&&"MultiSelect")||"Default"),e[n](t)}}}(),angular.module("bahmni.common.uiHelper",["ngClipboard"]),angular.module("bahmni.common.uiHelper").directive("nonBlank",function(){return function(e,t,n){var r=function(){t.attr({required:"required"})};return n.nonBlank?void e.$watch(n.nonBlank,function(e){return e?r():void t.removeAttr("required")}):r()}}).directive("datepicker",function(){return{require:"ngModel",link:function(e,t,n,r){var i=n.maxDate,o=n.minDate||"-120y",a=n.dateFormat||"dd-mm-yy";t.datepicker({changeYear:!0,changeMonth:!0,maxDate:i,minDate:o,yearRange:"c-120:c+120",dateFormat:a,onSelect:function(t){e.$apply(function(){r.$setViewValue(t)})}})}}}).directive("myAutocomplete",["$parse",function(e){return{link:function(t,n,r,i){var o=(e(r.ngModel),t.source()),a=t.responseMap(),s=t.onSelect();n.autocomplete({autofocus:!0,minLength:2,source:function(e,t){o(r.id,e.term,r.itemType).then(function(e){var n=a?a(e.data):e.data;t(n)})},select:function(e,n){return t.$apply(function(e){i.$setViewValue(n.item.value),e.$eval(r.ngChange),null!=s&&s(n.item)}),!0},search:function(e){$.trim(n.val()).length<2&&e.preventDefault()}})},require:"ngModel",scope:{source:"&",responseMap:"&",onSelect:"&"}}}]).directive("bmForm",["$timeout",function(e){return{link:function(t,n,r){e(function(){$(n).unbind("submit").submit(function(e){var i=t.$parent,o=r.name;e.preventDefault(),t.autofillable&&$(n).find("input").trigger("change"),i[o].$valid?(i.$apply(r.ngSubmit),$(n).removeClass("submitted-with-error")):$(n).addClass("submitted-with-error")})},0)},require:"form",scope:{autofillable:"="}}}]).directive("patternValidate",["$timeout",function(e){return function(t,n,r){e(function(){t.fieldValidation&&t.fieldValidation[r.id]&&n.attr({pattern:t.fieldValidation[r.id].pattern,title:t.fieldValidation[r.id].errorMessage,type:"text"})})}}]).directive("validateOn",function(){return{link:function(e,t,n,r){var i=n.validationMessage||"Please enter a valid detail";e.$watch(n.validateOn,function(e){var n=!!e;r.$setValidity("blank",n),t[0].setCustomValidity(n?"":i)},!0)},require:"ngModel"}}),angular.module("bahmni.common.uiHelper").directive("toggle",function(){return{scope:{toggle:"="},link:function(e,t){e.toggle=void 0!==e.toggle&&e.toggle,$(t).click(function(){e.$apply(function(){e.toggle=!e.toggle})}),e.$watch("toggle",function(){$(t).toggleClass("active",e.toggle)}),e.$on("$destroy",function(){t.off("click")})}}}),angular.module("bahmni.common.uiHelper").directive("bmPopOver",function(){return{restrict:"A",controller:function(e){e.targetElements=[];var t=function(){e.targetElements.forEach(function(e){e.hide()})};this.registerTriggerElement=function(n){e.triggerElement=n;var r=function(){e.autoclose&&(t(),e.isTargetOpen=!1,$(document).off("click",r))};e.triggerElement.on("click",function(n){e.isTargetOpen?(e.isTargetOpen=!1,t(),$(document).off("click",r)):(e.isTargetOpen=!0,e.targetElements.forEach(function(e){e.show()}),$(document).on("click",r),n.stopImmediatePropagation())}),e.$on("$destroy",function(){$(document).off("click",r)})},this.registerTargetElement=function(t){t.hide(),e.targetElements.push(t)};var n=function(){e.isTargetOpen&&(e.isTargetOpen=!1,t())};$(document).on("click",".reg-wrapper",n),e.$on("$destroy",function(){$(document).off("click",".reg-wrapper",n)})},scope:{autoclose:"="}}}).directive("bmPopOverTarget",function(){return{restrict:"A",require:"^bmPopOver",link:function(e,t,n,r){r.registerTargetElement(t)}}}).directive("bmPopOverTrigger",function(){return{restrict:"A",require:"^bmPopOver",link:function(e,t,n,r){r.registerTriggerElement(t)}}}),angular.module("bahmni.common.uiHelper").directive("splitButton",["$timeout",function(e){return{restrict:"A",template:'<div class="split-button" bm-pop-over><button bm-pop-over-trigger class="toggle-button fa fa-caret-down" ng-show="::hasMultipleOptions()" ng-click="scrollToBottom()" ng-disabled="optionDisabled" type="button"></button><ul class="options"><li class="primaryOption"><button class="buttonClass" ng-click="optionClick()(primaryOption)" accesskey="{{::primaryOption.shortcutKey}}" ng-disabled="optionDisabled" ng-bind-html="::optionText()(primaryOption,\'primary\') | translate "></button></li><ul class="hidden-options"><li bm-pop-over-target ng-repeat="option in ::secondaryOptions" class="secondaryOption"><button class="buttonClass" ng-click="optionClick()(option)" accesskey="{{::option.shortcutKey}}" ng-disabled="optionDisabled" ng-bind-html="::optionText()(option) | translate"></button></li></ul></ul></div>',controller:function(e){e.primaryOption=e.primaryOption||e.options[0],e.secondaryOptions=_.without(e.options,e.primaryOption),e.hasMultipleOptions=function(){return e.secondaryOptions.length>0}},link:function(t,n){t.scrollToBottom=function(){var t=e(function(){var r,i,o=$(n)[0].scrollHeight;r=n.position().top,i=o,window.innerHeight+$(window).scrollTop()<i+r&&(window.scrollBy(0,o),e.cancel(t))})}},scope:{options:"=",primaryOption:"=",optionText:"&",optionClick:"&",optionDisabled:"="}}}]),angular.module("bahmni.common.uiHelper").directive("focusOn",["$timeout",function(e){return function(t,n,r){Modernizr.ios||t.$watch(r.focusOn,function(t){t&&e(function(){$(n).focus()})})}}]),function(){var e=function(e,t){var n=null,r=e.name;if(!_.includes(_.toLower(r),_.toLower(t))){var i=_.map(e.names,"name");n=_.find(i,function(e){return e!==r&&-1!==e.search(new RegExp(t,"i"))})}return{label:n?n+" => "+r:r,value:r,concept:e,uuid:e.uuid,name:r}},t=function(t,n,r){return{link:function(t,n,i,o){var a=t.minLength||2,s=t.previousValue,u=function(e){if(t.strictSelect)return t.illegalValue||!_.isEmpty(e)&&e!==s?void n.addClass("illegalValue"):void n.removeClass("illegalValue")};n.autocomplete({autofocus:!0,minLength:a,source:function(n,i){!t.answersConceptName&&t.defaultConcept?function(t,n,r){var i=_.toLower(n.term.trim()),o=_.partial(e,_,i);t().then(_.partial(_.filter,_,function(e){var t=_.find(e.names,function(e){return _.includes(_.toLower(e.name),i)}),n=_.includes(_.toLower(e.name),i);return t||n})).then(_.partial(_.map,_,o)).then(r)}(_.partial(r.getAnswers,t.defaultConcept),n,i):function(t,n,r){var i=n.term.trim(),o=_.partial(e,_,i);t().then(_.partial(_.map,_,o)).then(r)}(_.partial(r.getAnswersForConceptName,{term:n.term,answersConceptName:t.answersConceptName}),n,i)},select:function(e,r){return t.$apply(function(e){o.$setViewValue(r.item),e.blurOnSelect&&n.blur(),s=r.item.value,u(s),e.$eval(i.ngChange)}),!0},search:function(e){$.trim(n.val()).length<a&&e.preventDefault(),s=null}});var c=function(){var e=$.trim(n.val());u(e)};n.on("blur",c),t.$on("$destroy",function(){n.off("blur",c)})},require:"ngModel",scope:{illegalValue:"=",defaultConcept:"=",answersConceptName:"=",minLength:"=",blurOnSelect:"=",strictSelect:"=?",previousValue:"="}}};t.$inject=["$parse","$http","conceptService"],angular.module("bahmni.common.uiHelper").directive("conceptAutocomplete",t)}(),angular.module("bahmni.common.uiHelper").directive("focusMe",["$timeout","$parse",function(e,t){return{link:function(n,r,i){var o=t(i.focusMe);n.$watch(o,function(t){!0===t&&e(function(){r[0].focus()})})}}}]),angular.module("bahmni.common.uiHelper").directive("bahmniAutocomplete",["$translate",function(e){return{link:function(t,n,r,i){var o=t.source(),a=t.responseMap&&t.responseMap(),s=t.onSelect(),u=t.onEdit&&t.onEdit(),c=t.minLength||2,l=n[0],m=t.validationMessage||e.instant("SELECT_VALUE_FROM_AUTOCOMPLETE_DEFAULT_MESSAGE"),f=function(e){t.strictSelect&&(t.isInvalid=e!==t.selectedValue,_.isEmpty(e)&&(t.isInvalid=!1))};t.$watch("initialValue",function(){t.initialValue&&(t.selectedValue=t.initialValue,t.isInvalid=!1)}),n.autocomplete({autofocus:!0,minLength:c,source:function(e,t){o({elementId:r.id,term:e.term,elementType:r.type}).then(function(e){var n=a?a(e):e;t(n)})},select:function(e,o){return t.selectedValue=o.item.value,i.$setViewValue(o.item.value),null!=s&&s(o.item),f(o.item.value),t.blurOnSelect&&n.blur(),t.$apply(),t.$eval(r.ngDisabled),t.$apply(),!0},search:function(e,t){null!=u&&u(t.item);var r=$.trim(n.val());f(r),r.length<c&&e.preventDefault()}});var p=function(e){f(n.val())},d=function(e){f(n.val()),t.$apply()};n.on("change",p),n.on("keyup",d),t.$watch("isInvalid",function(){i.$setValidity("selection",!t.isInvalid),l.setCustomValidity(t.isInvalid?m:"")}),t.$on("$destroy",function(){n.off("change",p),n.off("keyup",d)})},require:"ngModel",scope:{source:"&",responseMap:"&?",onSelect:"&",onEdit:"&?",minLength:"=?",blurOnSelect:"=?",strictSelect:"=?",validationMessage:"@",isInvalid:"=?",initialValue:"=?"}}}]),angular.module("bahmni.common.uiHelper").factory("spinner",["messagingService","$timeout",function(e,t){var n=[],r=function(e){return $(e).find("div").eq(0)},i=function(e){return void 0!==e?function(e){return 0===$(e).find(".dashboard-section-loader").length&&r(e).addClass("spinnable").append('<div class="dashboard-section-loader"></div>'),{element:$(e).find(".dashboard-section-loader")}}(e):function(){var e=Math.random();n.push(e),0===$("#overlay").length&&$("body").prepend('<div id="overlay"><div></div></div>');var t=$("#overlay");return t.stop().show(),{element:t,token:e}}()},o=function(e,t){var i=e.element;e.token?(_.pull(n,e.token),0===n.length&&i.fadeOut(300)):(r(t).removeClass("spinnable"),i&&i.remove())};return{forPromise:function(e,n){return t(function(){var t=i(n);return e.finally(function(){o(t,n)}),e})},forAjaxPromise:function(e,t){var n=i(t);return e.always(function(){o(n,t)}),e},show:i,hide:o}}]),angular.module("bahmni.common.uiHelper").factory("printer",["$rootScope","$compile","$http","$timeout","$q","spinner",function(e,t,n,r,i,o){var a=function(e){var t=i.defer(),n=$('<iframe style="visibility: hidden"></iframe>').appendTo("body")[0];n.contentWindow.printAndRemove=function(){n.contentWindow.print(),$(n).remove(),t.resolve()};var r='<!doctype html><html><body onload="printAndRemove();">'+e+"</body></html>",o=n.contentWindow.document.open("text/html","replace");return o.write(r),o.close(),t.promise};return{print:function(s,u){e.isBeingPrinted=!0,n.get(s).then(function(s){var c=s.data,l=e.$new();angular.extend(l,u);var m=t($("<div>"+c+"</div>"))(l),f=i.defer(),p=function(){return l.$$phase||n.pendingRequests.length?r(p,1e3):(a(m.html()).then(function(){e.isBeingPrinted=!1,f.resolve()}),l.$destroy()),f.promise};o.forPromise(p())})},printFromScope:function(s,u,c){e.isBeingPrinted=!0,n.get(s).then(function(s){var l=s.data,m=u,f=t($("<div>"+l+"</div>"))(m),p=i.defer(),d=function(){return m.$$phase||n.pendingRequests.length?r(d):a(f.html()).then(function(){e.isBeingPrinted=!1,c&&c(),p.resolve()}),p.promise};o.forPromise(d())})}}}]),angular.module("bahmni.common.uiHelper").service("contextChangeHandler",["$rootScope",function(e){var t=[],n=this;e.$on("$stateChangeSuccess",function(){n.reset()}),this.reset=function(){t=[]},this.add=function(e){t.push(e)},this.execute=function(){var e=!0,n=null,r=null;return t.forEach(function(t){n=t(),e=e&&n.allow,_.isEmpty(r)&&(r=n.errorMessage)}),n&&r?{allow:e,errorMessage:r}:{allow:e}}}]),angular.module("bahmni.common.uiHelper").controller("MessageController",["$scope","messagingService",function(e,t){e.messages=t.messages,e.getMessageText=function(t){var n="";return e.messages[t].forEach(function(e){n=n.concat(e.value)}),n},e.hideMessage=function(e){t.hideMessages(e)},e.isErrorMessagePresent=function(){return e.messages.error.length>0},e.isInfoMessagePresent=function(){return e.messages.info.length>0}}]),angular.module("bahmni.common.uiHelper").service("messagingService",["$rootScope","$timeout",function(e,t){this.messages={error:[],info:[]};var n=this;e.$on("event:serverError",function(e,t){n.showMessage("error",t,"serverError")}),this.showMessage=function(e,t,n){var r={value:"",isServerError:!1};r.value=t,n?r.isServerError=!0:"info"==e&&this.createTimeout("info",4e3);var i=_.findIndex(this.messages[e],function(e){return e.value==r.value});i>=0&&this.messages[e].splice(i,1),this.messages[e].push(r)},this.createTimeout=function(e,r){t(function(){n.messages[e]=[]},r,!0)},this.hideMessages=function(e){n.messages[e].length=0},this.clearAll=function(){n.messages.error=[],n.messages.info=[]}}]),angular.module("bahmni.common.uiHelper").directive("ngConfirmClick",function(){return{restrict:"A",link:function(e,t,n){var r=n.confirmMessage||"Are you sure?",i=n.ngConfirmClick;t.bind("click",function(){window.confirm(r)&&e.$apply(i)})}}}),angular.module("bahmni.common.uiHelper").directive("bmShow",["$rootScope",function(e){return{scope:{bmShow:"="},link:function(t,n){t.$watch("bmShow",function(){e.isBeingPrinted||t.bmShow?n.removeClass("ng-hide"):n.addClass("ng-hide")})}}}]),angular.module("bahmni.common.uiHelper").directive("monthyearpicker",["$translate",function(e){return{restrict:"E",link:function(t){var n=e.instant("MONTHS");t.monthNames=n.split(",");t.years=function(){for(var e=t.minYear?t.minYear:moment().toDate().getFullYear()-15,n=[],r=t.maxYear?t.maxYear:moment().toDate().getFullYear()+5;r>=e;r--)n.push(r);return n}();var r=function(){return null!=t.selectedMonth&&null!=t.selectedYear};if(t.updateModel=function(){var e;r()?t.model=(e=t.selectedMonth+1,t.selectedYear+"-"+e+"-01"):t.isValid()?t.model="":t.model="Invalid Date"},t.isValid=function(){return null==t.selectedMonth&&null==t.selectedYear||r()},t.illegalMonth=function(){return(void 0===t.selectedMonth||null===t.selectedMonth)&&null!==t.selectedYear&&void 0!==t.selectedYear},t.illegalYear=function(){return null!==t.selectedMonth&&void 0!==t.selectedMonth&&(void 0===t.selectedYear||null===t.selectedYear)},t.model){var i=moment(t.model).toDate();t.selectedMonth=i.getMonth(),t.selectedYear=i.getFullYear()}},scope:{observation:"=",minYear:"=",maxYear:"=",illegalValue:"=",model:"="},template:'<span><select ng-model=\'selectedMonth\'  ng-class="{\'illegalValue\': illegalMonth() || illegalValue}" ng-change="updateModel()" ng-options="monthNames.indexOf(month) as month for month in monthNames" ><option value="">{{\'CHOOSE_MONTH_KEY\' | translate}}</option>></select></span><span><select ng-model=\'selectedYear\'   ng-class="{\'illegalValue\': illegalYear() || illegalValue}" ng-change="updateModel()" ng-options="year as year for year in years"><option value="">{{\'CHOOSE_YEAR_KEY\' | translate}}</option>></select></span>'}}]),angular.module("bahmni.common.uiHelper").directive("singleClick",function(){var e=!1;return{scope:{singleClick:"&"},restrict:"A",link:function(t,n){var r=function(){e||(e=!0,t.singleClick().finally(function(){e=!1}))};n.on("click",r),t.$on("$destroy",function(){n.off("click",r)})}}}),angular.module("bahmni.common.uiHelper").directive("singleSubmit",function(){var e=!1;return{scope:{singleSubmit:"&"},restrict:"A",link:function(t,n){var r=function(){e||(e=!0,t.singleSubmit().finally(function(){e=!1}))};n.on("submit",r),t.$on("$destroy",function(){n.off("submit",r)})}}}),(Bahmni=Bahmni||{}).Common=Bahmni.Common||{},Bahmni.Common.UIControls=Bahmni.Common.UIControls||{},angular.module("bahmni.common.uicontrols",[]),function(){var e=function(e){var t=e.shortName||e.name.name||e.name;return{label:t,value:t,concept:e,uuid:e.uuid,name:t}},t=function(t){return{controller:function(n){n.onChange=n.onChange();var r=function(e){var t,r;n.answers=e,n.selectedAnswer=(t=e,r=n.selectedAnswer,_.find(t,function(e){return r&&r.uuid===e.concept.uuid}))};return!n.answersConceptName&&n.defaultConcept?void t.getAnswers(n.defaultConcept).then(function(t){return _.map(t,e)}).then(r):void t.getAnswersForConceptName({answersConceptName:n.answersConceptName}).then(function(t){return _.map(t,e)}).then(r)},restrict:"E",scope:{selectedAnswer:"=model",answersConceptName:"=?",defaultConcept:"=",onChange:"&",onInvalidClass:"@",isValid:"=",ngDisabled:"="},templateUrl:"../common/uicontrols/concept-dropdown/views/conceptDropdown.html"}};t.$inject=["conceptService"],angular.module("bahmni.common.uicontrols").directive("conceptDropdown",t)}(),angular.module("bahmni.common.attributeTypes",[]).directive("attributeTypes",[function(){return{scope:{targetModel:"=",attribute:"=",fieldValidation:"=",isAutoComplete:"&",getAutoCompleteList:"&",getDataResults:"&",handleUpdate:"&",isReadOnly:"&",isForm:"=?"},templateUrl:"../common/attributeTypes/views/attributeInformation.html",restrict:"E",controller:function(e,t){e.getAutoCompleteList=e.getAutoCompleteList(),e.getDataResults=e.getDataResults(),e.isAutoComplete=e.isAutoComplete()||function(){return!1},e.isReadOnly=e.isReadOnly()||function(){return!1},e.handleUpdate=e.handleUpdate()||function(){return!1},e.appendConceptNameToModel=function(t){var n=e.targetModel[t.name],r=_.find(t.answers,function(e){return e.conceptId===n.conceptUuid});n.value=r&&r.fullySpecifiedName},e.getTranslatedAttributeTypes=function(e){return Bahmni.Common.Util.TranslationUtil.translateAttribute(e,Bahmni.Common.Constants.patientAttribute,t)}}}}]),angular.module("bahmni.common.photoCapture",[]),angular.module("bahmni.common.photoCapture").directive("capturePhoto",["$parse","$window",function(e,t){return{templateUrl:"../common/photo-capture/views/photo.html",restrict:"A",scope:!0,link:function(n,r,i){var o,a=r.find(".photoCaptureDialog"),s=a.find("video")[0],u=a.find("canvas")[0],c=u.getContext("2d"),l=a.find(".confirmImage"),m=r.find(".photoUploadDialog"),f=m.find("canvas")[0],p=f.getContext("2d"),d=m.find(".confirmImage"),h=r.find(".fileUpload")[0],g=!1,v=window.devicePixelRatio;c.scale(v,v),p.scale(v,v);var b=function(t,r){var o=t.toDataURL("image/jpeg"),a=function(t){e(i.ngModel).assign(n,t),r.dialog("close")};i.capturePhoto?n[i.capturePhoto](o).then(function(){a(o)},function(){alert("Failed to save image. Please try again later")}):a(o)},y=function(e,t,n,r,i){var o,a,s,u=0,c=0;e.width>e.height?(o=r/e.width,a=r,s=Math.floor(e.height*o),c=Math.floor((i-s)/2)):(o=i/e.height,a=Math.floor(e.width*o),s=i,u=Math.floor((r-a)/2));var l=Math.floor(e.width/v),m=Math.floor(e.height/v);t.drawImage(n,u,c,a,s,0,0,l,m)};n.launchPhotoCapturePopup=function(){if(g)alert("Please allow access to web camera and wait for photo capture dialog to be launched");else{g=!0;var e=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;navigator.mediaDevices?navigator.mediaDevices.getUserMedia({video:!0,audio:!1}).then(function(e){s.srcObject=e,o=e,a.dialog("open")}).catch(function(e){alert("Could not get access to web camera. Please allow access to web camera")}):e?e({video:!0,audio:!1},function(e){s.src=t.URL.createObjectURL(e),o=e,a.dialog("open")},function(){alert("Could not get access to web camera. Please allow access to web camera")}):alert("Photo capture is not supported in your browser. Please use chrome")}},n.captureConfirmImage=function(){b(u,a)},n.captureClickImage=function(){y(u,c,s,s.videoWidth,s.videoHeight),l.prop("disabled",!1),l.focus()},a.dialog({autoOpen:!1,height:300,width:500,modal:!0,close:function(){if(g=!1,o){var e=o.getTracks();e&&e[0].stop()}}}),n.uploadConfirmImage=function(){b(f,m)},n.launchPhotoUploadPopup=function(){return g?void alert("Please wait for photo upload dialog to be launched"):(g=!0,void m.dialog("open"))},n.uploadImage=function(){if(this.files&&this.files[0]){var e=new FileReader;e.onload=function(e){var t=new Image;t.onload=function(){y(f,p,t,t.width,t.height)},t.src=e.target.result},e.readAsDataURL(this.files[0])}d.prop("disabled",!1),d.focus()},m.dialog({autoOpen:!1,height:350,width:350,modal:!0,close:function(){g=!1}}),r.bind("$destroy",function(){a.dialog("destroy"),m.dialog("destroy")}),h.addEventListener("change",n.uploadImage,!1)}}}]),(Bahmni=Bahmni||{}).Auth=Bahmni.Auth||{},angular.module("authentication",["ui.router"]),Bahmni.Auth.User=function(e){angular.extend(this,e),this.userProperties=e.userProperties||{},this.favouriteObsTemplates=this.userProperties.favouriteObsTemplates?this.userProperties.favouriteObsTemplates.split("###"):[],this.favouriteWards=this.userProperties.favouriteWards?this.userProperties.favouriteWards.split("###"):[],this.recentlyViewedPatients=this.userProperties.recentlyViewedPatients?JSON.parse(this.userProperties.recentlyViewedPatients):[],this.toContract=function(){var e=angular.copy(this);return e.userProperties.favouriteObsTemplates=this.favouriteObsTemplates.join("###"),e.userProperties.favouriteWards=this.favouriteWards.join("###"),e.userProperties.recentlyViewedPatients=JSON.stringify(this.recentlyViewedPatients),delete e.favouriteObsTemplates,delete e.favouriteWards,delete e.recentlyViewedPatients,e},this.addDefaultLocale=function(e){this.userProperties.defaultLocale=e},this.addToRecentlyViewed=function(e,t){_.some(this.recentlyViewedPatients,{uuid:e.uuid})||(this.recentlyViewedPatients.unshift({uuid:e.uuid,name:e.name,identifier:e.identifier}),_.size(this.recentlyViewedPatients)>=t&&(this.recentlyViewedPatients=_.take(this.recentlyViewedPatients,t)))},this.isFavouriteObsTemplate=function(e){return _.includes(this.favouriteObsTemplates,e)},this.toggleFavoriteObsTemplate=function(e){this.isFavouriteObsTemplate(e)?this.favouriteObsTemplates=_.without(this.favouriteObsTemplates,e):this.favouriteObsTemplates.push(e)},this.isFavouriteWard=function(e){return _.includes(this.favouriteWards,e)},this.toggleFavoriteWard=function(e){this.isFavouriteWard(e)?this.favouriteWards=_.without(this.favouriteWards,e):this.favouriteWards.push(e)}},angular.module("authentication").service("userService",["$rootScope","$http","$q",function(e,t,n){this.getUser=function(e){var r=n.defer();return function(e){return t.get(Bahmni.Common.Constants.userUrl,{method:"GET",params:{username:e,v:"custom:(username,uuid,person:(uuid,),privileges:(name,retired),userProperties)"},cache:!1})}(e).success(function(e){r.resolve(e)}).error(function(){r.reject("Unable to get user data")}),r.promise},this.savePreferences=function(){var r=n.defer(),i=e.currentUser.toContract();return t.post(Bahmni.Common.Constants.userUrl+"/"+i.uuid,{uuid:i.uuid,userProperties:i.userProperties},{withCredentials:!0}).then(function(t){e.currentUser.userProperties=t.data.userProperties,r.resolve()}),r.promise};this.getProviderForUser=function(e){var r=n.defer();return function(e){return t.get(Bahmni.Common.Constants.providerUrl,{method:"GET",params:{user:e},cache:!1})}(e).success(function(e){if(e.results.length>0){var t=e.results[0].display.split("-")[1];e.results[0].name=t?t.trim():t,r.resolve(e)}else r.reject("UNABLE_TO_GET_PROVIDER_DATA")}).error(function(){r.reject("UNABLE_TO_GET_PROVIDER_DATA")}),r.promise},this.getPasswordPolicies=function(){return t.get(Bahmni.Common.Constants.passwordPolicyUrl,{method:"GET",withCredentials:!0})},this.allowedDomains=function(e){var r=n.defer();return t.get(Bahmni.Common.Constants.loginConfig,{method:"GET",cache:!0}).success(function(e){r.resolve(e.whiteListedDomains)}).error(function(){r.resolve([])}),r.promise}}]),angular.module("authentication").config(["$httpProvider",function(e){e.interceptors.push(["$rootScope","$q",function(e,t){return{response:function(e){return e},responseError:function(n){return 401===n.status&&e.$broadcast("event:auth-loginRequired"),t.reject(n)}}}])}]).run(["$rootScope","$window","$timeout",function(e,t,n){e.$on("event:auth-loginRequired",function(){n(function(){t.location="../home/index.html#/login"})})}]).service("sessionService",["$rootScope","$http","$q","$bahmniCookieStore","userService",function(e,t,n,r,i){var o=Bahmni.Common.Constants.RESTWS_V1+"/session?v=custom:(uuid)";this.resendOTP=function(e,n){var r=e+":"+n;return t.get(o+"&resendOTP=true",{headers:{Authorization:"Basic "+window.btoa(r)},cache:!1})};var a=function(e,r,i){var a=n.defer();return u().success(function(){(function(e,n,r){var i=r?e+":"+n+":"+r:e+":"+n;return t.get(o,{headers:{Authorization:"Basic "+window.btoa(i)},cache:!1})})(e,r,i).then(function(e){204==e.status&&a.resolve({firstFactAuthorization:!0}),a.resolve(e.data)},function(e){401==e.status?a.reject("LOGIN_LABEL_WRONG_OTP_MESSAGE_KEY"):410==e.status?a.reject("LOGIN_LABEL_OTP_EXPIRED"):429==e.status&&a.reject("LOGIN_LABEL_MAX_FAILED_ATTEMPTS"),a.reject("LOGIN_LABEL_LOGIN_ERROR_MESSAGE_KEY")})}).error(function(){a.reject("LOGIN_LABEL_LOGIN_ERROR_MESSAGE_KEY")}),a.promise},s=this,u=function(){return t.delete(o)};this.destroy=function(){var t=n.defer();return u().then(function(){$.cookie(Bahmni.Common.Constants.currentUser,null,{path:"/"}),$.cookie(Bahmni.Common.Constants.currentUser,null,{path:"/"}),$.cookie(Bahmni.Common.Constants.retrospectiveEntryEncounterDateCookieName,null,{path:"/"}),$.cookie(Bahmni.Common.Constants.grantProviderAccessDataCookieName,null,{path:"/"}),e.currentUser=void 0,t.resolve()}),t.promise},this.loginUser=function(e,t,i,o){var s=n.defer();return a(e,t,o).then(function(t){t.authenticated?(r.put(Bahmni.Common.Constants.currentUser,e,{path:"/",expires:7}),null!=i&&(r.remove(Bahmni.Common.Constants.locationCookieName),r.put(Bahmni.Common.Constants.locationCookieName,{name:i.display,uuid:i.uuid},{path:"/",expires:7})),s.resolve(t)):t.firstFactAuthorization?s.resolve(t):s.reject("LOGIN_LABEL_LOGIN_ERROR_MESSAGE_KEY")},function(e){s.reject(e)}),s.promise},this.get=function(){return t.get(o,{cache:!1})},this.loadCredentials=function(){var t=n.defer(),o=r.get(Bahmni.Common.Constants.currentUser);return o?(i.getUser(o).then(function(n){i.getProviderForUser(n.results[0].uuid).then(function(i){!_.isEmpty(i.results)&&function(e){return _.filter(e,function(e){return null==e.retired||"false"==e.retired}).length>0}(i.results)?(e.currentUser=new Bahmni.Auth.User(n.results[0]),e.currentUser.currentLocation=r.get(Bahmni.Common.Constants.locationCookieName).name,e.$broadcast("event:user-credentialsLoaded",n.results[0]),t.resolve(n.results[0])):(s.destroy(),t.reject("YOU_HAVE_NOT_BEEN_SETUP_PROVIDER"))},function(){s.destroy(),t.reject("COULD_NOT_GET_PROVIDER")})},function(){s.destroy(),t.reject("Could not get roles for the current user.")}),t.promise):(this.destroy().finally(function(){e.$broadcast("event:auth-loginRequired"),t.reject("No User in session. Please login again.")}),t.promise)},this.getLoginLocationUuid=function(){return r.get(Bahmni.Common.Constants.locationCookieName)?r.get(Bahmni.Common.Constants.locationCookieName).uuid:null},this.changePassword=function(e,n,r){return t({method:"POST",url:Bahmni.Common.Constants.passwordUrl,data:{oldPassword:n,newPassword:r},headers:{"Content-Type":"application/json"}})},this.loadProviders=function(n){return t.get(Bahmni.Common.Constants.providerUrl,{method:"GET",params:{user:n.uuid},cache:!1}).success(function(t){var n=t.results.length>0?t.results[0].uuid:void 0;e.currentProvider={uuid:n}})}}]).factory("authenticator",["$rootScope","$q","$window","sessionService",function(e,t,n,r){return{authenticateUser:function(){var n=t.defer();return r.get().then(function(t){t.data.authenticated?n.resolve():(n.reject("User not authenticated"),e.$broadcast("event:auth-loginRequired"))}),n.promise}}}]).directive("logOut",["sessionService","$window","configurationService","auditLogService",function(e,t,n,r){return{link:function(n,i){i.bind("click",function(){n.$apply(function(){r.log(void 0,"USER_LOGOUT_SUCCESS",void 0,"MODULE_LABEL_LOGOUT_KEY").then(function(){e.destroy().then(function(){t.location="../home/index.html#/login"})})})})}}}]).directive("btnUserInfo",[function(){return{restrict:"CA",link:function(e,t){t.bind("click",function(e){$(this).next().toggleClass("active"),e.stopPropagation()}),$(document).find("body").bind("click",function(){$(t).next().removeClass("active")})}}}]),angular.module("bahmni.common.appFramework",["authentication"]),(Bahmni=Bahmni||{}).Common=Bahmni.Common||{},Bahmni.Common.AppFramework=Bahmni.Common.AppFramework||{},Bahmni.Common.AppFramework.AppDescriptor=function(e,t,n,r){this.id=null,this.instanceOf=null,this.description=null,this.contextModel=null,this.baseExtensionPoints=[],this.customExtensionPoints=[],this.baseExtensions={},this.customExtensions={},this.customConfigs={},this.baseConfigs={},this.extensionPath=e,this.contextPath=t?e.split("/")[0]:e;var i=this,o=function(e,t){_.values(e).forEach(function(e){e&&(0===i[t].filter(function(t){return t.id===e.extensionPointId}).length&&i[t].push({id:e.extensionPointId,description:e.description}))})};this.setExtensions=function(e,t){t&&(o(t,"customExtensionPoints"),i.customExtensions=t),i.baseExtensions=e,o(e,"baseExtensionPoints")},this.setTemplate=function(e){i.instanceOf=e.id,i.description=i.description||e.description,i.contextModel=i.contextModel||e.contextModel,e.configOptions&&_.values(e.configOptions).forEach(function(e){var t=i.configs.filter(function(t){return t.name===e.name});t.length>0?t[0].description=e.description:i.configs.push({name:e.name,description:e.description,value:e.defaultValue})})};var a=function(e,t){for(var n in e.config){var r=c(i[t],n);r?r.value=e.config[n]:i[t][n]={name:n,value:e.config[n]}}},s=function(e,t){e&&e.forEach(function(e){e&&(0===i[t].filter(function(t){return t.id===e.id}).length&&i[t].push(e))})};this.setDefinition=function(e,t){i.instanceOf=t&&t.instanceOf?t.instanceOf:e.instanceOf,i.id=t&&t.id?t.id:e.id,i.description=t&&t.description?t.description:e.description,i.contextModel=t&&t.contextModel?t.contextModel:e.contextModel,s(e.extensionPoints,"baseExtensionPoints"),a(e,"baseConfigs"),t&&(s(t.extensionPoints,"customExtensionPoints"),a(t,"customConfigs"))};var u=function(e,t,r){var i=n(),o=_.values(r);if(i&&o){var a=t||"all",s=i.privileges.map(function(e){return e.retired?"":e.name}),u=o.filter(function(t){return("all"===a||t.type===a)&&t.extensionPointId===e&&(!t.requiredPrivilege||s.indexOf(t.requiredPrivilege)>=0)});return u.sort(function(e,t){return e.order-t.order}),u}};this.getExtensions=function(e,t,n){if(n||void 0===n){var o=r.merge(i.baseExtensions,i.customExtensions);return u(e,t,o)}return[u(e,t,i.baseExtensions),u(e,t,i.customExtensions)]},this.getExtensionById=function(e,t){return t||void 0===t?_.values(r.merge(i.baseExtensions,i.customExtensions)).filter(function(t){return t.id===e})[0]:[i.baseExtensions.filter(function(t){return t.id===e})[0],i.customExtensions.filter(function(t){return t.id===e})[0]]};var c=function(e,t){var n=_.values(e).filter(function(e){return e.name===t});return n.length>0?n[0]:null};this.getConfig=function(e,t){return t||void 0===t?c(r.merge(i.baseConfigs,i.customConfigs),e):[c(i.baseConfigs,e),c(i.customConfigs,e)]},this.getConfigValue=function(e,t){var n=this.getConfig(e,t);return t||void 0===t?n?n.value:null:n},this.formatUrl=function(e,t,n){var r=e.match(/{{([^}]*)}}/g),i=e,o=n||!1,a=this.parseQueryParams();return r&&r.forEach(function(e){var n=e.replace("{{","").replace("}}",""),r=t[n];r||!0!==o||(r=a[n]||null),i=i.replace(e,r)}),i.trim()},this.parseQueryParams=function(e){var t,n,r=/\+/g,i=/([^&=]+)=?([^&]*)/g,o=function(e){return decodeURIComponent(e.replace(r," "))},a=e||window.location.search.substring(1);for(t={};n=i.exec(a);)t[o(n[1])]=o(n[2]);return t},this.addConfigForPage=function(e,t,n){i.basePageConfigs=i.basePageConfigs||{},i.basePageConfigs[e]=t,i.customPageConfigs=i.customPageConfigs||{},i.customPageConfigs[e]=n},this.getConfigForPage=function(e,t){return t||void 0===t?r.merge(i.basePageConfigs[e],i.customPageConfigs[e]):[_.values(i.basePageConfigs[e]),_.values(i.customPageConfigs[e])]}},angular.module("bahmni.common.appFramework").config(["$compileProvider",function(e){e.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|chrome-extension|file):/)}]).service("appService",["$http","$q","sessionService","$rootScope","mergeService","loadConfigService","messagingService","$translate",function(e,t,n,r,i,o,a,s){var u=null,c=Bahmni.Common.Constants.baseUrl,l=Bahmni.Common.Constants.customUrl,m=null;r.meetId=null;var f=function(e){return o.loadConfig(e,m.contextPath)},p=function(e,t){t&&(_.keys(e).length>0||_.keys(t.length>0))?m.setDefinition(e,t):_.keys(e).length>0&&m.setDefinition(e)},d=function(e,t){t?m.setExtensions(e,t):m.setExtensions(e)},h=function(e,t,n){n&&(_.keys(n).length>0||_.keys(t).length>0)?m.addConfigForPage(e,t,n):_.keys(t).length>0&&m.addConfigForPage(e,t)};this.getAppDescriptor=function(){return m},this.configBaseUrl=function(){return c},this.loadCsvFileFromConfig=function(e){return f(c+m.contextPath+"/"+e)},this.loadConfig=function(e,t){return f(c+m.contextPath+"/"+e).then(function(n){return n.data.shouldOverRideConfig?f(l+m.contextPath+"/"+e).then(function(e){return t||void 0===t?i.merge(n.data,e.data):[n.data,e.data]},function(){return n.data}):n.data})},this.loadMandatoryConfig=function(t){return e.get(t)},this.getAppName=function(){return this.appName},this.checkPrivilege=function(e){return function(e){return _.some(u.privileges,{name:e})}(e)?t.when(!0):(a.showMessage("error",s.instant(Bahmni.Common.Constants.privilegeRequiredErrorMessage)+" [Privileges required: "+e+"]"),t.reject())},this.initApp=function(e,o,g,v){this.appName=e;var b=t.defer(),y=g&&"default"!==g.toLowerCase()?"/extension-"+g+".json":"/extension.json",C=[],S=o||{app:!0,extension:!0},T=!S.inherit||S.inherit;m=new Bahmni.Common.AppFramework.AppDescriptor(e,T,function(){return u},i);var E=n.loadCredentials(),A=E.then(n.loadProviders);return C.push(E),C.push(A),S.extension&&C.push(function(e,n){var r=t.defer();return f(c+e.extensionPath+n).then(function(t){t.data.shouldOverRideConfig?f(l+e.extensionPath+n).then(function(n){d(t.data,n.data),r.resolve(e)},function(){d(t.data),r.resolve(e)}):(d(t.data),r.resolve(e))},function(t){404!==t.status?r.reject(t):r.resolve(e)}),r.promise}(m,y)),S.template&&C.push(function(e){var n=t.defer();return f(c+e.contextPath+"/appTemplate.json").then(function(t){_.keys(t.data).length>0&&e.setTemplate(t.data),n.resolve(e)},function(t){404!==t.status?n.reject(t):n.resolve(e)}),n.promise}(m)),S.app&&C.push(function(e){var n=t.defer();return f(c+e.contextPath+"/app.json").then(function(t){t.data.shouldOverRideConfig?f(l+e.contextPath+"/app.json").then(function(r){p(t.data,r.data),n.resolve(e)},function(){p(t.data),n.resolve(e)}):(p(t.data),n.resolve(e))},function(t){404!==t.status?n.reject(t):n.resolve(e)}),n.promise}(m)),_.isEmpty(v)||v.forEach(function(e){C.push(function(e,n){var r=t.defer();return f(c+n.contextPath+"/"+e+".json").then(function(t){t.data.shouldOverRideConfig?f(l+n.contextPath+"/"+e+".json").then(function(i){h(e,t.data,i.data),r.resolve(n)},function(){h(e,t.data),r.resolve(n)}):(h(e,t.data),r.resolve(n))},function(e){404!==e.status?(a.showMessage("error",s.instance("INCORRECT_CONFIGURATION_MESSAGE",{error:e.message})),r.reject(e)):r.resolve(n)}),r.promise}(e,m))}),t.all(C).then(function(e){u=e[0],b.resolve(m),r.$broadcast("event:appExtensions-loaded")},function(e){b.reject(e)}),b.promise}}]),angular.module("bahmni.common.appFramework").service("mergeService",[function(){this.merge=function(t,n){var r=$.extend(!0,{},t,n);return e(r)};var e=function(t){return _.forOwn(t,function(n,r){(_.isUndefined(n)||_.isNull(n)||_.isNaN(n)||_.isObject(n)&&_.isNull(e(n)))&&delete t[r]}),t}}]),angular.module("bahmni.common.patient",[]),angular.module("bahmni.common.patient").filter("age",function(){return function(e){return e.years?e.years+" y":e.months?e.months+" m":e.days+" d"}}),(Bahmni=Bahmni||{}).ConceptSet=Bahmni.ConceptSet||{},Bahmni.ConceptSet.FormConditions=Bahmni.ConceptSet.FormConditions||{},angular.module("bahmni.common.conceptSet",["bahmni.common.uiHelper","ui.select2","pasvaz.bindonce","ngSanitize","ngTagsInput"]),angular.module("bahmni.common.conceptSet").controller("ConceptSetGroupController",["$scope","contextChangeHandler","spinner","messagingService","conceptSetService","$rootScope","sessionService","encounterService","treatmentConfig","retrospectiveEntryService","userService","conceptSetUiConfigService","$timeout","clinicalAppConfigService","$stateParams","$translate",function(e,t,n,r,i,o,a,s,u,c,l,m,f,p,d,h){var g=m.getConfig();e.toggleSideBar=function(){o.showLeftpanelToggle=!o.showLeftpanelToggle},e.showLeftpanelToggle=function(){return o.showLeftpanelToggle},e.togglePref=function(e,t){o.currentUser.toggleFavoriteObsTemplate(t),n.forPromise(l.savePreferences())},e.getNormalized=function(e){return e.replace(/['\.\s\(\)\/,\\]+/g,"_")},e.showPreviousButton=function(e){return g[e]&&g[e].showPreviousButton},e.showPrevious=function(t,n){n.stopPropagation(),f(function(){e.$broadcast("event:showPrevious"+t)})},e.isInEditEncounterMode=function(){return void 0!==d.encounterUuid&&"active"!==d.encounterUuid},e.computeField=function(t,r){r.stopPropagation(),e.consultation.preSaveHandler.fire();var o=p.getVisitTypeForRetrospectiveEntries(),l=(new Bahmni.Clinical.EncounterTransactionMapper).map(angular.copy(e.consultation),e.patient,a.getLoginLocationUuid(),c.getRetrospectiveEntry(),o,e.isInEditEncounterMode());(l=s.buildEncounter(l)).drugOrders=[];var m={name:t.conceptName,uuid:t.uuid},f={encounterModifierObservations:l.observations,drugOrders:l.drugOrders,conceptSetData:m,patientUuid:l.patientUuid,encounterDateTime:l.encounterDateTime};n.forPromise(u().then(function(t){return e.treatmentConfiguration=t,i.getComputedValue(f)}).then(function(t){t=t.data,v(e.consultation.observations,t.encounterModifierObservations),e.consultation.newlyAddedTreatments=e.consultation.newlyAddedTreatments||[],t.drugOrders.forEach(function(t){e.consultation.newlyAddedTreatments.push(Bahmni.Clinical.DrugOrderViewModel.createFromContract(t,e.treatmentConfiguration))})}))},e.canRemove=function(t){var n=e.allTemplates[t].observations;return!(void 0!==n&&!_.isEmpty(n))||void 0===n[0].uuid},e.clone=function(t){var n=e.allTemplates[t].clone();e.allTemplates.splice(t+1,0,n),$.scrollTo("#concept-set-"+(t+1),200,{offset:{top:-400}})},e.clonePanelConceptSet=function(t){var n=_.findIndex(e.allTemplates,t);r.showMessage("info",h.instant("CLINICAL_TEMPLATE_ADDED_SUCCESS_KEY",{label:e.allTemplates[n].label})),e.clone(n),e.showLeftPanelConceptSet(e.allTemplates[n+1])},e.isClonedSection=function(e,t){if(t){var n=t.indexOf(e);return n>0&&t[n].label==t[n-1].label}return!1},e.isLastClonedSection=function(t){var n=_.findIndex(e.allTemplates,t);return!(!e.allTemplates||n!=e.allTemplates.length-1&&e.allTemplates[n].label==e.allTemplates[n+1].label)},e.remove=function(t){var n=e.allTemplates[t].label,i=e.allTemplates[t];if(_.find(e.allTemplates,function(e){return e.label==i.label&&e!==i}))e.allTemplates.splice(t,1);else{e.allTemplates[t].isAdded=!1;var o=e.allTemplates[t].clone();e.allTemplates[t]=o,e.allTemplates[t].isAdded=!1,e.allTemplates[t].isOpen=!1,e.allTemplates[t].klass="",e.allTemplates[t].isLoaded=!1}e.leftPanelConceptSet="",r.showMessage("info",h.instant("CLINICAL_TEMPLATE_REMOVED_SUCCESS_KEY",{label:n}))},e.openActiveForm=function(t){return t&&"active"==t.klass&&t!=e.leftPanelConceptSet&&e.showLeftPanelConceptSet(t),t.klass};var v=function(e,t){e.forEach(function(e,n){e.groupMembers&&e.groupMembers.length>0?v(e.groupMembers,t[n].groupMembers):e.value=t[n].value})};e.showLeftPanelConceptSet=function(t){var n;(n=e.leftPanelConceptSet)&&(n.klass="",n.isOpen=!1,n.isLoaded=!1),e.leftPanelConceptSet=t,e.leftPanelConceptSet.isOpen=!0,e.leftPanelConceptSet.isLoaded=!0,e.leftPanelConceptSet.klass="active",e.leftPanelConceptSet.atLeastOneValueIsSet=t.hasSomeValue(),e.leftPanelConceptSet.isAdded=!0,e.consultation.lastvisited=t.id||t.formUuid,$(window).scrollTop(0)},e.focusOnErrors=function(){var t=e.leftPanelConceptSet.errorMessage?e.leftPanelConceptSet.errorMessage:"{{'CLINICAL_FORM_ERRORS_MESSAGE_KEY' | translate }}";r.showMessage("error",t),e.$parent.$parent.$broadcast("event:errorsOnForm")},e.isFormTemplate=function(e){return e.formUuid},e.validationHandler=new Bahmni.ConceptSet.ConceptSetGroupPanelViewValidationHandler(e.allTemplates),t.add(e.validationHandler.validate)}]).directive("conceptSetGroup",function(){return{restrict:"EA",scope:{conceptSetGroupExtensionId:"=?",observations:"=",allTemplates:"=",context:"=",autoScrollEnabled:"=",patient:"=",consultation:"="},controller:"ConceptSetGroupController",templateUrl:"../common/concept-set/views/conceptSetGroup.html"}}),angular.module("bahmni.common.conceptSet").directive("conceptSet",["contextChangeHandler","appService","observationsService","messagingService","conceptSetService","conceptSetUiConfigService","spinner",function(e,t,n,r,i,o,a){return{restrict:"E",scope:{conceptSetName:"=",observations:"=?",required:"=?",showTitle:"&",validationHandler:"&",patient:"=",conceptSetFocused:"=?",collapseInnerSections:"=?",atLeastOneValueIsSet:"=?",sectionId:"="},templateUrl:"../common/concept-set/views/conceptSet.html",controller:function(s){var u=s.conceptSetName,c=Bahmni.Common.Obs.ObservationUtil,l=o.getConfig(),m=new Bahmni.ConceptSet.ObservationMapper,f=s.validationHandler()||e,p="#"+s.sectionId;s.atLeastOneValueIsSet=s.atLeastOneValueIsSet||!1,s.conceptSetRequired=!1,s.showTitleValue=s.showTitle(),s.numberOfVisits=l[u]&&l[u].numberOfVisits?l[u].numberOfVisits:null,s.hideAbnormalButton=l[u]&&l[u].hideAbnormalButton;var d=function(){return _.filter(s.observations,function(e){return _.toLower(e.conceptSetName)===_.toLower(s.rootObservation.concept.name)})},h=function(e,t){t&&_.each(e,function(e){var n=e.concept.name;_.includes(_.keys(t),n)&&null==e.value&&("Coded"==e.concept.dataType?g(e,t):e.value=t[n]),e.groupMembers&&e.groupMembers.length>0&&(h(e.groupMembers,t),e instanceof Bahmni.ConceptSet.ObservationNode&&t[e.label]&&e.abnormalObs&&null==e.abnormalObs.value&&e.onValueChanged(e.value))})},g=function(e,t){var n=function(e,t){var n,r=t.possibleAnswers,i=e[t.concept.name];return i instanceof Array?(n=[],_.each(i,function(e){n.push(_.find(r,{displayString:e}))})):n=_.find(r,{displayString:i}),n}(t,e);e.isMultiSelect?e.hasValue()||_.each(n,function(t){e.selectAnswer(t)}):n instanceof Array||(e.value=n)},v=function(e,t,n,r){_.isEmpty(e)||_.each(e,function(e){e.disabled=t||r,e.error=n,e.hide=r,(r||e.disabled)&&function(e){if(e.comment=void 0,e.value||e.isBoolean)e.value=void 0;else if(e.isMultiSelect)for(var t in e.selectedObs)e.selectedObs[t].voided||e.toggleSelection(e.selectedObs[t].value)}(e),e.groupMembers&&_.each(e.groupMembers,function(e){e&&v([e],t,n,r)})})},b=function(e,t,n,i,o){_.each(t,function(t){var a,s=[];e.forEach(function(e){0!=a&&e.concept.name==t?(s.push(e),a=!0):a&&e.concept.name!=t&&(a=!1)}),_.isEmpty(s)?r.showMessage("error","No element found with name : "+t):v(s,n,i,o)})},y=function(e,t,n,i,o){var a=function(e){return _.reduce(e,function(e,t){if(null==e[t.concept.name+"|"+t.uniqueId])if(t.isMultiSelect){var n=[];_.each(t.selectedObs,function(e){e.voided||n.push(e.value.name),e.voided||n.push(e.value.name)}),e[t.concept.name+"|"+t.uniqueId]=n}else if(t.conceptUIConfig.multiSelect){var r=[];_.each(_.keys(e),function(e){e.split("|")[0]==t.concept.name&&r.push(e)}),r.length<2&&(e[t.concept.name+"|"+t.uniqueId]=e[t.concept.name+"|undefined"])}else t.value instanceof Object?e[t.concept.name+"|"+t.uniqueId]=t.value.name instanceof Object?t.value.name.name:t.value.name:e[t.concept.name+"|"+t.uniqueId]=t.value;return e},{})}(o);_.each(_.keys(a),function(u){if(u.split("|")[0]==i&&"undefined"!=u.split("|")[1]){var c=_.reduce(a,function(e,t,n){return e[n.split("|")[0]]=t,e},{}),l=n(t,c,s.patient);_.isUndefined(l)||(l.error&&!_.isEmpty(l.error)?(r.showMessage("error",l.error),b(o,[i],!1,!0,!1)):e&&b(o,[i],!1,!1,!1),b(o,l.disable,!0),b(o,l.enable,!1),b(o,l.show,!1,void 0,!1),b(o,l.hide,!1,void 0,!0),_.each(l.enable,function(e){var n=Bahmni.ConceptSet.FormConditions.rules&&Bahmni.ConceptSet.FormConditions.rules[e];null!=n&&y(!0,t,n,e,o)}),_.each(l.disable,function(e){var n=Bahmni.ConceptSet.FormConditions.rules&&Bahmni.ConceptSet.FormConditions.rules[e];null!=n&&_.each(o,function(r){r.concept.name==e&&y(!1,t,n,e,o)})}),_.each(l.show,function(e){var n=Bahmni.ConceptSet.FormConditions.rules&&Bahmni.ConceptSet.FormConditions.rules[e];n&&y(!0,t,n,e,o)}),_.each(l.hide,function(e){var n=Bahmni.ConceptSet.FormConditions.rules&&Bahmni.ConceptSet.FormConditions.rules[e];n&&_.each(o,function(r){r.concept.name==e&&y(!1,t,n,e,o)})}))}})},C=function(e,t){Bahmni.ConceptSet.FormConditions.rules&&S(t.concept.name,t)},S=function(e,t){_.each(t.groupMembers,function(n){var r=Bahmni.ConceptSet.FormConditions.rules&&Bahmni.ConceptSet.FormConditions.rules[n.concept.name];if(null!=r){var i=c.flattenObsToArray([t]);y(!1,e,r,n.concept.name,i)}n.groupMembers&&n.groupMembers.length>0&&S(e,n)})},T=function(e,t){_.each(e.groupMembers,function(t){T(t,e)}),"image"===e.getControlType()&&e.value&&t.groupMembers.indexOf(e)===t.groupMembers.length-1&&t.groupMembers.push(e.cloneNew())};a.forPromise(i.getConcept({name:u,v:"bahmni"}).then(function(e){if(s.conceptSet=e.data.results[0],s.rootObservation=s.conceptSet?m.map(s.observations,s.conceptSet,l):null,s.rootObservation){s.rootObservation.conceptSetName=s.conceptSetName,function(){if(s.conceptSetFocused&&s.rootObservation.groupMembers&&s.rootObservation.groupMembers.length>0){var e=_.find(s.rootObservation.groupMembers,function(e){return e.isFormElement&&e.isFormElement()});e&&(e.isFocused=!0)}}(),function(){if(s.rootObservation){for(var e=0;e<s.observations.length;e++)if(s.observations[e].concept.uuid===s.rootObservation.concept.uuid)return void(s.observations[e]=s.rootObservation);s.observations.push(s.rootObservation)}}();var n=d()[0].groupMembers,r=function(){var e=t.getAppDescriptor().getConfigValue("conceptSetUI");if(e&&e.defaults)return e.defaults||{}}();_.each(s.rootObservation.groupMembers,function(e){T(e,s.rootObservation)}),h(n,r),d(),C(0,s.rootObservation)}else s.showEmptyConceptSetMessage=!0}).catch(function(e){r.showMessage("error",e.message)}),p);var E=function(e,t){var n=null,r=e.some(function(e){if(e.voided)return!1;var r=e.groupMembers||[];for(var i in r){var o=r[i].groupMembers&&r[i].groupMembers.length?E(r[i].groupMembers,r[i]):A(r[i],e);if(o.status)return n=o.message,!0}return(o=A(e,t)).status?(n=o.message,!0):!e.isValid(s.atLeastOneValueIsSet,s.conceptSetRequired)});return{message:n,status:r}},A=function(e,t){if(e.possibleAnswers&&!e.possibleAnswers.length){if("function"==typeof e.isValueInAbsoluteRange&&!e.isValueInAbsoluteRange())return{message:"The value you entered (red field) is outside the range of allowable values for that record. Please check the value.",status:!0};if(e.isNumeric()){if(!e.isValidNumeric())return{message:"Please enter Integer value, decimal value is not allowed",status:!0};if(t){if(!e.isValidNumericValue()||!t.isValidNumericValue())return{message:"Please enter Numeric values",status:!0}}else if(!e.isValidNumericValue())return{message:"Please enter Numeric values",status:!0}}}return{status:!1}};f.add(function(){if(void 0===s.rootObservation||null===s.rootObservation)return{allow:!0,errorMessage:null};s.atLeastOneValueIsSet=s.rootObservation&&s.rootObservation.atLeastOneValueSet(),s.conceptSetRequired=!s.required||s.required;var e=s.rootObservation&&E(s.rootObservation.groupMembers,s.rootObservation);return{allow:!e.status,errorMessage:e.message}});var D=s.$on("event:showPrevious"+u,function(){return a.forPromise(n.fetch(s.patient.uuid,s.conceptSetName,null,s.numberOfVisits,null,!0),p).then(function(e){var t=c.flattenObsToArray(e.data),n=s.observations.filter(function(e){return e.conceptSetName===s.conceptSetName});c.flattenObsToArray(n).forEach(function(e){var n=_.filter(t,function(t){return e.concept.uuid===t.concept.uuid});null!=n&&n.length>0&&(n.sort(function(e,t){return new Date(t.encounterDateTime)-new Date(e.encounterDateTime)}),e.previous=n.map(function(e){return{value:Bahmni.Common.Domain.ObservationValueMapper.map(e),date:e.observationDateTime}}))})})}),w=s.$root.$on("event:addMore",function(e,t){C(0,t)}),O=s.$root.$on("event:observationUpdated-"+u,function(e,t,n){var r=n.concept.name,i=Bahmni.ConceptSet.FormConditions.rules&&Bahmni.ConceptSet.FormConditions.rules[t];if(i){var o=c.flattenObsToArray([n]);y(!0,r,i,t,o)}});s.$on("$destroy",function(){O(),w(),D()})}}}]),angular.module("bahmni.common.conceptSet").directive("formControls",["formService","spinner","$timeout","$translate",function(e,t,n,r){var i={},o={},a=function(e){angular.element(document.getElementById(e)).on("$destroy",function(){unMountForm(document.getElementById(e))})};return{restrict:"E",scope:{form:"=",patient:"=",validateForm:"="},controller:function(s){var u=s.form.formUuid,c=s.form.formVersion,l=s.form.formName,m=s.form.observations,f=s.form.collapseInnerSections&&s.form.collapseInnerSections.value,p=s.validateForm||!1,d=r.use();i[u]?n(function(){s.form.events=i[u].events,s.form.component=renderWithControls(i[u],m,u,f,s.patient,p,d,o[u]),a(s.form.formUuid)},0,!1):t.forPromise(e.getFormDetail(u,{v:"custom:(resources:(value))"}).then(function(n){var r=_.get(n,"data.resources[0].value");if(r){var h=JSON.parse(r);h.version=c,i[u]=h;var g={formName:l,formVersion:c,locale:d,formUuid:u};s.form.events=h.events,t.forPromise(e.getFormTranslations(h.translationsUrl,g).then(function(e){var t=_.isEmpty(e.data)?{}:e.data[0];o[u]=t,s.form.component=renderWithControls(h,m,u,f,s.patient,p,d,t)},function(){var e={};o[u]=e,s.form.component=renderWithControls(h,m,u,f,s.patient,p,d,e)}))}a(s.form.formUuid)})),s.$watch("form.collapseInnerSections",function(){var e=s.form.collapseInnerSections&&s.form.collapseInnerSections.value;i[u]&&(s.form.component=renderWithControls(i[u],m,u,e,s.patient,p,d,o[u]))}),s.$on("$destroy",function(){if(s.$parent.consultation&&s.$parent.consultation.observationForms&&s.form.component){var e=s.form.component.getValue();s.form.observations=e.observations;var t=e.errors;_.isEmpty(t)||(s.form.isValid=!1)}})}}}]),angular.module("bahmni.common.conceptSet").directive("concept",["RecursionHelper","spinner","$filter","messagingService","$rootScope","$translate",function(e,t,n,r,i,o){var a=function(e){var t=e.observation&&e.observation.conceptUIConfig&&e.observation.conceptUIConfig.hideAbnormalButton;e.now=moment().format("YYYY-MM-DD hh:mm:ss"),e.showTitle=void 0===e.showTitle||e.showTitle,e.hideAbnormalButton=null==t?e.hideAbnormalButton:t,e.cloneNew=function(t,n){t.showAddMoreButton=function(){return!1};var i=t.cloneNew();i.scrollToElement=!0;var a=n.groupMembers.indexOf(t);n.groupMembers.splice(a+1,0,i),r.showMessage("info",o.instant("NEW_KEY")+" "+t.label+" "+o.instant("SECTION_ADDED_KEY")),e.$root.$broadcast("event:addMore",i)},e.removeClonedObs=function(e,t){e.voided=!0,_.findLast(t.groupMembers,function(t){return t.label===e.label&&!t.voided}).showAddMoreButton=function(){return!0},e.hidden=!0},e.isClone=function(e,t){if(t&&t.groupMembers){var n=t.groupMembers.indexOf(e);return n>0&&t.groupMembers[n].label==t.groupMembers[n-1].label}return!1},e.isRemoveValid=function(e){return"image"!=e.getControlType()||!e.value},e.getStringValue=function(e){return e.map(function(e){return e.value+" ("+n("bahmniDate")(e.date)+")"}).join(", ")},e.toggleSection=function(){e.collapse=!e.collapse},e.isCollapsibleSet=function(){return 1==e.showTitle},e.hasPDFAsValue=function(){return e.observation.value&&e.observation.value.indexOf(".pdf")>0},e.$watch("collapseInnerSections",function(){e.collapse=e.collapseInnerSections&&e.collapseInnerSections.value}),e.handleUpdate=function(){e.$root.$broadcast("event:observationUpdated-"+e.conceptSetName,e.observation.concept.name,e.rootObservation)},e.update=function(t){e.getBooleanResult(e.observation.isObservationNode)?e.observation.primaryObs.value=t:e.getBooleanResult(e.observation.isFormElement())&&(e.observation.value=t),e.handleUpdate()},e.getBooleanResult=function(e){return!!e},e.translatedLabel=function(e){if(e&&e.concept){var t=i.currentUser.userProperties.defaultLocale,n=e.concept.names?e.concept.names:[],r=n.find(function(e){return e.locale===t&&"SHORT"===e.conceptNameType});if(r)return r.name;var o=n.find(function(e){return e.locale===t&&"FULLY_SPECIFIED"===e.conceptNameType});return o?o.name:e.concept.shortName||e.concept.name}return e?e.label:"UNKNOWN_OBSERVATION_CONCEPT"}};return{restrict:"E",compile:function(t){return e.compile(t,a)},scope:{conceptSetName:"=",observation:"=",atLeastOneValueIsSet:"=",showTitle:"=",conceptSetRequired:"=",rootObservation:"=",patient:"=",collapseInnerSections:"=",rootConcept:"&",hideAbnormalButton:"="},templateUrl:"../common/concept-set/views/observation.html"}}]),angular.module("bahmni.common.conceptSet").directive("buttonSelect",function(){return{restrict:"E",scope:{observation:"=",abnormalObs:"=?"},link:function(e,t,n){n.dirtyCheckFlag&&(e.hasDirtyFlag=!0)},controller:function(e){e.isSet=function(t){return e.observation.hasValueOf(t)},e.select=function(t){e.observation.toggleSelection(t),e.$parent.observation&&"function"==typeof e.$parent.observation.onValueChanged&&e.$parent.observation.onValueChanged(),e.$parent.handleUpdate()},e.getAnswerDisplayName=function(e){var t=e.names?_.first(e.names.filter(function(e){return"SHORT"===e.conceptNameType})):null;return t?t.name:e.displayString}},templateUrl:"../common/concept-set/views/buttonSelect.html"}}),angular.module("bahmni.common.conceptSet").directive("stepper",function(){return{restrict:"E",require:"ngModel",replace:!0,scope:{ngModel:"=",obs:"=",ngClass:"=",focusMe:"="},template:'<div class="stepper clearfix"><button ng-click="decrement()" class="stepper__btn stepper__minus" ng-disabled="obs.disabled">-</button><input id="{{::obs.uniqueId}}" obs-constraints ng-model="ngModel" obs="::obs" ng-class="ngClass" focus-me="focusMe" type="text" class="stepper__field" ng-disabled="obs.disabled" /><button ng-click="increment()" class="stepper__btn stepper__plus"  ng-disabled="obs.disabled">+</button></div> ',link:function(e,t,n,r){function i(t){var n=0;isNaN(r.$viewValue)?null!=e.obs.concept.lowNormal&&(n=e.obs.concept.lowNormal-t):n=parseInt(r.$viewValue),r.$setViewValue(n+t)}r.$render=function(){},r.$formatters.push(function(e){return parseInt(e,10)}),r.$parsers.push(function(e){return parseInt(e,10)}),e.increment=function(){null!=e.obs.concept.hiNormal?(isNaN(r.$viewValue)?0:r.$viewValue)<e.obs.concept.hiNormal&&i(1):i(1)},e.decrement=function(){null!=e.obs.concept.lowNormal?(isNaN(r.$viewValue)?0:r.$viewValue)>e.obs.concept.lowNormal&&i(-1):i(-1)}}}}),angular.module("bahmni.common.conceptSet").directive("obsConstraints",function(){var e={Numeric:"number",Date:"date",Datetime:"datetime"};return{link:function(t,n){var r={},i=t.obs.concept;i.conceptClass==Bahmni.Common.Constants.conceptDetailsClassName&&(i=t.obs.primaryObs.concept),r.type=e[i.dataType]||"text","number"===r.type&&(r.step="any"),i.hiNormal&&(r.max=i.hiNormal),i.lowNormal&&(r.min=i.lowNormal),"date"==r.type&&(null!=t.obs.conceptUIConfig&&t.obs.conceptUIConfig.allowFutureDates||(r.max=Bahmni.Common.Util.DateTimeFormatter.getDateWithoutTime())),n.attr(r)},scope:{obs:"="},require:"ngModel"}}),angular.module("bahmni.common.conceptSet").directive("duration",["contextChangeHandler",function(e){return{restrict:"E",require:"ngModel",controller:function(e){var t=Bahmni.Common.Util.DateUtil.convertToUnits(e.hours);e.units=t.allUnits,e.measureValue=t.value,e.unitValue=t.unitValueInMinutes;var n=Object.keys(e.units).reverse();e.displayUnits=n.map(function(t){return{name:t,value:e.units[t]}})},scope:{hours:"=ngModel",illegalValue:"=",disabled:"="},link:function(t,n,r,i){var o=function(){if(t.unitValue&&t.measureValue){var e=t.unitValue*t.measureValue;i.$setViewValue(e)}else i.$setViewValue(void 0)};t.$watch("measureValue",o),t.$watch("unitValue",o),t.$watch("disabled",function(e){e&&(t.unitValue=void 0,t.measureValue=void 0,t.hours=void 0)});var a=t.$watch("illegalValue",function(n){t.illegalDurationValue=n,e.add(function(){return{allow:!t.illegalDurationValue}})});t.$on("$destroy",function(){t.illegalDurationValue=!1,a()})},template:'<span><input tabindex="1" style="float: left;" type="number" min="0" class="duration-value" ng-class="{\'illegalValue\': illegalValue}" ng-model=\'measureValue\' ng-disabled="disabled"/></span><span><select tabindex="1" ng-model=\'unitValue\' class="duration-unit" ng-class="{\'illegalValue\': illegalValue}" ng-options="displayUnit.value as displayUnit.name for displayUnit in displayUnits" ng-disabled="disabled"><option value=""></option>></select></span>'}}]),angular.module("bahmni.common.conceptSet").directive("latestObs",function(){return{restrict:"E",controller:function(e,t,n,r){r.forPromise(t.fetch(e.patientUuid,e.conceptNames,"latest").then(function(t){var n=(new Bahmni.Common.Obs.ObservationMapper).map(t.data,[]);e.observations=_.sortBy(n,"sortWeight")}))},templateUrl:"../common/concept-set/views/latestObs.html",scope:{patientUuid:"=",conceptNames:"="}}}),Bahmni.ConceptSet.ConceptSetGroupValidationHandler=function(e){var t=[];this.add=function(e){t.push(e)},this.validate=function(){var n="",r=!0;return t.forEach(function(e){var t=e();_.isEmpty(n)&&(n=t.errorMessage),r=r&&t.allow}),r||e.filter(_.property("isLoaded")).forEach(function(e){e.show()}),{allow:r,errorMessage:n}}},Bahmni.ConceptSet.Observation=function(e,t,n){var r=this;angular.extend(this,e),this.isObservation=!0,this.conceptUIConfig=n[this.concept.name]||[],this.uniqueId=_.uniqueId("observation_"),this.erroneousValue=null,t?(this.uuid=t.uuid,this.value=t.value,this.observationDateTime=t.observationDateTime,this.provider=t.provider):this.value=this.conceptUIConfig.defaultValue,Object.defineProperty(this,"autocompleteValue",{enumerable:!0,get:function(){return null!=this.value&&"object"==typeof this.value?this.value.name:this.value},set:function(e){this.__prevValue=this.value,this.value=e}}),Object.defineProperty(this,"value",{enumerable:!0,get:function(){return null!=r._value?r._value:(t&&"object"==typeof t.value&&t.value&&(t.value.displayString=t.value.shortName?t.value.shortName:t.value.name),t?t.value:void 0)},set:function(e){r.__prevValue=this.value,r._value=e,e||(t=null),r.onValueChanged()}});this.cloneNew=function(){var t=angular.copy(e);if(t.groupMembers&&t.groupMembers.length>0){t.groupMembers=_.filter(t.groupMembers,function(e){return!e.isMultiSelect});var r=function(e){var t=[];return e.groupMembers.forEach(function(e){if(void 0===e.isTabularObs){var n=e.cloneNew();n.hidden=e.hidden,t.push(n)}}),t}(t),i=function(e){var t=[];return e.groupMembers.forEach(function(e){void 0!==e.isTabularObs&&t.push(e)}),t}(t);t.groupMembers=r,_.isEmpty(i)||(t=function(e,t){return(t=_.map(t,function(t){var r=_.filter(e.groupMembers,function(e){return e.concept.name==t.concept.name});return new Bahmni.ConceptSet.TabularObservations(r,e,n)})).forEach(function(t){e.groupMembers.push(t)}),e}(t,i))}new Bahmni.ConceptSet.MultiSelectObservations(n).map(t.groupMembers);var o=new Bahmni.ConceptSet.Observation(t,null,n);return o.comment=void 0,o.disabled=this.disabled,o}},Bahmni.ConceptSet.Observation.prototype={displayValue:function(){if(!(this.possibleAnswers.length>0))return this.value;for(var e=0;e<this.possibleAnswers.length;e++)if(this.possibleAnswers[e].uuid===this.value)return this.possibleAnswers[e].display},isGroup:function(){return!!this.groupMembers&&this.groupMembers.length>0},isComputed:function(){return"Computed"===this.concept.conceptClass},isComputedAndEditable:function(){return"Computed/Editable"===this.concept.conceptClass},isNumeric:function(){return"Numeric"===this.getDataTypeName()},isValidNumeric:function(){return!(!this.isDecimalAllowed()&&this.value&&this.value.toString().indexOf(".")>=0)},isValidNumericValue:function(){var e=document.getElementById(this.uniqueId);return""!==this.value||!e||e.checkValidity()},isText:function(){return"Text"===this.getDataTypeName()},isCoded:function(){return"Coded"===this.getDataTypeName()},isDatetime:function(){return"Datetime"===this.getDataTypeName()},isImage:function(){return this.concept.conceptClass==Bahmni.Common.Constants.imageClassName},isVideo:function(){return this.concept.conceptClass==Bahmni.Common.Constants.videoClassName},getDataTypeName:function(){return this.concept.dataType},isDecimalAllowed:function(){return this.concept.allowDecimal},isDateDataType:function(){return-1!="Date".indexOf(this.getDataTypeName())},isVoided:function(){return void 0!==this.voided&&this.voided},getPossibleAnswers:function(){return this.possibleAnswers},getHighAbsolute:function(){return this.concept.hiAbsolute},getLowAbsolute:function(){return this.concept.lowAbsolute},isHtml5InputDataType:function(){return-1!==["Date","Numeric"].indexOf(this.getDataTypeName())},isGrid:function(){return this.conceptUIConfig.grid},isButtonRadio:function(){return this.conceptUIConfig.buttonRadio},isComplex:function(){return"Complex"===this.concept.dataType},isLocationRef:function(){return this.isComplex()&&"LocationObsHandler"===this.concept.handler},isProviderRef:function(){return this.isComplex()&&"ProviderObsHandler"===this.concept.handler},getControlType:function(){return this.hidden?"hidden":this.conceptUIConfig.freeTextAutocomplete?"freeTextAutocomplete":this.isHtml5InputDataType()?"html5InputDataType":this.isImage()?"image":this.isVideo()?"video":this.isText()?"text":this.isCoded()?this._getCodedControlType():this.isGrid()?"grid":this.isDatetime()?"datetime":this.isLocationRef()?"text":this.isProviderRef()?"text":"unknown"},canHaveComment:function(){return this.conceptUIConfig.disableAddNotes?!this.conceptUIConfig.disableAddNotes:!this.isText()&&!this.isImage()&&!this.isVideo()},canAddMore:function(){return 1==this.conceptUIConfig.allowAddMore},isStepperControl:function(){if(this.isNumeric())return 1==this.conceptUIConfig.stepper},isConciseText:function(){return 1==this.conceptUIConfig.conciseText},_getCodedControlType:function(){var e=this.conceptUIConfig;return e.autocomplete?"autocomplete":e.dropdown?"dropdown":"buttonselect"},onValueChanged:function(){this.isNumeric()&&this.setErroneousValue()},setErroneousValue:function(){if(this.hasValue()){var e=this.value>(this.concept.hiAbsolute||1/0)||this.value<(this.concept.lowAbsolute||0);this.erroneousValue=e}else this.erroneousValue=void 0},getInputType:function(){return this.getDataTypeName()},atLeastOneValueSet:function(){return this.isGroup()?this.groupMembers.some(function(e){return e.atLeastOneValueSet()}):this.hasValue()&&!this.isVoided()},hasValue:function(){var e=this.value;return!1===e||0===e||!(""===e||!e)&&(!(e instanceof Array)||e.length>0)},hasValueOf:function(e){return!(!this.value||!e||this.value!=e&&this.value.uuid!=e.uuid)},toggleSelection:function(e){this.value&&this.value.uuid===e.uuid?this.value=null:this.value=e},isValidDate:function(){if(this.isComputed())return!0;if(!this.hasValue())return!0;var e=Bahmni.Common.Util.DateUtil.parse(this.value);if(!this.conceptUIConfig.allowFutureDates&&Bahmni.Common.Util.DateUtil.parse(moment().format("YYYY-MM-DD"))<e)return!1;return e.getUTCFullYear()&&e.getUTCFullYear().toString().length<=4},hasInvalidDateTime:function(){if(this.isComputed())return!1;var e=Bahmni.Common.Util.DateUtil.parse(this.value);return!this.conceptUIConfig.allowFutureDates&&moment()<e||"Invalid Datetime"===this.value},isValid:function(e,t){if(this.isNumeric()&&!this.isValidNumeric())return!1;if(this.error)return!1;if(this.hidden)return!0;if(e){if(this.isGroup())return this._hasValidChildren(e,t);if(t&&this.isRequired()&&!this.hasValue())return!1;if(this.isRequired()&&!this.hasValue())return!1}return this._isDateDataType()?this.isValidDate():this._isDateTimeDataType()?!this.hasInvalidDateTime():!this.erroneousValue&&("autocomplete"!==this.getControlType()||_.isEmpty(this.value)||_.isObject(this.value))},isValueInAbsoluteRange:function(){return!this.erroneousValue&&(!this.isGroup()||this._areChildNodesInAbsoluteRange())},_isDateDataType:function(){return"Date"===this.getDataTypeName()},_isDateTimeDataType:function(){return"Datetime"===this.getDataTypeName()},isRequired:function(){return this.disabled=!!this.disabled&&this.disabled,!0===this.conceptUIConfig.required&&!1===this.disabled},isFormElement:function(){return(!this.concept.set||this.isGrid())&&!this.isComputed()},_hasValidChildren:function(e,t){return this.groupMembers.every(function(n){return n.isValid(e,t)})},_areChildNodesInAbsoluteRange:function(){return this.groupMembers.every(function(e){return"function"!=typeof e.isValueInAbsoluteRange||e.isValueInAbsoluteRange()})},markAsNonCoded:function(){this.markedAsNonCoded=!this.markedAsNonCoded},toggleVoidingOfImage:function(){this.voided=!this.voided},assignAddMoreButtonID:function(){return this.concept.name.split(" ").join("_").toLowerCase()+"_addmore_"+this.uniqueId}},Bahmni.ConceptSet.BooleanObservation=function(e,t){angular.extend(this,e),this.isBoolean=!0,this.conceptUIConfig=t[this.concept.name]||{},this.cloneNew=function(){var n=new Bahmni.ConceptSet.BooleanObservation(angular.copy(e),t);return n.value=void 0,n.comment=void 0,n.uuid=null,n.disabled=this.disabled,n};var n=[{displayString:"OBS_BOOLEAN_YES_KEY",value:!0},{displayString:"OBS_BOOLEAN_NO_KEY",value:!1}];this.getPossibleAnswers=function(){return n},this.hasValueOf=function(e){return this.value===e.value},this.toggleSelection=function(e){this.value===e.value?this.value=null:this.value=e.value},this.isFormElement=function(){return!0},this.getControlType=function(){return"buttonselect"},this.isRequired=function(){return this.disabled=!!this.disabled&&this.disabled,!0===this.getConceptUIConfig().required&&!1===this.disabled},this.isComputedAndEditable=function(){return"Computed/Editable"===this.concept.conceptClass},this.atLeastOneValueSet=function(){return null!=this.value},this.isValid=function(e,t){if(this.error)return!1;var n=function(e){return void 0===e||null==e};if(e){if(t&&this.isRequired()&&n(this.value))return!1;if(this.isRequired()&&n(this.value))return!1}return!0},this.canHaveComment=function(){return!this.getConceptUIConfig().disableAddNotes||!this.getConceptUIConfig().disableAddNotes},this.getConceptUIConfig=function(){return this.conceptUIConfig},this.canAddMore=function(){return 1==this.getConceptUIConfig().allowAddMore},this.isComputed=function(){return"Computed"===this.concept.conceptClass},this.getDataTypeName=function(){return this.concept.dataType},this.hasValue=function(){var e=this.value;return!1===e||0===e||!(""===e||!e)&&(!(e instanceof Array)||e.length>0)},this.isNumeric=function(){return"Numeric"===this.getDataTypeName()},this.isText=function(){return"Text"===this.getDataTypeName()},this.isCoded=function(){return"Coded"===this.getDataTypeName()},this._isDateTimeDataType=function(){return"Datetime"===this.getDataTypeName()}},function(){var e=function(e,t){return _.find(e,function(e){return e.concept.conceptClass.name===t||e.concept.conceptClass===t})},t=function(e,t){return _.find(e,{concept:{name:t}})},n=function(e,t){e&&(e.__prevValue=e.value,e.value=t,e.voided=!1)},r=function(e){e&&(e.uuid?e.voided=!0:e.value=void 0)},i=function(e){return e.autocomplete&&e.nonCodedConceptName&&e.codedConceptName};Bahmni.ConceptSet.ObservationNode=function(o,a,s,u){angular.extend(this,o),this.conceptUIConfig=s[u.name.name]||!_.isEmpty(u.setMembers)&&s[u.setMembers[0].name.name]||{},this.cloneNew=function(){var e=angular.copy(o);e.groupMembers=_.map(e.groupMembers,function(e){return e.cloneNew()});var t=new Bahmni.ConceptSet.ObservationNode(e,null,s,u);return t.comment=void 0,t};Object.defineProperty(this,"value",{enumerable:!0,get:function(){return this.primaryObs&&_.get(this,"primaryObs.value.name")||_.get(this,"primaryObs.value")},set:i(this.conceptUIConfig)?function(e){var i=t(this.groupMembers,this.conceptUIConfig.codedConceptName),o=t(this.groupMembers,this.conceptUIConfig.nonCodedConceptName);"object"==typeof e?(n(i,e),r(o),this.markedAsNonCoded=!1):(n(o,e),r(i)),this.onValueChanged(e)}:function(e){n(this.primaryObs,e),this.onValueChanged(e)}});Object.defineProperty(this,"primaryObs",{enumerable:!0,get:i(this.conceptUIConfig)?function(){var e,n=t(this.groupMembers,this.conceptUIConfig.codedConceptName),r=t(this.groupMembers,this.conceptUIConfig.nonCodedConceptName);if(e=r,_.isString(_.get(e,"value"))&&!_.get(e,"voided"))return r;if(!n)throw new Error("Configuration Error: Concept '"+this.conceptUIConfig.codedConceptName+"' is not a set member of '"+u.name.name+"'.");return n}:function(){var e,t,n=(e=this.groupMembers,t=[Bahmni.Common.Constants.abnormalConceptClassName,Bahmni.Common.Constants.unknownConceptClassName,Bahmni.Common.Constants.durationConceptClassName],_.filter(e,function(e){return!(_.includes(t,e.concept.conceptClass.name)||_.includes(t,e.concept.conceptClass))}));if(_.isEmpty(n))return this.groupMembers[0];var r=n[1]&&n[1].uuid&&!n[1].voided?n[1]:n[0];return n[0].isMultiSelect?n[0]:r.uuid&&!r.voided?r:!n[1]||!n[1].value&&""!==n[1].value||n[1].voided?n[0]:n[1]}}),this.isObservationNode=!0,this.uniqueId=_.uniqueId("observation_"),this.durationObs=e(this.groupMembers,Bahmni.Common.Constants.durationConceptClassName),this.abnormalObs=e(this.groupMembers,Bahmni.Common.Constants.abnormalConceptClassName),this.unknownObs=e(this.groupMembers,Bahmni.Common.Constants.unknownConceptClassName),this.markedAsNonCoded="Coded"!==this.primaryObs.concept.dataType&&this.primaryObs.uuid,a?(this.uuid=a.uuid,this.observationDateTime=a.observationDateTime):this.value=this.conceptUIConfig.defaultValue},Bahmni.ConceptSet.ObservationNode.prototype={canAddMore:function(){return 1==this.conceptUIConfig.allowAddMore},isStepperControl:function(){return!!this.isNumeric()&&1==this.conceptUIConfig.stepper},getPossibleAnswers:function(){return this.primaryObs.concept.answers},getCodedConcept:function(){return t(this.groupMembers,this.conceptUIConfig.codedConceptName).concept},onValueChanged:function(){!this.primaryObs.hasValue()&&this.abnormalObs&&(this.abnormalObs.value=void 0,this.abnormalObs.erroneousValue=void 0),this.primaryObs.isNumeric()&&this.primaryObs.hasValue()&&this.abnormalObs&&this.setAbnormal(),this.primaryObs.observationDateTime=null,this.unknownObs&&this.setUnknown()},setAbnormal:function(){if(this.primaryObs.hasValue()){var e=this.value>(this.primaryObs.concept.hiAbsolute||1/0)||this.value<(this.primaryObs.concept.lowAbsolute||0),t=this.value<=(this.primaryObs.concept.hiNormal||1/0)&&this.value>=(this.primaryObs.concept.lowNormal||0);this.abnormalObs.value=!t,this.abnormalObs.erroneousValue=e}else this.abnormalObs.value=void 0,this.abnormalObs.erroneousValue=void 0},setUnknown:function(){this.primaryObs.atLeastOneValueSet()&&this.primaryObs.hasValue()?this.unknownObs.value=!1:0==this.unknownObs.value&&(this.unknownObs.value=void 0)},displayValue:function(){if(!(this.possibleAnswers.length>0))return this.value;for(var e=0;e<this.possibleAnswers.length;e++)if(this.possibleAnswers[e].uuid===this.value)return this.possibleAnswers[e].display},isGroup:function(){return!1},getControlType:function(){return i(this.conceptUIConfig)?"freeTextAutocomplete":this.conceptUIConfig.autocomplete?"autocomplete":this.isHtml5InputDataType()?"html5InputDataType":this.primaryObs.isText()?"text":this.conceptUIConfig.dropdown?"dropdown":"buttonselect"},isHtml5InputDataType:function(){return-1!=["Date","Numeric","Datetime"].indexOf(this.primaryObs.getDataTypeName())},_isDateTimeDataType:function(){return"Datetime"===this.primaryObs.getDataTypeName()},isComputed:function(){return this.primaryObs.isComputed()},isConciseText:function(){return!0===this.conceptUIConfig.conciseText},isComputedAndEditable:function(){return"Computed/Editable"===this.concept.conceptClass},atLeastOneValueSet:function(){return this.primaryObs.hasValue()},doesNotHaveDuration:function(){return!(!this.durationObs||!this.conceptUIConfig.durationRequired)&&(!this.durationObs.value||this.durationObs.value<0)},isValid:function(e,t){if(this.isNumeric()&&(!this.isValidNumeric()||!this.isValidNumericValue()))return!1;if(this.isGroup())return this._hasValidChildren(e,t);if(e){if(t&&this.isRequired()&&!this.primaryObs.hasValue())return!1;if(this.isRequired()&&!this.primaryObs.hasValue())return!1;if("freeTextAutocomplete"===this.getControlType())return this.isValidFreeTextAutocomplete()}return"Date"===this.primaryObs.getDataTypeName()?this.primaryObs.isValidDate():(!this.primaryObs.hasValue()||!this.doesNotHaveDuration())&&(!this.abnormalObs||!this.abnormalObs.erroneousValue)&&(this.primaryObs.hasValue()&&this.primaryObs._isDateTimeDataType()?!this.hasInvalidDateTime():"autocomplete"===this.getControlType()?_.isEmpty(this.primaryObs.value)||_.isObject(this.primaryObs.value):!this.primaryObs.hasValue()||!this.primaryObs.erroneousValue)},isValueInAbsoluteRange:function(){return!(this.abnormalObs&&this.abnormalObs.erroneousValue)},isValidFreeTextAutocomplete:function(){return!("Coded"!==this.primaryObs.concept.dataType&&!this.markedAsNonCoded&&this.primaryObs.value)},isRequired:function(){return this.disabled=!!this.disabled&&this.disabled,!0===this.conceptUIConfig.required&&!1===this.disabled},isDurationRequired:function(){return!!this.conceptUIConfig.durationRequired&&!!this.primaryObs.value},isNumeric:function(){return"Numeric"===this.primaryObs.getDataTypeName()},isDecimalAllowed:function(){return this.primaryObs.concept.allowDecimal},isValidNumeric:function(){return!(!this.isDecimalAllowed()&&this.value&&this.value.toString().indexOf(".")>=0)},isValidNumericValue:function(){var e=document.getElementById(this.uniqueId);return""!==this.value||!e||e.checkValidity()},_hasValidChildren:function(e,t){return this.groupMembers.every(function(n){return n.isValid(e,t)})},markAsNonCoded:function(){this.markedAsNonCoded=!this.markedAsNonCoded},toggleAbnormal:function(){this.abnormalObs.value=!this.abnormalObs.value},toggleUnknown:function(){this.unknownObs.value?this.unknownObs.value=void 0:this.unknownObs.value=!0},assignAddMoreButtonID:function(){return this.concept.name.split(" ").join("_").toLowerCase()+"_addmore_"+this.uniqueId},canHaveComment:function(){return!this.conceptUIConfig.disableAddNotes||!this.conceptUIConfig.disableAddNotes},hasInvalidDateTime:function(){if(this.isComputed())return!1;var e=Bahmni.Common.Util.DateUtil.parse(this.value);return!this.conceptUIConfig.allowFutureDates&&moment()<e||"Invalid Datetime"===this.value}}}(),Bahmni.ConceptSet.TabularObservations=function(e,t,n){this.parentObs=t,this.concept=e[0]&&e[0].concept,this.label=e[0]&&e[0].label,this.conceptUIConfig=n[this.concept.name]||{},this.isTabularObs=!0,this.rows=_.map(e,function(e){return new Bahmni.ConceptSet.ObservationRow(e,n)}),this.columns=_.map(e[0].groupMembers,function(e){return e.concept}),this.cloneNew=function(){var r=new Bahmni.ConceptSet.TabularObservations(angular.copy(e),t,n);return r.rows=_.map(this.rows,function(e){return e.cloneNew()}),r.disabled=this.disabled,r},this.addNew=function(e){var t=e.cloneNew();this.rows.push(t),this.parentObs.groupMembers.push(t.obsGroup)},this.remove=function(e){e.void(),this.rows.splice(this.rows.indexOf(e),1),0==this.rows.length&&this.addNew(e)},this.isFormElement=function(){return!1},this.getControlType=function(){return"tabular"},this.isValid=function(e,t){return _.every(this.rows,function(n){return _.every(n.cells,function(n){return n.isValid(e,t)})})},this.getConceptUIConfig=function(){return this.conceptUIConfig||{}},this.canAddMore=function(){return 1==this.getConceptUIConfig().allowAddMore},this.atLeastOneValueSet=function(){return this.rows.some(function(e){return e.obsGroup.atLeastOneValueSet()})},this.isNumeric=function(){return"Numeric"===this.concept.dataType},this.isValidNumericValue=function(){var e=document.getElementById(this.uniqueId);return""!==this.value||!e||e.checkValidity()}},Bahmni.ConceptSet.ObservationRow=function(e,t){this.obsGroup=e,this.concept=e.concept,this.cells=e.groupMembers,this.void=function(){this.obsGroup.voided=!0},this.cloneNew=function(){var e=this.obsGroup.cloneNew();e.hidden=!0;var n=new Bahmni.ConceptSet.ObservationRow(e,t);return n.disabled=this.disabled,n}},Bahmni.ConceptSet.MultiSelectObservations=function(e){var t=this;this.multiSelectObservationsMap={},this.map=function(t){t.forEach(function(r){n(r.concept,e)&&i(r.concept,r,t)}),r(t)};var n=function(e,t){return t[e.name]&&t[e.name].multiSelect},r=function(e){o().forEach(function(t){var n=_.findIndex(e,function(e){return e.concept.name===t.concept.name});e.splice(n,0,t)})},i=function(n,r,i){var o=n.name.name||n.name;t.multiSelectObservationsMap[o]=t.multiSelectObservationsMap[o]||new Bahmni.ConceptSet.MultiSelectObservation(n,i,e),t.multiSelectObservationsMap[o].add(r)},o=function(){return _.values(t.multiSelectObservationsMap)}},Bahmni.ConceptSet.MultiSelectObservation=function(e,t,n){var r=this;this.label=e.shortName||e.name,this.isMultiSelect=!0,this.selectedObs={},this.concept=e,this.concept.answers=this.concept.answers||[],this.groupMembers=[],this.provider=null,this.observationDateTime="",this.conceptUIConfig=n[this.concept.name]||{},this.possibleAnswers=r.concept.answers.map(function(e){var t=_.cloneDeep(e);return e.name.name&&(t.name=e.name.name),t}),this.getPossibleAnswers=function(){return this.possibleAnswers},this.cloneNew=function(){var r=new Bahmni.ConceptSet.MultiSelectObservation(e,t,n);return r.disabled=this.disabled,r},this.add=function(e){if(e.value){r.selectedObs[e.value.name]=e,r.provider||(r.provider=r.selectedObs[e.value.name].provider);var t=r.selectedObs[e.value.name].observationDateTime;r.observationDateTime<t&&(r.observationDateTime=t)}e.hidden=!0},this.isComputedAndEditable=function(){return"Computed/Editable"===this.concept.conceptClass},this.hasValueOf=function(e){return r.selectedObs[e.name]&&!r.selectedObs[e.name].voided},this.toggleSelection=function(e){r.hasValueOf(e)?i(e):r.selectAnswer(e)},this.isFormElement=function(){return!0},this.getControlType=function(){var e=this.getConceptUIConfig();return this.isCoded()&&1==e.autocomplete&&1==e.multiSelect?"autocompleteMultiSelect":1==e.autocomplete?"autocomplete":"buttonselect"},this.atLeastOneValueSet=function(){var e=_.filter(this.selectedObs,function(e){return e.value});return!_.isEmpty(e)},this.hasValue=function(){return!_.isEmpty(this.selectedObs)},this.hasNonVoidedValue=function(){var e=!1;return this.hasValue()&&angular.forEach(this.selectedObs,function(t){t.voided||(e=!0)}),e},this.isValid=function(e,t){if(this.error)return!1;if(e){if(t&&this.isRequired()&&!this.hasNonVoidedValue())return!1;if(this.isRequired()&&!this.hasNonVoidedValue())return!1}return!0},this.canHaveComment=function(){return!1},this.getConceptUIConfig=function(){return this.conceptUIConfig||{}},this.canAddMore=function(){return 1==this.getConceptUIConfig().allowAddMore},this.isRequired=function(){return this.disabled=!!this.disabled&&this.disabled,!0===this.getConceptUIConfig().required&&!1===this.disabled};this.selectAnswer=function(i){var a=r.selectedObs[i.name];a?(a.value=i,a.voided=!1):(a=function(r){var i=o(e,r,n);return t.push(i),i}(i),r.add(a))};var i=function(i){var a=r.selectedObs[i.name];a&&a.uuid?(a.value=null,a.voided=!0):(function(r){var i=o(e,r,n);_.remove(t,function(e){return!!e.value&&i.value.displayString==e.value.displayString})}(i),delete r.selectedObs[i.name])},o=function(e,t,n){var r=a(e);return new Bahmni.ConceptSet.Observation(r,{value:t},n,[])},a=function(e){return{concept:e,units:e.units,label:e.shortName||e.name,possibleAnswers:r.concept.answers,groupMembers:[],comment:null}};this.getValues=function(){var e=[];return _.values(r.selectedObs).forEach(function(t){t.value&&e.push(t.value.shortName||t.value.name)}),e},this.isComputed=function(){return"Computed"===this.concept.conceptClass},this.getDataTypeName=function(){return this.concept.dataType},this._isDateTimeDataType=function(){return"Datetime"===this.getDataTypeName()},this.isNumeric=function(){return"Numeric"===this.getDataTypeName()},this.isText=function(){return"Text"===this.getDataTypeName()},this.isCoded=function(){return"Coded"===this.getDataTypeName()}},Bahmni.ConceptSet.CustomRepresentationBuilder={build:function(e,t,n){for(var r=t+":{{entity_fileds}}",i="("+e.concat(r).join(",")+")",o=i,a=0;a<n;a++)o=o.replace("{{entity_fileds}}",i);return o.replace(","+r,"")}},Bahmni.ConceptSet.ConceptSetSection=function(e,t,n,r,i){var o=this;o.clone=function(){var r=new Bahmni.ConceptSet.ConceptSetSection(e,t,n,[],i);return r.isAdded=!0,r};var a=function(e){return e.groupMembers&&e.groupMembers.length>0?e.groupMembers.some(function(e){return a(e)}):!(_.isUndefined(e.value)||""===e.value)};o.isAvailable=function(e){return function(){if(!o.showIfFunction){var e=o.options.showIf||["return true;"];o.showIfFunction=new Function("context",e.join("\n"))}return o.showIfFunction}()(e||{})},o.show=function(){o.isOpen=!0,o.isLoaded=!0},o.hide=function(){o.isOpen=!1},o.getObservationsForConceptSection=function(){return o.observations.filter(function(e){return e.concept.name===o.conceptName})},o.hasSomeValue=function(){var e=o.getObservationsForConceptSection();return _.some(e,function(e){return a(e)})},o.showComputeButton=function(){return!0===n.computeDrugs},o.toggle=function(){o.added=!o.added,o.added&&o.show()},o.maximizeInnerSections=function(e){e.stopPropagation(),o.collapseInnerSections={value:!1}},o.minimizeInnerSections=function(e){e.stopPropagation(),o.collapseInnerSections={value:!0}},o.toggleDisplay=function(){o.isOpen?o.hide():o.show()},o.canToggle=function(){return!o.hasSomeValue()},o.canAddMore=function(){return 1==o.allowAddMore},Object.defineProperty(o,"isOpen",{get:function(){return void 0===o.open&&(o.open=o.hasSomeValue()),o.open},set:function(e){o.open=e}}),o.isDefault=function(){return o.options.default},Object.defineProperty(o,"isAdded",{get:function(){return void 0===o.added&&(o.options.default?o.added=!0:o.added=o.hasSomeValue()),o.added},set:function(e){o.added=e}}),function(){o.observations=r,o.options=e.extensionParams||{},o.conceptName=i.name?i.name.name:o.options.conceptName;var a=_.find(i.names,{conceptNameType:"SHORT"})||_.find(i.names,{conceptNameType:"FULLY_SPECIFIED"});a=a?a.name:a,o.label=a||o.conceptName||o.options.conceptName,o.isLoaded=o.isOpen,o.collapseInnerSections={value:!1},o.uuid=i.uuid,o.alwaysShow=t.isFavouriteObsTemplate(o.conceptName),o.allowAddMore=n.allowAddMore,o.id="concept-set-"+i.uuid}()},Bahmni.ObservationForm=function(e,t,n,r,i,o,a){var s=this;s.toggleDisplay=function(){s.isOpen?s.isOpen=!1:s.isOpen=!0},s.clone=function(){var e=new Bahmni.ObservationForm(s.formUuid,t,s.formName,s.formVersion,[]);return e.isOpen=!0,e},s.isAvailable=function(e){return!0},s.show=function(){s.isOpen=!0,s.isLoaded=!0},s.toggle=function(){s.added=!s.added,s.added&&s.show()},s.hasSomeValue=function(){var e=s.getObservationsForConceptSection();return _.some(e,function(e){return u(e)})},s.getObservationsForConceptSection=function(){return s.observations.filter(function(e){return e.formFieldPath.split(".")[0]===s.formName})};var u=function(e){return e.groupMembers&&e.groupMembers.length>0?e.groupMembers.some(function(e){return u(e)}):!(_.isUndefined(e.value)||""===e.value)};s.isDefault=function(){return!1},Object.defineProperty(s,"isAdded",{get:function(){return void 0===s.added&&(s.options.default?s.added=!0:s.added=s.hasSomeValue()),s.added},set:function(e){s.added=e}}),s.maximizeInnerSections=function(e){e.stopPropagation(),s.collapseInnerSections={value:!1}},s.minimizeInnerSections=function(e){e.stopPropagation(),s.collapseInnerSections={value:!0}},s.formUuid=e,s.formVersion=r,s.formName=n,s.label=o,s.conceptName=n,s.collapseInnerSections={value:!1},s.alwaysShow=t.isFavouriteObsTemplate(s.conceptName),s.observations=[],_.each(i,function(e){var t=e.formFieldPath?Bahmni.Common.Util.FormFieldPathUtil.getFormNameAndVersion(e.formFieldPath):null;t&&t.formName===n&&t.formVersion==r&&s.observations.push(e)}),s.isOpen=s.observations.length>0,s.id="concept-set-"+e,s.options=a&&a.extensionParams||{},s.privileges=[]},Bahmni.ConceptSet.ObservationMapper=function(){function e(e,n,r){var i=n?n.comment:null;return{concept:t.map(e),units:e.units,label:p(e),possibleAnswers:e.answers,groupMembers:r,comment:i,showAddMoreButton:c}}var t=new Bahmni.Common.Domain.ConceptMapper,n=this;this.getObservationsForView=function(e,t){return r(e,t)};var r=function(e,t){var i=[];return _.forEach(e,function(e){if(!e.concept.conceptClass||e.concept.conceptClass!==Bahmni.Common.Constants.conceptDetailsClassName&&e.concept.conceptClass.name!==Bahmni.Common.Constants.conceptDetailsClassName)if(e.concept.set)if(t[e.concept.name]&&t[e.concept.name].grid)e.value=n.getGridObservationDisplayValue(e),i=i.concat(l(e,e.concept));else{var o=r(e.groupMembers,t);i=i.concat(o)}else{var a=null;if(e.isMultiSelect)a=e;else if(!e.hidden){var u=s(e.concept,e,[]);a=l(u,u.concept)}a&&i.push(a)}else{var c=new Bahmni.ConceptSet.ObservationNode(e,e,[],e.concept);(a=l(c,c.primaryObs.concept))&&i.push(a)}}),i};this.map=function(e,t,n){var r=i(t,e)[0];return o(t,r,n||{})};var i=function(e,t){return _.filter(t,function(t){return t&&t.concept&&e.uuid===t.concept.uuid})},o=function(e,t,n){var r=null;if(t&&(t.isObservation||t.isObservationNode))return t;var i=e&&e.set?a(t?t.groupMembers:[],e,n):[];return e.conceptClass.name===Bahmni.Common.Constants.conceptDetailsClassName?r=u(e,t,n,i):(r=s(e,t,n,i),new Bahmni.ConceptSet.MultiSelectObservations(n).map(i)),function(e,t,n,r){var i=_.filter(e,function(e){return r[e.concept.name]&&r[e.concept.name].isTabular});if(i.length>0){var o=_.map(t.setMembers,function(e){return e.name.name});i.forEach(function(e){e.hidden=!0});var a=_.groupBy(i,function(e){return e.concept.name});_.values(a).forEach(function(e){var t=new Bahmni.ConceptSet.TabularObservations(e,n,r);n.groupMembers.push(t)});var s=_.sortBy(n.groupMembers,function(e){return o.indexOf(e.concept.name)});n.groupMembers.length=0,n.groupMembers.push.apply(n.groupMembers,s)}}(i,e,r,n),r},a=function(e,t,n){var r=[];return t.setMembers.forEach(function(t){for(var a=i(t,e),s=(n[t.name.name]||{}).multiple||1,u=a.length-1;u>=0;u--)r.push(o(t,a[u],n));for(u=0;u<s-a.length;u++)r.push(o(t,null,n))}),r},s=function(t,n,r,i){var o=e(t,n,i),a=new Bahmni.ConceptSet.Observation(o,n,r,i);return"Boolean"==function(e){return e.dataType?e.dataType:e.datatype&&e.datatype.name}(t)&&(a=new Bahmni.ConceptSet.BooleanObservation(a,r)),a},u=function(t,n,r,i){var o=e(t,n,i);return new Bahmni.ConceptSet.ObservationNode(o,n,r,t)},c=function(e){return _.findLast(e.groupMembers,{label:this.label}).uuid===this.uuid},l=function(e,t){if(null!=e.value){var n=m(e);return{value:n=e.durationObs?n+" "+f(e.durationObs):n,abnormalObs:e.abnormalObs,duration:e.durationObs,provider:e.provider,label:p(e.concept),observationDateTime:e.observationDateTime,concept:t,comment:e.comment,uuid:e.uuid}}},m=function(e){if(e.isBoolean||"Boolean"===e.type)return!0===e.value?"Yes":"No";if(!e.value)return"";if("object"==typeof e.value.name){var n=t.map(e.value);return n.shortName||n.name}return e.value.shortName||e.value.name||e.value},f=function(e){var t=Bahmni.Common.Util.DateUtil.convertToUnits(e.value);return t.value&&t.unitName?"since "+t.value+" "+t.unitName:""};this.getGridObservationDisplayValue=function(e){return _.compact(_.map(e.groupMembers,function(e){return m(e)})).join(", ")};var p=function(e){var n=t.map(e);return n.shortName||n.name}},angular.module("bahmni.common.conceptSet").factory("conceptService",["$q","$http",function(e,t){var n=new Bahmni.Common.Domain.ConceptMapper,r=function(e){return e.concept&&n.map(e.concept)||e.drug};return{getAnswersForConceptName:function(e){var n={q:e.term,question:e.answersConceptName,v:"custom:(concept:(uuid,name:(display,uuid,name,conceptNameType),names:(display,uuid,name,conceptNameType)),drug:(uuid,name,display))",s:"byQuestion"};return t.get(Bahmni.Common.Constants.bahmniConceptAnswerUrl,{params:n}).then(_.partial(_.get,_,"data.results")).then(function(e){return _(e).map(r).uniqBy("uuid").value()})},getAnswers:function(t){var r=e.defer(),i=_(t.answers).uniqBy("uuid").map(n.map).value();return r.resolve(i),r.promise}}}]),angular.module("bahmni.common.conceptSet").factory("conceptSetUiConfigService",["$http","$q","appService",function(e,t,n){var r=function(t,n,r){var i=t[n];if(null!=i)return e.get(Bahmni.Common.Constants.conceptSearchByFullNameUrl,{params:{name:i,v:"custom:(uuid,name)"}}).then(function(e){var n=e.data.results.filter(function(e){return e.name.name===i});n.length>0&&(t[r]=n[0].uuid)})};return{getConfig:function(){var e=n.getAppDescriptor().getConfigValue("conceptSetUI")||{};return function(e){Object.getOwnPropertyNames(e).forEach(function(t){var n=e[t];n.freeTextAutocomplete instanceof Object&&(r(n.freeTextAutocomplete,"codedConceptName","codedConceptUuid"),r(n.freeTextAutocomplete,"conceptSetName","conceptSetUuid"))})}(e),e}}}]),angular.module("bahmni.common.uiHelper").filter("thumbnail",function(){return function(e,t){if(e)return t?Bahmni.Common.Constants.documentsPath+"/"+e.replace(/(.*)\.(.*)$/,"$1_thumbnail."+t)||null:Bahmni.Common.Constants.documentsPath+"/"+e.replace(/(.*)\.(.*)$/,"$1_thumbnail.$2")||null}}),angular.module("bahmni.common.uiHelper").filter("days",function(){return function(e,t){return Bahmni.Common.Util.DateUtil.diffInDays(e,t)}}).filter("bahmniDateTime",function(){return function(e){return Bahmni.Common.Util.DateUtil.formatDateWithTime(e)}}).filter("bahmniDate",function(){return function(e){return Bahmni.Common.Util.DateUtil.formatDateWithoutTime(e)}}).filter("bahmniTime",function(){return function(e){return Bahmni.Common.Util.DateUtil.formatTime(e)}}).filter("bahmniDateInStrictMode",function(){return function(e){return Bahmni.Common.Util.DateUtil.formatDateInStrictMode(e)}}).filter("bahmniDateTimeWithFormat",function(){return function(e,t){return Bahmni.Common.Util.DateUtil.getDateTimeInSpecifiedFormat(e,t)}}).filter("addDays",function(){return function(e,t){return Bahmni.Common.Util.DateUtil.addDays(e,t)}}),(Bahmni=Bahmni||{}).Common=Bahmni.Common||{},Bahmni.Common.Logging=Bahmni.Common.Logging||{},angular.module("bahmni.common.logging",[]),angular.module("bahmni.common.logging").config(["$provide",function(e){e.decorator("$exceptionHandler",function(e,t,n,r){var i=function(e){window.angular_exception=window.angular_exception||[],window.angular_exception.push(e)};return function(o,a){e(o,a),function(e,o){try{var a=t.get("messagingService"),s=t.get("loggingService"),u=e.toString(),c=printStackTrace({e:e}),l={timestamp:new Date,browser:n.navigator.userAgent,errorUrl:n.location.href,errorMessage:u,stackTrace:c,cause:o||""};s.log(l),a.showMessage("error",u),i(l)}catch(e){r.warn("Error logging failed"),r.log(e)}}(o,a)}})}]),(Bahmni=Bahmni||{}).Common=Bahmni.Common||{},Bahmni.Common.DisplayControl=Bahmni.Common.DisplayControl||{},angular.module("bahmni.common.displaycontrol",[]),(Bahmni=Bahmni||{}).Common=Bahmni.Common||{},Bahmni.Common.DisplayControl=Bahmni.Common.DisplayControl||{},Bahmni.Common.DisplayControl.Observation=Bahmni.Common.DisplayControl.Observation||{},angular.module("bahmni.common.displaycontrol.observation",["bahmni.common.conceptSet","pascalprecht.translate"]),angular.module("bahmni.common.conceptSet").factory("formService",["$http",function(e){return{getFormList:function(t){return e.get(Bahmni.Common.Constants.latestPublishedForms,{params:{encounterUuid:t}})},getAllForms:function(){return e.get(Bahmni.Common.Constants.allFormsUrl,{params:{v:"custom:(version,name,uuid)"}})},getFormDetail:function(t,n){return e.get(Bahmni.Common.Constants.formUrl+"/"+t,{params:n})},getFormTranslations:function(t,n){return t&&t!==Bahmni.Common.Constants.formTranslationsUrl?e.get(t):e.get(Bahmni.Common.Constants.formTranslationsUrl,{params:n})},getFormTranslate:function(t,n,r,i){return e.get(Bahmni.Common.Constants.formBuilderTranslationApi,{params:{formName:t,formVersion:n,locale:r,formUuid:i}})},getAllPatientForms:function(t,n,r){const i=function(e,t){return e.replace("{patientUuid}",t)}(Bahmni.Common.Constants.patientFormsUrl,t),o={numberOfVisits:n,formType:"v2",patientProgramUuid:r};return e.get(i,{params:o})}}}]),Bahmni.Common.DisplayControl.Observation.GroupingFunctions=function(){var e=function(e){return Bahmni.Common.Util.DateUtil.getDateTimeWithoutSeconds(e.encounterDateTime)};return this.groupByEncounterDate=function(t){var n=[];t=_.groupBy(t,e);var r=function(e,t){return e.encounterDateTime<t.encounterDateTime?1:e.encounterDateTime>t.encounterDateTime?-1:e.conceptSortWeight<t.conceptSortWeight?-1:e.conceptSortWeight>t.conceptSortWeight?1:0};for(var i in t){var o=i,a={key:o,value:t[o].sort(r),date:o};n.push(a)}return _.sortBy(n,"date").reverse()},this.persistOrderOfConceptNames=function(e){var t=[];for(var n in e){var r={key:n,value:[e[n]],date:e[n].encounterDateTime};t.push(r)}return t},this},angular.module("bahmni.common.displaycontrol.observation").service("formHierarchyService",["formService",function(e){var t=this;t.build=function(e){var n=t.preProcessMultipleSelectObsToObs(e);n=t.createDummyObsGroupForObservationsForForm(n),t.createDummyObsGroupForSectionsForForm(n)},t.preProcessMultipleSelectObsToObs=function(e){return _.forEach(e,function(e){_.forEach(e.value,function(t,n){"multiSelect"==t.type&&(e.value.push(t.groupMembers[0]),e.value.splice(n,1))})}),e},t.createDummyObsGroupForObservationsForForm=function(e){return _.forEach(e,function(e){var t=[];_.forEach(e.value,function(e){if(e.formFieldPath){var n,r={groupMembers:[],concept:{shortName:"",conceptClass:null},encounterUuid:""};r.concept.shortName=e.formFieldPath.split(".")[0],r.encounterUuid=e.encounterUuid,_.forEach(t,function(t){r.concept.shortName==t.concept.shortName&&(t.groupMembers.push(e),n=!0)}),n||(r.groupMembers.push(e),t.push(r))}else t.push(e)}),e.value=t}),e},t.getFormVersion=function(e){var t;return _.forEach(e,function(e){if(e.formFieldPath)return t=e.formFieldPath.split(".")[1].split("/")[0],!1}),t},t.getMemberFromFormByFormFieldPath=function(e,t){return _.filter(e,function(e){return e.formFieldPath.split(".")[1].split("/")[1].split("-")[0]==t})},t.getFormByFormName=function(e,t,n){return _.find(e,function(e){return e.name==t&&e.version==n})},t.parseSection=function(e,n,r){var i=!0;return _.forEach(n,function(n){var o={groupMembers:[],concept:{shortName:"",conceptClass:null}};if("section"==n.type)o.concept.shortName=n.label.value,r.groupMembers.push(o),t.parseSection(e,n.controls,o)?i=!1:r.groupMembers.pop();else{var a=t.getMemberFromFormByFormFieldPath(e,n.id);0!=a.length&&(0!=a[0].formFieldPath.split("-")[1]&&_.reverse(a),_.map(a,function(e){r.groupMembers.push(e)}),i=!1)}}),i?null:r},t.createSectionForSingleForm=function(e,n){var r=e.groupMembers.slice();return e.groupMembers.splice(0,e.groupMembers.length),t.parseSection(r,n.controls,e)},t.createDummyObsGroupForSectionsForForm=function(n){_.isEmpty(n)||e.getAllForms().then(function(r){var i=r.data;_.forEach(n,function(n){var r=[];_.forEach(n.value,function(o){if(o.concept.conceptClass)r.push(o);else{var a=t.getFormByFormName(i,o.concept.shortName,t.getFormVersion(o.groupMembers));a&&e.getFormDetail(a.uuid,{v:"custom:(resources:(value))"}).then(function(e){var i=_.get(e,"data.resources[0].value");if(i){var a=JSON.parse(i);r.push(t.createSectionForSingleForm(o,a))}n.value=r})}})})})}}]),angular.module("bahmni.common.displaycontrol.observation").service("formRecordTreeBuildService",["formService","$window",function(e,t){var n=this;n.formBuildFroms=[],n.build=function(t,i){_.forEach(t,function(e){e.value=n.preProcessMultiSelectObs(e.value)}),i||e.getAllForms().then(function(e){var i=e.data,o=n.createObsGroupForForm(t,i);r(o,i)})},n.createMultiSelectObservation=function(e){var t=new Bahmni.Common.Obs.MultiSelectObservation(e,{multiSelect:!0});return t.formFieldPath=e[0].formFieldPath,t.encounterUuid=e[0].encounterUuid,t},n.preProcessMultiSelectObs=function(e){var t=_.cloneDeep(e);return _.forEach(t,function(t){if(t&&0===t.groupMembers.length){var r=n.getRecordObservations(t.formFieldPath,e);if(r.length>1){var i=n.createMultiSelectObservation(r);e.push(i)}else 1===r.length&&e.push(r[0])}else if(t.groupMembers.length>0){var o=n.getRecordObservations(t.formFieldPath,e);_.forEach(o,function(t){t.groupMembers=n.preProcessMultiSelectObs(t.groupMembers),e.push(t)})}}),e},n.createObsGroupForForm=function(e,t){return _.forEach(e,function(e){var n=[];_.forEach(e.value,function(e){if(e.formFieldPath){var r={groupMembers:[],concept:{shortName:"",conceptClass:null},encounterUuid:""},i=e.formFieldPath.split(".")[0],o=t.find(function(e){return e.name===i});r.concept.shortName=i;var a,s=localStorage.getItem("NG_TRANSLATE_LANG_KEY")||"en",u=o&&o.nameTranslation?JSON.parse(o.nameTranslation):[];if(u.length>0){var c=u.find(function(e){return e.locale===s});c&&(r.concept.shortName=c.display)}r.encounterUuid=e.encounterUuid,_.forEach(n,function(t){r.concept.shortName===t.concept.shortName&&(t.groupMembers.push(e),a=!0)}),a||(r.groupMembers.push(e),n.push(r))}else n.push(e)}),e.value=n}),e};var r=function(r,i){var o=i;_.forEach(r,function(r){var i=[];_.forEach(r.value,function(a){if(a.concept.conceptClass)i.push(a);else{var s=n.getFormByFormName(o,n.getFormName(a.groupMembers),n.getFormVersion(a.groupMembers));s&&e.getFormDetail(s.uuid,{v:"custom:(resources:(value))"}).then(function(o){var u=_.get(o,"data.resources[0].value");if(u){var c=JSON.parse(u);c.version=s.version;var l=t.localStorage.NG_TRANSLATE_LANG_KEY||"en";return e.getFormTranslate(c.name,c.version,l,c.uuid).then(function(e){var t=e.data;i.push(n.updateObservationsWithRecordTree(c,a,t)),r.value=i})}r.value=i})}})})};n.getFormByFormName=function(e,t,n){return _.find(e,function(e){return e.name===t&&e.version===n})},n.getFormName=function(e){var t=_.find(e,function(e){return null!==e.formFieldPath});return t?t.formFieldPath.split(".")[0]:void 0},n.getFormVersion=function(e){var t=_.find(e,function(e){return null!==e.formFieldPath});return t?t.formFieldPath.split(".")[1].split("/")[0]:void 0},n.updateObservationsWithRecordTree=function(e,t,r){var i=getRecordTree(e,t.groupMembers);return i=JSON.parse(JSON.stringify(i)),n.createGroupMembers(i,t,t.groupMembers,r),t},n.createColumnGroupsForTable=function(e,t,r,i,o){_.forEach(t,function(t,a){var s={groupMembers:[],concept:{shortName:"",conceptClass:null}},u=t.translationKey,c=t.value;s.concept.shortName=n.getTranslatedShortName(o,u,s,c);var l=n.getColumnObs(a,e);t.children=l,n.createGroupMembers(t,s,i,o),s.groupMembers.length>0&&r.groupMembers.push(s)})},n.getTranslatedShortName=function(e,t,r,i){return n.isTranslationKeyPresent(e,t)?e.labels[t][0]:i},n.isTranslationKeyPresent=function(e,t){return e&&e.labels&&e.labels[t][0]!==t},n.getColumnObs=function(e,t){var n=[];return _.map(t.children,function(t){t.control.properties&&t.control.properties.location.column===e&&n.push(t)}),n},n.createGroupMembers=function(e,t,r,i){_.forEach(e.children,function(e){if("obsControl"===e.control.type||"obsGroupControl"===e.control.type){var o=n.getRecordObservations(e.formFieldPath,r);_.forEach(o,function(e){t.groupMembers.push(e)})}else if("section"===e.control.type){var a=n.createObsGroup(e,i);n.createGroupMembers(e,a,r,i),a.groupMembers.length>0&&t.groupMembers.push(a)}else if("table"===e.control.type){var s=n.createObsGroup(e,i),u=e.control.columnHeaders;n.createColumnGroupsForTable(e,u,s,r,i),s.groupMembers.length>0&&t.groupMembers.push(s)}})},n.getTableColumns=function(e){return _.filter(e.control.columnHeaders,function(e){return"label"===e.type})},n.getRecordObservations=function(e,t){return _.remove(t,function(t){return t.formFieldPath&&t.formFieldPath===e})},n.createObsGroup=function(e,t){var r={groupMembers:[],concept:{shortName:"",conceptClass:null}},i=e.control.label.translationKey,o=e.control.label.value;return r.concept.shortName=n.getTranslatedShortName(t,i,r,o),r}}]),angular.module("bahmni.common.displaycontrol.observation").directive("bahmniObservation",["encounterService","observationsService","appService","$q","spinner","$rootScope","formRecordTreeBuildService","$translate",function(e,t,n,r,i,o,a,s){return{restrict:"E",controller:function(r){r.print=o.isBeingPrinted||!1,r.showGroupDateTime=!1!==r.config.showGroupDateTime;var i=function(e){var t=r.config.formType===Bahmni.Common.Constants.forms2Type?{}:n.getAppDescriptor().getConfigValue("conceptSetUI")||{};e=(new Bahmni.Common.Obs.ObservationMapper).map(e,t),r.config.conceptNames&&(e=_.filter(e,function(e){return _.some(r.config.conceptNames,function(t){return _.toLower(t)===_.toLower(_.get(e,"concept.name"))})})),r.config.persistOrderOfConcepts?r.bahmniObservations=(new Bahmni.Common.DisplayControl.Observation.GroupingFunctions).persistOrderOfConceptNames(e):r.bahmniObservations=(new Bahmni.Common.DisplayControl.Observation.GroupingFunctions).groupByEncounterDate(e),_.isEmpty(r.bahmniObservations)?(r.noObsMessage=s.instant(Bahmni.Common.Constants.messageForNoObservation),r.$emit("no-data-present-event")):r.showGroupDateTime?r.bahmniObservations[0].isOpen=!0:_.forEach(r.bahmniObservations,function(e){e.isOpen=!0}),_.filter(e,function(e){return e.formFieldPath}).length>0&&a.build(r.bahmniObservations,r.hasNoHierarchy)};r.translateAttributeName=function(e){var t=e.toUpperCase().replace(/\s\s+/g," ").replace(/[^a-zA-Z0-9 _]/g,"").trim().replace(/ /g,"_"),n=s.instant(t);return n},r.toggle=function(e){e.isOpen=!e.isOpen},r.isClickable=function(){return r.isOnDashboard&&r.section.expandedViewConfig&&(r.section.expandedViewConfig.pivotTable||r.section.expandedViewConfig.observationGraph)},function(){if(r.config.formType===Bahmni.Common.Constants.formBuilderDisplayControlType){var n=Bahmni.Common.Util.FormFieldPathUtil.getFormNameAndVersion;e.findByEncounterUuid(r.config.encounterUuid,{includeAll:!1}).then(function(e){var t=e.data,o=_.filter(t.observations,function(e){if(e.formFieldPath)return n(e.formFieldPath).formName===r.config.formName});i(o)}),r.title=r.config.formDisplayName}else if(r.observations)i(r.observations,r.config),r.isFulfilmentDisplayControl=!0;else if(r.config.observationUuid)r.initialization=t.getByUuid(r.config.observationUuid).then(function(e){i([e.data],r.config)});else if(r.config.encounterUuid){var o=t.fetchForEncounter(r.config.encounterUuid,r.config.conceptNames);r.initialization=o.then(function(e){i(e.data,r.config)})}else r.enrollment?r.initialization=t.fetchForPatientProgram(r.enrollment,r.config.conceptNames,r.config.scope,r.config.obsIgnoreList).then(function(e){i(e.data,r.config)}):r.initialization=t.fetch(r.patient.uuid,r.config.conceptNames,r.config.scope,r.config.numberOfVisits,r.visitUuid,r.config.obsIgnoreList,null).then(function(e){i(e.data,r.config)})}(),r.dialogData={patient:r.patient,section:r.section}},link:function(e,t){e.initialization&&i.forPromise(e.initialization,t)},templateUrl:"../common/displaycontrols/observation/views/observationDisplayControl.html",scope:{patient:"=",visitUuid:"@",section:"=?",config:"=",title:"=sectionTitle",isOnDashboard:"=?",observations:"=?",message:"=?",enrollment:"=?",hasNoHierarchy:"@"}}}]),(Bahmni=Bahmni||{}).Common=Bahmni.Common||{},Bahmni.Common.DisplayControl=Bahmni.Common.DisplayControl||{},Bahmni.Common.DisplayControl.PivotTable=Bahmni.Common.DisplayControl.PivotTable||{},angular.module("bahmni.common.displaycontrol",[]),angular.module("bahmni.common.displaycontrol.pivottable",[]),angular.module("bahmni.common.displaycontrol.pivottable").directive("pivotTable",["$rootScope","$filter","$stateParams","spinner","pivotTableService","appService","conceptSetUiConfigService","$interval",function(e,t,n,r,i,o,a,s){return{scope:{patientUuid:"=",diseaseName:"=",displayName:"=",config:"=",visitUuid:"=",status:"=?"},link:function(t,u){var c;if(t.config){t.groupBy=t.config.groupBy||"visits",t.groupByEncounters="encounters"===t.groupBy,t.groupByVisits="visits"===t.groupBy,t.getOnlyDate=function(e){return Bahmni.Common.Util.DateUtil.formatDateWithoutTime(e)},t.getOnlyTime=function(e){return Bahmni.Common.Util.DateUtil.formatTime(e)},t.isLonger=function(e){return!!e&&e.length>13},t.getColumnValue=function(e,n){return n&&a.getConfig()[n]&&1==a.getConfig()[n].displayMonthAndYear?Bahmni.Common.Util.DateUtil.getDateInMonthsAndYears(e):t.isLonger(e)?e.substring(0,10)+"...":e},t.scrollLeft=function(){return $("table.pivot-table tbody").animate({scrollLeft:0}),!1},t.scrollRight=function(){return $("table.pivot-table tbody").animate({scrollLeft:c}),!1};var l=null,m=null;(o.getAppDescriptor().getConfigValue("program")||{}).showDetailsWithinDateRange&&(l=n.dateEnrolled,m=n.dateCompleted);var f=s(function(){$("table.pivot-table tbody tr").length>11?($("table.pivot-table tbody").animate({scrollLeft:"20000px"},500),c=$("table.pivot-table tbody").scrollLeft(),clearInterval(f)):$("table.pivot-table tbody tr").length<12&&($(".btn-scroll-right, .btn-scroll-left").attr("disabled",!0),clearInterval(f))},1e3,2),p=i.getPivotTableFor(t.patientUuid,t.config,t.visitUuid,l,m);r.forPromise(p,u),p.then(function(e){var n=_.map(e.data.conceptDetails,function(e){return{name:e.fullName,shortName:e.name,lowNormal:e.lowNormal,hiNormal:e.hiNormal,units:e.units}}),r=_(e.data.tabularData).toPairs().sortBy(0).fromPairs().value();t.result={concepts:n,tabularData:r},t.hasData=!_.isEmpty(t.result.tabularData),t.status=t.status||{},t.status.data=t.hasData}),t.showOnPrint=!e.isBeingPrinted}},templateUrl:"../common/displaycontrols/pivottable/views/pivotTable.html"}}]),angular.module("bahmni.common.displaycontrol.pivottable").service("pivotTableService",["$http",function(e){this.getPivotTableFor=function(t,n,r,i,o){return e.get(Bahmni.Common.Constants.diseaseSummaryPivotUrl,{params:{patientUuid:t,visit:r,numberOfVisits:n.numberOfVisits,initialCount:n.initialCount,latestCount:n.latestCount,obsConcepts:n.obsConcepts,drugConcepts:n.drugConcepts,labConcepts:n.labConcepts,groupBy:n.groupBy,startDate:Bahmni.Common.Util.DateUtil.parseLongDateToServerFormat(i),endDate:Bahmni.Common.Util.DateUtil.parseLongDateToServerFormat(o)}})}}]),(Bahmni=Bahmni||{}).Common=Bahmni.Common||{},Bahmni.Common.DisplayControl=Bahmni.Common.DisplayControl||{},Bahmni.Common.DisplayControl.Custom=Bahmni.Common.DisplayControl.Custom||{},angular.module("bahmni.common.displaycontrol.custom",[]),angular.module("bahmni.common.displaycontrol.custom").directive("customDisplayControl",[function(){return{restrict:"E",template:'<div compile-html="config.template"></div>',scope:{patient:"=",visitUuid:"=",section:"=",config:"=",enrollment:"=",params:"=",visitSummary:"="}}}]),(Bahmni=Bahmni||{}).Common=Bahmni.Common||{},Bahmni.Common.Obs=Bahmni.Common.Obs||{},angular.module("bahmni.common.obs",[]),Bahmni.Common.Obs.Observation=function(){var e=function(e,t){angular.extend(this,e),this.concept=e.concept,this.conceptConfig=t};return e.prototype={isFormElement:function(){return this.groupMembers&&this.groupMembers.length<=0},isImageConcept:function(){return"Image"===this.concept.conceptClass},isVideoConcept:function(){return"Video"===this.concept.conceptClass},hasPDFAsValue:function(){return this.value.indexOf(".pdf")>0},isComplexConcept:function(){return"Complex"===this.concept.dataType},getComplexDataType:function(){return this.complexData?this.complexData.dataType:null},isLocationRef:function(){return this.isComplexConcept()&&"Location"===this.getComplexDataType()},isProviderRef:function(){return this.isComplexConcept()&&"Provider"===this.getComplexDataType()},getDisplayValue:function(){var e;if("Boolean"===this.type||this.concept&&"Boolean"===this.concept.dataType)return!0===this.value?"OBS_BOOLEAN_YES_KEY":"OBS_BOOLEAN_NO_KEY";if("Datetime"===this.type||this.concept&&"Datetime"===this.concept.dataType){var t=Bahmni.Common.Util.DateUtil.parseDatetime(this.value);return null!=t?Bahmni.Common.Util.DateUtil.formatDateWithTime(t):""}if(this.conceptConfig&&this.conceptConfig.displayMonthAndYear&&null!=(e=Bahmni.Common.Util.DateUtil.getDateInMonthsAndYears(this.value)))return e;if("Date"===this.type||this.concept&&"Date"===this.concept.dataType)return this.value?Bahmni.Common.Util.DateUtil.formatDateWithoutTime(this.value):"";if(this.isLocationRef())return this.complexData.display;if(this.isProviderRef())return this.complexData.display;var n=(e=this.value)&&(e.shortName||e.name&&(e.name.name||e.name)||e);return this.duration&&(n=n+" "+this.getDurationDisplayValue()),n},getDurationDisplayValue:function(){var e=Bahmni.Common.Util.DateUtil.convertToUnits(this.duration);return"since "+e.value+" "+e.unitName}},e}(),Bahmni.Common.Obs.MultiSelectObservation=function(){var e=function(e,n){this.type="multiSelect",this.concept=e[0].concept,this.encounterDateTime=e[0].encounterDateTime,this.groupMembers=e,this.conceptConfig=n,this.observationDateTime=t(this.groupMembers),this.providers=e[0].providers,this.creatorName=e[0].creatorName},t=function(e){var t=e[0].observationDateTime;return e.forEach(function(e){t=t<e.observationDateTime?e.observationDateTime:t}),t};return e.prototype={isFormElement:function(){return!0},getDisplayValue:function(){var e=Bahmni.Common.Domain.ObservationValueMapper.getNameFor.Object;return _.map(this.groupMembers,e).join(", ")}},e}(),Bahmni.Common.Obs.GridObservation=function(){var e=new Bahmni.Common.Domain.ConceptMapper,t=function(e,t){angular.extend(this,e),this.type="grid",this.conceptConfig=t};return t.prototype={isFormElement:function(){return!0},getDisplayValue:function(){return _.compact(_.map(this.groupMembers,function(t){return function(t){if(t.isBoolean||"Boolean"===t.type)return!0===t.value?"OBS_BOOLEAN_YES_KEY":"OBS_BOOLEAN_NO_KEY";if(!t.value)return"";if("object"==typeof t.value.name){var n=e.map(t.value);return n.shortName||n.name}return t.value.shortName||t.value.name||t.value}(t)})).join(", ")||this.value}},t}(),Bahmni.Common.Obs.ImageObservation=function(e,t,n){this.concept=t,this.imageObservation=e,this.dateTime=e.observationDateTime,this.provider=n},Bahmni.Common.Obs.ObservationMapper=function(){var e=new Bahmni.Common.Domain.ConceptMapper;this.map=function(e,r,i){var o=t(e,r,i);return n(o,r)};var t=function(e,n,r){var i=[];return e=r?_.flatten(e):Bahmni.Common.Obs.ObservationUtil.sortSameConceptsWithObsDateTime(e),$.each(e,function(e,o){var a=o.formFieldPath?[]:n[o.concept.name]||[],s=new Bahmni.Common.Obs.Observation(o,a);s.groupMembers&&s.groupMembers.length>=0&&(s.groupMembers=t(s.groupMembers,n,r)),i.push(s)}),i},n=function(e,t){var r=_.groupBy(e,function(e){return e.formFieldPath+"#"+e.concept.name}),i=[];return $.each(r,function(e,r){var o=r[0].formFieldPath?[]:t[r[0].concept.name]||[];if(o.multiSelect){var a={};$.each(r,function(e,t){if(a[t.encounterDateTime])a[t.encounterDateTime].push(t);else{var n=[];n.push(t),a[t.encounterDateTime]=n}}),$.each(a,function(e,t){i.push(new Bahmni.Common.Obs.MultiSelectObservation(t,o))})}else o.grid?i.push(new Bahmni.Common.Obs.GridObservation(r[0],o)):$.each(r,function(e,r){r.groupMembers=n(r.groupMembers,t),i.push(r)})}),i};this.getGridObservationDisplayValue=function(e){return _.compact(_.map(e.bahmniObservations,function(e){return r(e)})).join(", ")};var r=function(t){if(t.isBoolean||"Boolean"===t.type)return!0===t.value?"Yes":"No";if(!t.value)return"";if("object"==typeof t.value.name){var n=e.map(t.value);return n.shortName||n.name}return t.value.shortName||t.value.name||t.value}},angular.module("bahmni.common.obs").directive("showObservation",["ngDialog",function(e){return{restrict:"E",scope:{observation:"=?",patient:"=",showDate:"=?",showTime:"=?",showDetailsButton:"=?"},controller:function(t,n,r){t.toggle=function(e){e.showDetails=!e.showDetails},t.print=n.isBeingPrinted||!1,t.dateString=function(e){var n;if(t.showDate&&t.showTime)n="bahmniDateTime";else{if(t.showDate||!t.showTime&&void 0!==t.showTime)return null;n="bahmniTime"}return r(n)(e.observationDateTime)},t.openVideoInPopup=function(t){e.open({template:"../common/obs/views/showVideo.html",closeByDocument:!1,className:"ngdialog-theme-default",showClose:!0,data:{observation:t}})}},template:"<ng-include src=\"'../common/obs/views/showObservation.html'\" />"}}]),Bahmni.Common.Obs.ObservationUtil=function(){var e=function(t,n){_.isEmpty(n.groupMembers)?function(e,t,n){null!=n&&(e[t]=e[t]?_.uniq(_.flatten(_.union([e[t]],[n]))):n)}(t,n.concept.name,function(e){return e.selectedObs?e.getValues():null==(t=e.value&&e.value.name&&e.value.name.name?e.value.name.name:e.value&&e.value.name&&!e.value.name.name?e.value.name:e.value)?t:t.displayString||t;var t}(n)):_.each(n.groupMembers,function(n){e(t,n)})},t=function(e){var n=[];return n.push.apply(n,e),e.forEach(function(e){e.groupMembers&&e.groupMembers.length>0&&n.push.apply(n,t(e.groupMembers))}),n};return{sortSameConceptsWithObsDateTime:function(e){for(var t=[],n=0;n<e.length;n++)if(n!==e.length-1)if(e[n].conceptUuid!==e[n+1].conceptUuid)t.push(e[n]);else{var r=[],i=n+1;for(r.push(e[n]);i<e.length&&e[n].conceptUuid===e[i].conceptUuid;)r.push(e[i++]);r=_.sortBy(r,"observationDateTime"),t.push(r),n=i-1}else t.push(e[n]);return _.flatten(t)},flatten:function(t){var n={};return _.isEmpty(t)||e(n,t),n},flattenObsToArray:t}}(),(Bahmni=Bahmni||{}).Common=Bahmni.Common||{},Bahmni.Common.DisplayControl=Bahmni.Common.DisplayControl||{},Bahmni.Common.DisplayControl.hint=Bahmni.Common.DisplayControl.hint||{},angular.module("bahmni.common.displaycontrol.hint",[]),angular.module("bahmni.common.displaycontrol.hint").directive("hint",[function(){return{restrict:"E",link:function(e){e.hintForNumericConcept=Bahmni.Common.Domain.Helper.getHintForNumericConcept(e.conceptDetails)},template:'<small class="hint" ng-if="::hintForNumericConcept">{{::hintForNumericConcept}}</small>',scope:{conceptDetails:"="}}}]),Bahmni.Common.Domain.Diagnosis=function(e,t,n,r,i,o,a){var s=this;s.codedAnswer=e,s.order=t,s.certainty=n,s.existingObs=r,s.freeTextAnswer=i,s.diagnosisDateTime=o,s.diagnosisStatus=void 0,s.isNonCodedAnswer=!1,s.codedAnswer&&(s.conceptName=s.codedAnswer.name),s.voided=a,s.firstDiagnosis=null,s.comments="",s.getDisplayName=function(){return s.freeTextAnswer?s.freeTextAnswer:s.codedAnswer.shortName||s.codedAnswer.name},s.isPrimary=function(){return"PRIMARY"==s.order},s.isSecondary=function(){return"SECONDARY"==s.order},s.isRuledOut=function(){return s.diagnosisStatus==$rootScope.diagnosisStatus},s.answerNotFilled=function(){return!s.codedAnswer.name},s.isValidAnswer=function(){return s.codedAnswer.name&&s.codedAnswer.uuid||s.codedAnswer.name&&!s.codedAnswer.uuid&&s.isNonCodedAnswer||s.answerNotFilled()},s.isValidOrder=function(){return s.isEmpty()||void 0!==s.order},s.isValidCertainty=function(){return s.isEmpty()||void 0!==s.certainty},s.isEmpty=function(){return void 0===s.getDisplayName()||0===s.getDisplayName().length},s.diagnosisStatusValue=null,s.diagnosisStatusConcept=null,Object.defineProperty(this,"diagnosisStatus",{get:function(){return this.diagnosisStatusValue},set:function(e){e?(this.diagnosisStatusValue=e,this.diagnosisStatusConcept={name:Bahmni.Common.Constants.ruledOutdiagnosisStatus}):(this.diagnosisStatusValue=null,this.diagnosisStatusConcept=null)}}),s.clearCodedAnswerUuid=function(){s.codedAnswer.uuid=void 0},s.setAsNonCodedAnswer=function(){s.isNonCodedAnswer=!s.isNonCodedAnswer}},Bahmni.DiagnosisMapper=function(e){var t=function(n){n.codedAnswer||(n.codedAnswer={name:void 0,uuid:void 0});var r=angular.extend(new Bahmni.Common.Domain.Diagnosis,n);return r.firstDiagnosis&&(r.firstDiagnosis=t(r.firstDiagnosis)),r.latestDiagnosis&&(r.latestDiagnosis=t(r.latestDiagnosis)),n.diagnosisStatusConcept&&Bahmni.Common.Constants.ruledOutdiagnosisStatus===n.diagnosisStatusConcept.name&&(r.diagnosisStatus=e),r};this.mapDiagnosis=t,this.mapDiagnoses=function(e){var n=[];return _.each(e,function(e){n.push(t(e))}),n},this.mapPastDiagnosis=function(e,t){var n=[];return e.forEach(function(e){e.encounterUuid!==t&&(e.previousObs=e.existingObs,e.existingObs=null,e.inCurrentEncounter=void 0,n.push(e))}),n},this.mapSavedDiagnosesFromCurrentEncounter=function(e,t){var n=[];return e.forEach(function(e){e.encounterUuid===t&&(e.inCurrentEncounter=!0,n.push(e))}),n}},angular.module("bahmni.common.domain").service("diagnosisService",["$http","$rootScope",function(e,t){var n=this;this.getAllFor=function(t,n){var r=Bahmni.Common.Constants.emrapiConceptUrl,i={term:t,limit:20};return n&&(i.locale=n),e.get(r,{params:i})},this.getDiagnoses=function(t,n){var r=Bahmni.Common.Constants.bahmniDiagnosisUrl;return e.get(r,{params:{patientUuid:t,visitUuid:n}})},this.deleteDiagnosis=function(t){var n=Bahmni.Common.Constants.bahmniDeleteDiagnosisUrl;return e.get(n,{params:{obsUuid:t}})},this.getDiagnosisConceptSet=function(){return e.get(Bahmni.Common.Constants.conceptUrl,{method:"GET",params:{v:"custom:(uuid,name,setMembers)",code:Bahmni.Common.Constants.diagnosisConceptSet,source:Bahmni.Common.Constants.emrapiConceptMappingSource},withCredentials:!0})},this.getPastAndCurrentDiagnoses=function(e,r){return n.getDiagnoses(e).then(function(e){var n=new Bahmni.DiagnosisMapper(t.diagnosisStatus),i=n.mapDiagnoses(e.data);return{pastDiagnoses:n.mapPastDiagnosis(i,r),savedDiagnosesFromCurrentEncounter:n.mapSavedDiagnosesFromCurrentEncounter(i,r)}})},this.populateDiagnosisInformation=function(e,t){return this.getPastAndCurrentDiagnoses(e,t.encounterUuid).then(function(e){return t.pastDiagnoses=e.pastDiagnoses,t.savedDiagnosesFromCurrentEncounter=e.savedDiagnosesFromCurrentEncounter,t})}}]),(Bahmni=Bahmni||{}).Common=Bahmni.Common||{},Bahmni.Common.DisplayControl=Bahmni.Common.DisplayControl||{},Bahmni.Common.DisplayControl.Diagnosis=Bahmni.Common.DisplayControl.Diagnosis||{},angular.module("bahmni.common.displaycontrol.diagnosis",[]),angular.module("bahmni.common.displaycontrol.diagnosis").filter("primaryDiagnosisFirst",function(){return function(e){var t=_.filter(e,function(e){return e.isPrimary()}),n=_.filter(e,function(e){return!e.isPrimary()});return t.concat(n)}}),angular.module("bahmni.common.displaycontrol.diagnosis").directive("bahmniDiagnosis",["diagnosisService","$q","spinner","$rootScope","$filter","$translate",function(e,t,n,r,i,o){return{restrict:"E",controller:function(n){n.title=n.config.title,n.toggle=function(e,t){t?(e.showDetails=!1,e.showLatestDetails=!e.showLatestDetails):(e.showLatestDetails=!1,e.showDetails=!e.showDetails)};n.isLatestDiagnosis=function(e){return!!e.latestDiagnosis&&e.existingObs==e.latestDiagnosis.existingObs},n.translateDiagnosisLabels=function(e,t){if(e){var n="CLINICAL_DIAGNOSIS_"+t+"_"+e.toUpperCase(),r=o.instant(n);if(r!=n)return r}return e},n.initialization=t.all([e.getDiagnoses(n.patientUuid,n.visitUuid).then(function(e){var t=new Bahmni.DiagnosisMapper(r.diagnosisStatus);n.allDiagnoses=t.mapDiagnoses(e.data),0==n.showRuledOutDiagnoses&&(n.allDiagnoses=_.filter(n.allDiagnoses,function(e){return e.diagnosisStatus!==r.diagnosisStatus})),n.isDataPresent=function(){return!n.allDiagnoses||0!=n.allDiagnoses.length||(n.$emit("no-data-present-event"),!1)}})])},link:function(e,t){n.forPromise(e.initialization,t)},templateUrl:"../common/displaycontrols/diagnosis/views/diagnosisDisplayControl.html",scope:{patientUuid:"=",config:"=",visitUuid:"=?",showRuledOutDiagnoses:"=?",hideTitle:"=?",showLatestDiagnosis:"@showLatestDiagnosis"}}}]),(Bahmni=Bahmni||{}).Common=Bahmni.Common||{},Bahmni.Common.I18n=Bahmni.Common.I18n||{},angular.module("bahmni.common.i18n",[]),angular.module("bahmni.common.i18n",["pascalprecht.translate"]).provider("$bahmniTranslate",["$translateProvider",function(e){this.init=function(t){var n=window.localStorage.NG_TRANSLATE_LANG_KEY||"en";e.useLoader("mergeLocaleFilesService",t),e.useSanitizeValueStrategy("escaped"),e.preferredLanguage(n),e.useLocalStorage()},this.$get=[function(){return e}]}]).filter("titleTranslate",["$translate",function(e){return function(t){return t?t.translationKey?e.instant(t.translationKey):t.dashboardName?t.dashboardName:t.title?t.title:t.label?t.label:t.display?t.display:e.instant(t):t}}]),angular.module("bahmni.common.i18n").service("mergeLocaleFilesService",["$http","$q","mergeService",function(e,t,n){return function(r){var i=Bahmni.Common.Constants.rootDir+"/bahmni_config/openmrs/i18n/",o=function(t){return e.get(t,{withCredentials:!0})};return function(e){var r=e.app+"/locale_"+e.key+".json";return t.all([o("../i18n/"+r).then(function(e){return e},function(){}),o(i+r).then(function(e){return e},function(){})]).then(function(t){var r=t[0]?t[0].data:void 0,i=t[1]?t[1].data:void 0;return e.shouldMerge||void 0===e.shouldMerge?n.merge(r,i):[r,i]})}(r)}}]),(Bahmni=Bahmni||{}).Registration=Bahmni.Registration||{},Bahmni.Registration.AttributesConditions=Bahmni.Registration.AttributesConditions||{},angular.module("bahmni.registration",["ui.router","bahmni.common.config","bahmni.common.domain","bahmni.common.util","bahmni.common.uiHelper","bahmni.common.conceptSet","infinite-scroll","bahmni.common.patient","bahmni.common.logging","pascalprecht.translate"]),angular.module("registration",["ui.router","bahmni.registration","authentication","bahmni.common.config","bahmni.common.appFramework","httpErrorInterceptor","bahmni.common.photoCapture","bahmni.common.obs","bahmni.common.displaycontrol.observation","bahmni.common.i18n","bahmni.common.displaycontrol.custom","bahmni.common.routeErrorHandler","bahmni.common.displaycontrol.pivottable","RecursionHelper","ngSanitize","bahmni.common.uiHelper","bahmni.common.domain","ngDialog","pascalprecht.translate","ngCookies","monospaced.elastic","bahmni.common.displaycontrol.hint","bahmni.common.attributeTypes","bahmni.common.models","bahmni.common.uicontrols","bahmni.common.displaycontrol.diagnosis"]).config(["$urlRouterProvider","$stateProvider","$httpProvider","$bahmniTranslateProvider","$compileProvider",function(e,t,n,r,i){n.defaults.headers.common["Disable-WWW-Authenticate"]=!0,e.otherwise("/search"),i.debugInfoEnabled(!1),t.state("search",{url:"/search",reloadOnSearch:!1,views:{layout:{templateUrl:"views/layout.html",controller:"SearchPatientController"},"content@search":{templateUrl:"views/search.html"}},resolve:{initialize:function(e){return e()}}}).state("newpatient",{url:"/patient/new",views:{layout:{templateUrl:"views/layout.html",controller:"CreatePatientController"},"content@newpatient":{templateUrl:"views/newpatient.html"}},resolve:{initialize:function(e){return e()}}}).state("patient",{url:"/patient/:patientUuid",abstract:!0,views:{layout:{template:'<div ui-view="layout"></div>'}},resolve:{initialize:function(e){return e()}}}).state("patient.edit",{url:"?serverError",views:{layout:{templateUrl:"views/layout.html",controller:"EditPatientController"},"content@patient.edit":{templateUrl:"views/editpatient.html"},"headerExtension@patient.edit":{template:"<div print-options></div>"}}}).state("patient.visit",{url:"/visit",views:{layout:{templateUrl:"views/layout.html",controller:"VisitController"},"content@patient.visit":{templateUrl:"views/visit.html"},"headerExtension@patient.visit":{template:"<div print-options></div>"}}}).state("patient.printSticker",{url:"/printSticker",views:{layout:{templateUrl:"views/layout.html"},"content@patient.printSticker":{templateUrl:"views/notimplemented.html"}}}),r.init({app:"registration",shouldMerge:!0})}]).run(["$rootScope","$templateCache","$bahmniCookieStore","locationService","messagingService","auditLogService","$window",function(e,t,n,r,i,o,a){moment.locale(a.localStorage.NG_TRANSLATE_LANG_KEY||"en");var s=n.get(Bahmni.Common.Constants.locationCookieName).uuid;r.getVisitLocation(s).then(function(t){t.data&&(e.visitLocation=t.data.uuid)}),e.$on("$stateChangeStart",function(){i.hideMessages("error")}),e.createAuditLog=function(e,t,n,r){(function(e,t){var n=[];return"newpatient"!==t||"patient.edit"!==e&&"patient.visit"!==e||n.push("newpatient.save"),"patient.edit"===e?n.push("patient.view"):n.push(e),n})(t.name,r.name).forEach(function(e){o.log(n.patientUuid,Bahmni.Registration.StateNameEvenTypeMap[e],void 0,"MODULE_LABEL_REGISTRATION_KEY")})},e.$on("$stateChangeSuccess",e.createAuditLog)}]),angular.module("bahmni.registration").factory("initialization",["$rootScope","$q","configurations","authenticator","appService","spinner","preferences","locationService","mergeService","$translate",function(e,t,n,r,i,o,a,s,u,c){var l=function(){return n.load(["encounterConfig","patientAttributesConfig","identifierTypesConfig","addressLevels","genderMap","relationshipTypeConfig","relationshipTypeMap","loginLocationToVisitTypeMapping"]).then(function(){var t=i.getAppDescriptor().getConfigValue("mandatoryPersonAttributes"),r=(new Bahmni.Common.Domain.AttributeTypeMapper).mapFromOpenmrsAttributeTypes(n.patientAttributesConfig(),t,{},e.currentUser.userProperties.defaultLocale);e.regEncounterConfiguration=angular.extend(new Bahmni.Registration.RegistrationEncounterConfig,n.encounterConfig()),e.encounterConfig=angular.extend(new EncounterConfig,n.encounterConfig()),e.patientConfiguration=new Bahmni.Registration.PatientConfig(r.attributeTypes,n.identifierTypesConfig(),i.getAppDescriptor().getConfigValue("patientInformation")),e.regEncounterConfiguration.loginLocationToVisitTypeMap=n.loginLocationToVisitTypeMapping(),e.addressLevels=n.addressLevels(),e.fieldValidation=i.getAppDescriptor().getConfigValue("fieldValidation"),e.genderMap=n.genderMap(),Bahmni.Common.Util.GenderUtil.translateGender(e.genderMap,c),e.relationshipTypeMap=n.relationshipTypeMap(),e.relationshipTypes=n.relationshipTypes()})},m=function(){return i.initApp("registration",{app:!0,extension:!0})},f=function(){e.registration=e.registration||{},a.identifierPrefix=i.getAppDescriptor().getConfigValue("defaultIdentifierPrefix")},p=function(){var t=e.relationshipTypeMap||{};return t.provider?void e.relationshipTypes.forEach(function(e){e.searchType=t.provider.indexOf(e.aIsToB)>-1?"provider":"patient"}):"patient"},d=function(){return s.getLoggedInLocation().then(function(t){e.loggedInLocation=t})},h=function(){var e=Bahmni.ConceptSet.FormConditions;e&&(e.rules=u.merge(e.rules,e.rulesOverride))},g=function(){return i.checkPrivilege("app:registration")};return function(){return o.forPromise(r.authenticateUser().then(m).then(g).then(l).then(f).then(p).then(d).then((e=i.configBaseUrl(),t="registration",n=e+t+"/fieldValidation.js",void Bahmni.Common.Util.DynamicResourceLoader.includeJs(n,!1))).then(h));var e,t,n}}]);var defaults={maxAutocompleteResults:20};(Bahmni=Bahmni||{}).Registration=Bahmni.Registration||{};var hostUrl=Bahmni.Common.Constants.hostURL,RESTWS_V1=hostUrl+"/openmrs/ws/rest/v1";Bahmni.Registration.Constants={openmrsUrl:hostUrl+"/openmrs",registrationEncounterType:"REG",baseOpenMRSRESTURL:RESTWS_V1,patientImageUrlByPatientUuid:RESTWS_V1+"/patientImage?patientUuid=",bahmniRESTBaseURL:hostUrl+"/openmrs/ws/rest/v1/bahmnicore",emrApiRESTBaseURL:hostUrl+"/openmrs/ws/rest/emrapi",emrApiEncounterUrl:hostUrl+"/openmrs/ws/rest/emrapi/encounter",webServiceRestBaseURL:hostUrl+"/openmrs/ws/rest/v1",patientSearchURL:"/search",allAddressFileds:["uuid","preferred","address1","address2","address3","address4","address5","address6","cityVillage","countyDistrict","stateProvince","postalCode","country","latitude","longitude"],nextStepConfigId:"org.bahmni.registration.patient.next",patientNameDisplayOrder:["firstName","middleName","lastName","surname"]},Bahmni.Registration.Constants.Errors={manageIdentifierSequencePrivilege:"You don't have the privilege to create a patient with the given ID."},angular.module("bahmni.common.patient").directive("fallbackSrc",function(){return{restrict:"A",link:function(e,t,n){_.isEmpty(n.ngSrc)&&t.attr("src",n.fallbackSrc),t.bind("error",function(){t.attr("src",n.fallbackSrc)})}}}),angular.module("bahmni.registration").directive("addressFields",function(){return{restrict:"AE",templateUrl:" views/addressFields.html",controller:"AddressFieldsDirectiveController",scope:{address:"=",addressLevels:"=",fieldValidation:"=",strictAutocompleteFromLevel:"="}}}).controller("AddressFieldsDirectiveController",["$scope","addressHierarchyService","$translate",function(e,t,n){var r=e.addressLevels.slice(0).reverse();e.addressLevelsChunks=Bahmni.Common.Util.ArrayUtil.chunk(r,2);var i=r.map(function(e){return e.addressField});e.addressFieldSelected=function(t){return function(n){var r=i.slice(i.indexOf(t)+1);e.selectedValue[t]=n.addressField.name;var o=n.addressField.parent;r.forEach(function(t){o&&(e.address[t]=o.name,e.selectedValue[t]=o.name,o=o.parent)})}},e.getTranslatedAddressFields=function(e){return Bahmni.Common.Util.TranslationUtil.translateAttribute(e,Bahmni.Common.Constants.registration,n)},e.removeAutoCompleteEntry=function(t){return function(){e.selectedValue[t]=null}},e.getAddressEntryList=function(e){return function(n){return t.search(e,n.term)}},e.getAddressDataResults=t.getAddressDataResults,e.clearFields=function(t){i.slice(0,i.indexOf(t)).forEach(function(t){_.isEmpty(e.selectedValue[t])||(e.address[t]=null,e.selectedValue[t]=null)})};!function(){e.addressLevels.reverse();var t=!1;_.each(e.addressLevels,function(n){n.isStrictEntry=e.strictAutocompleteFromLevel==n.addressField||t,t=n.isStrictEntry}),e.addressLevels.reverse();var n=e.$watch("address",function(t){void 0!==t&&(e.selectedValue=_.mapValues(e.address,function(t,n){var r=_.find(e.addressLevels,{addressField:n});return r&&r.isStrictEntry?t:null}),n())})}()}]),angular.module("bahmni.registration").directive("topDownAddressFields",function(){return{restrict:"AE",templateUrl:"views/topDownAddressFields.html",controller:"TopDownAddressFieldsDirectiveController",scope:{address:"=",addressLevels:"=",fieldValidation:"=",strictAutocompleteFromLevel:"="}}}).controller("TopDownAddressFieldsDirectiveController",["$scope","addressHierarchyService","$translate",function(e,t,n){e.addressFieldInvalid=!1;var r={},i={},o=e.addressLevels.slice(0).reverse(),a=e.addressLevels;e.addressLevelsChunks=Bahmni.Common.Util.ArrayUtil.chunk(a,2);var s=o.map(function(e){return e.addressField}),u=function(n,o){if(0!==e.addressLevels.length&&e.addressLevels[n]){var a=e.addressLevels[n].addressField,s=e.address[a];s&&t.search(a,s,o).then(function(e){var t=e&&e.data&&e.data[0];t&&(r[a]=t.uuid,i[a]=t.userGeneratedId,u(n+1,t.uuid))})}};e.getTranslatedTopAddress=function(e){return Bahmni.Common.Util.TranslationUtil.translateAttribute(e,Bahmni.Common.Constants.registration,n)},e.addressFieldSelected=function(t){return function(n){r[t]=n.addressField.uuid,i[t]=n.addressField.userGeneratedId,e.selectedValue[t]=n.addressField.name;var o=s.slice(s.indexOf(t)+1),a=n.addressField.parent;o.forEach(function(t){a&&(e.address[t]=a.name,e.selectedValue[t]=a.name,a=a.parent)})}},e.findParentField=function(t){var n,r=_.find(e.addressLevels,{addressField:t}),i=_.findIndex(e.addressLevels,r);0!==i&&(n=e.addressLevels[i-1].addressField);return n},e.isReadOnly=function(t){if(!e.address)return!1;if(!t.isStrictEntry)return!1;var n=t.addressField,r=e.findParentField(n),i=e.address[r],o=c(r);return!!r&&(!(!r||i)||r&&i&&o)};var c=function(e){return angular.element($("#"+e)).hasClass("illegalValue")};e.getAddressEntryList=function(n){return function(i){return t.search(n,i.term,function(t){return r[e.findParentField(t)]}(n))}},e.getAddressDataResults=t.getAddressDataResults,e.clearFields=function(t){s.slice(0,s.indexOf(t)).forEach(function(t){null!==e.selectedValue[t]&&(e.address[t]=null,e.selectedValue[t]=null,r[t]=null,i[t]=null)}),_.isEmpty(e.address[t])&&(e.address[t]=null,i[t]=null)},e.removeAutoCompleteEntry=function(t){return function(){e.selectedValue[t]=null}};!function(){e.addressLevels.reverse();var t=!1;_.each(e.addressLevels,function(n){n.isStrictEntry=e.strictAutocompleteFromLevel==n.addressField||t,t=n.isStrictEntry}),e.addressLevels.reverse();var n=e.$watch("address",function(t){void 0!==t&&(u(0),e.selectedValue=_.mapValues(e.address,function(t,n){var r=_.find(e.addressLevels,{addressField:n});return r&&r.isStrictEntry?t:null}),n())})}()}]),angular.module("bahmni.registration").directive("printOptions",["$rootScope","registrationCardPrinter","spinner","appService","$filter",function(e,t,n,r,i){return{restrict:"A",templateUrl:"views/printOptions.html",controller:function(e){e.printOptions=r.getAppDescriptor().getConfigValue("printOptions"),e.defaultPrint=e.printOptions&&e.printOptions[0];e.print=function(n){return t.print(n.templateUrl,e.patient,function(){var t={};e.observations=e.observations||[];var n=function(e){t[e.concept.name]=t[e.concept.name]||[],e.value&&t[e.concept.name].push(e.value),e.groupMembers.forEach(n)};return e.observations.forEach(n),t}(),e.encounterDateTime)},e.buttonText=function(e,t){var n="";return t&&(n='<i class="fa fa-print"></i>'),"<span>"+(e&&i("titleTranslate")(e))+"</span>"+n}}}}]),angular.module("bahmni.registration").directive("patientRelationship",function(){return{restrict:"AE",templateUrl:"views/patientRelationships.html",controller:"PatientRelationshipController",scope:{patient:"="}}}).controller("PatientRelationshipController",["$window","$scope","$rootScope","spinner","patientService","providerService","appService","$q",function(e,t,n,r,i,o,a,s){t.addPlaceholderRelationship=function(){t.patient.newlyAddedRelationships.push({})},t.removeRelationship=function(e,n){e.uuid?(e.voided=!0,t.patient.deletedRelationships.push(e)):t.patient.newlyAddedRelationships.splice(n,1)},t.isPatientRelationship=function(e){var t=u(e);return t&&(_.isUndefined(t.searchType)||"patient"===t.searchType)};var u=function(e){return!angular.isUndefined(e.relationshipType)&&t.getRelationshipType(e.relationshipType.uuid)};t.getChosenRelationshipType=function(e){return t.isPatientRelationship(e)?"patient":t.isProviderRelationship(e)?"provider":void 0},t.isProviderRelationship=function(e){var t=u(e);return t&&"provider"===t.searchType},t.getRelationshipType=function(e){return _.find(t.relationshipTypes,{uuid:e})},t.getRelationshipTypeForDisplay=function(e){var n=t.patient.uuid,r=t.getRelationshipType(e.relationshipType.uuid);return e.personA?e.personA.uuid===n?r.aIsToB:r.bIsToA:""},t.getRelatedToPersonForDisplay=function(e){var t=m(e);return t?t.display:""};var c=function(e){return e.givenName+(e.middleName?" "+e.middleName:"")+(e.familyName?" "+e.familyName:"")+(e.surname?" "+e.surname:"")},l=function(e,t){return{display:e,uuid:t}};t.searchByPatientIdentifier=function(e){return e.patientIdentifier?(e.hasOwnProperty("personB")&&(e.personB=null),i.searchByIdentifier(e.patientIdentifier).then(function(t){if(!angular.isUndefined(t)){var n=t.data.pageOfResults;if(0!==n.length){e.content=b(n[0]);var r=n[0].uuid,i=c(n[0]);e.personB=l(i,r)}}})):(e.personB=null,void(e.content=null))},t.showPersonNotFound=function(e){return e.patientIdentifier&&!e.personB&&"patient"!==t.getChosenRelationshipType(e)},t.isInvalidRelation=function(e){return _.isEmpty(_.get(e,"personB.uuid"))||t.duplicateRelationship(e)},t.duplicateRelationship=function(e){if(_.isEmpty(e.relationshipType)||_.isEmpty(e.personB))return!1;var n=h(t.patient,e.relationshipType.uuid);return _.get(_.countBy(n,_.identity),e.personB.uuid,0)>1};var m=function(e){return e.personA&&e.personA.uuid===t.patient.uuid?e.personB:e.personA};t.openPatientDashboardInNewTab=function(t){var n=m(t);e.open(f(n.uuid),"_blank")};var f=function(e){return"#/patient/"+e};t.getProviderList=function(){return function(e){return o.search(e.term)}},t.providerSelected=function(e){return function(t){e.providerName=t.identifier,e.personB=l(t.identifier,t.uuid)}};var p=function(e,t){e[t]||delete e.personB},d=function(e,t){var n=[];return _.each(e,function(e){e.personB&&e.relationshipType.uuid===t&&n.push(e.personB.uuid)}),n},h=function(e,t){var n=_.concat(d(e.relationships,t),function(e,t){return d(e.newlyAddedRelationships,t)}(e,t));return _.difference(n,function(e,t){return d(e.deletedRelationships,t)}(e,t))};t.clearProvider=function(e){p(e,"providerName")};var g=function(e,t){return a.getAppDescriptor().getConfigValue(e)||t};t.searchByPatientIdentifierOrName=function(e){var t=e.term;return t&&t.length>=g("minCharRequireToSearch",1)?i.searchByNameOrIdentifier(t,g("possibleRelativeSearchLimit",Bahmni.Common.Constants.defaultPossibleRelativeSearchLimit)):s.when()},t.clearPatient=function(e){p(e,"patientIdentifier")},t.patientSelected=function(e){return function(t){e.patientIdentifier=t.identifier,e.personB=l(t.value,t.uuid)}},t.getPatientList=function(e){if(!angular.isUndefined(e))return e.data.pageOfResults.map(function(e){return{value:c(e)+" - "+e.identifier,uuid:e.uuid,identifier:e.identifier}})},t.getProviderDataResults=function(e){return e.data.results.filter(function(e){return e.person}).map(function(e){return{value:e.display||e.person.display,uuid:e.person.uuid,identifier:e.identifier||e.person.display}})},t.onEdit=function(e){return function(){delete e.personB}},t.clearRelationshipRow=function(e,t){delete e.personB,delete e.patientIdentifier,delete e.providerName,delete e.endDate,delete e.content,v(t)};var v=function(e){var n;for(n=0;n<t.patient.newlyAddedRelationships.length;n++)t.isEmpty(t.patient.newlyAddedRelationships[n])&&n!==e&&t.patient.newlyAddedRelationships.splice(n,1);0===_.filter(t.patient.newlyAddedRelationships,t.isEmpty).length&&t.addPlaceholderRelationship()};t.isEmpty=function(e){return!e.relationshipType||!e.relationshipType.uuid};var b=function(e){return[e.givenName,e.age,n.genderMap[angular.uppercase(e.gender)]].join(", ")};t.relationshipTypes=n.relationshipTypes,t.patient.relationships=t.patient.relationships||[]}]),angular.module("bahmni.registration").controller("NavigationController",["$scope","$rootScope","$location","sessionService","$window","appService","$sce",function(e,t,n,r,i,o,a){e.extensions=o.getAppDescriptor().getExtensions("org.bahmni.registration.navigation","link"),e.goTo=function(e){n.url(e)},e.htmlLabel=function(e){return a.trustAsHtml(e)},e.logout=function(){t.errorMessage=null,r.destroy().then(function(){i.location="../home/"})},e.sync=function(){}}]),angular.module("bahmni.registration").controller("SearchPatientController",["$rootScope","$scope","$location","$window","spinner","patientService","appService","messagingService","$translate","$filter",function(e,t,n,r,i,o,a,s,u,c){t.results=[],t.extraIdentifierTypes=_.filter(e.patientConfiguration.identifierTypes,function(e){return!e.primary});var l=!1,m=5,f=a.getAppDescriptor().getConfigValue("patientSearch")||{},p=a.getAppDescriptor().getConfigValue("patientSearchResults")||{};m=_.isEmpty(f.programAttributes)?m:m-1,t.getAddressColumnName=function(e){var n="",r=e.replace(/([-_][a-z])/g,function(e){return e.toUpperCase().replace(/[-_]/,"")});return _.each(t.addressLevels,function(e){e.addressField===r&&(n=e.name)}),n};var d=function(e){if(S()){var r=n.search();if(t.searchParameters.addressFieldValue=r.addressFieldValue||"",t.searchParameters.name=r.name||"",t.searchParameters.customAttribute=r.customAttribute||"",t.searchParameters.programAttributeFieldValue=r.programAttributeFieldValue||"",t.searchParameters.addressSearchResultsConfig=r.addressSearchResultsConfig||"",t.searchParameters.personSearchResultsConfig=r.personSearchResultsConfig||"",t.searchParameters.registrationNumber=r.registrationNumber||"",t.searchParameters.name.trim().length>0||t.searchParameters.addressFieldValue.trim().length>0||t.searchParameters.customAttribute.trim().length>0||t.searchParameters.programAttributeFieldValue.trim().length>0){l=!0;var i=o.search(t.searchParameters.name,void 0,t.addressSearchConfig.field,t.searchParameters.addressFieldValue,t.searchParameters.customAttribute,e,t.customAttributesSearchConfig.fields,t.programAttributesSearchConfig.field,t.searchParameters.programAttributeFieldValue,t.addressSearchResultsConfig.fields,t.personSearchResultsConfig.fields).then(function(e){return g(e),v(e),b(e),y(e),e});return i.finally(function(){l=!1}),i}}else T()};t.convertToTableHeader=function(e){return u.instant(e).replace(/[A-Z]|^[a-z]/g,function(e){return" "+e.toUpperCase()}).trim()},t.getProgramAttributeValues=function(e){var n=e&&e.patientProgramAttributeValue&&e.patientProgramAttributeValue[t.programAttributesSearchConfig.field],r="";return _.each(n,function(e){r=r+e+", "}),r.substring(0,r.length-2)};var h,g=function(e){"Searching"!==e&&_.each(e.pageOfResults,function(e){e.extraIdentifiers=e.extraIdentifiers&&JSON.parse(e.extraIdentifiers)})},v=function(e){t.personSearchResultsConfig.fields&&"Searching"!==e&&_.map(e.pageOfResults,function(e){e.customAttribute=e.customAttribute&&JSON.parse(e.customAttribute)})},b=function(e){t.addressSearchResultsConfig.fields&&"Searching"!==e&&_.map(e.pageOfResults,function(e){try{e.addressFieldValue=JSON.parse(e.addressFieldValue)}catch(e){}})},y=function(e){t.programAttributesSearchConfig.field&&"Searching"!==e&&_.map(e.pageOfResults,function(e){var t={},n=e.patientProgramAttributeValue&&e.patientProgramAttributeValue.substring(2,e.patientProgramAttributeValue.length-2).split('","');_.each(n,function(e){var n=e.split('":"'),r=n[0],i=n[1];_.includes(_.keys(t),r)?t[r].push(i):(t[r]=[],t[r].push(i))}),e.patientProgramAttributeValue=t})},C=function(){var e,n=!1;_.isEmpty(p)?(n=!0,p.address={fields:f.address?[f.address.field]:{}},p.personAttributes={fields:f.customAttributes?f.customAttributes.fields:{}}):(p.address||(p.address={}),p.personAttributes||(p.personAttributes={})),p.address.fields&&!_.isEmpty(p.address.fields)&&(p.address.fields=p.address.fields.filter(function(e){return!_.isEmpty(t.getAddressColumnName(e))})),n||(e=Object.keys(p),_.each(e,function(e){p[e].fields&&!_.isEmpty(p[e].fields)&&(p[e].fields=p[e].fields.slice(p[e].fields,m),m-=p[e].fields.length)})),t.personSearchResultsConfig=p.personAttributes,t.addressSearchResultsConfig=p.address};t.searchParameters={},t.searchActions=a.getAppDescriptor().getExtensions("org.bahmni.registration.patient.search.result.action"),t.patientIdentifierSearchConfig={},t.patientIdentifierSearchConfig.show=void 0===f.searchByPatientIdentifier||f.searchByPatientIdentifier,function(){if(t.addressSearchConfig=f.address||{},t.addressSearchConfig.show=!_.isEmpty(t.addressSearchConfig)&&!_.isEmpty(t.addressSearchConfig.field),t.addressSearchConfig.label&&!t.addressSearchConfig.label)throw new Error("Search Config label is not present!");if(t.addressSearchConfig.field&&!t.addressSearchConfig.field)throw new Error("Search Config field is not present!")}(),h=f.customAttributes,t.customAttributesSearchConfig=h||{},t.customAttributesSearchConfig.show=!_.isEmpty(h)&&!_.isEmpty(h.fields),t.programAttributesSearchConfig=f.programAttributes||{},t.programAttributesSearchConfig.show=!_.isEmpty(t.programAttributesSearchConfig.field),C(),t.disableSearchButton=function(){return!(t.searchParameters.name||t.searchParameters.addressFieldValue||t.searchParameters.customAttribute||t.searchParameters.programAttributeFieldValue)},t.$watch(function(){return n.search()},function(){var e;e=d(0),t.noMoreResultsPresent=!1,e&&e.then(function(e){t.results=e.pageOfResults,t.noResultsMessage=0===t.results.length?"REGISTRATION_NO_RESULTS_FOUND":null})}),t.searchById=function(){if(S()){if(t.searchParameters.registrationNumber){t.results=[];var e=t.searchParameters.registrationNumber;n.search({registrationNumber:t.searchParameters.registrationNumber,programAttributeFieldName:t.programAttributesSearchConfig.field,patientAttributes:t.customAttributesSearchConfig.fields,programAttributeFieldValue:t.searchParameters.programAttributeFieldValue,addressSearchResultsConfig:t.addressSearchResultsConfig.fields,personSearchResultsConfig:t.personSearchResultsConfig.fields});var r=o.search(void 0,e,t.addressSearchConfig.field,void 0,void 0,void 0,t.customAttributesSearchConfig.fields,t.programAttributesSearchConfig.field,t.searchParameters.programAttributeFieldValue,t.addressSearchResultsConfig.fields,t.personSearchResultsConfig.fields,t.isExtraIdentifierConfigured()).then(function(r){if(g(r),v(r),b(r),y(r),1===r.pageOfResults.length){var i=r.pageOfResults[0],o=a.getAppDescriptor().getConfigValue("searchByIdForwardUrl")||"/patient/{{patientUuid}}";n.url(a.getAppDescriptor().formatUrl(o,{patientUuid:i.uuid}))}else r.pageOfResults.length>1?(t.results=r.pageOfResults,t.noResultsMessage=null):(t.patientIdentifier={patientIdentifier:e},t.noResultsMessage="REGISTRATION_LABEL_COULD_NOT_FIND_PATIENT")});i.forPromise(r)}}else T()};var S=function(){var t=[Bahmni.Common.Constants.viewPatientsPrivilege,Bahmni.Common.Constants.editPatientsPrivilege,Bahmni.Common.Constants.addVisitsPrivilege,Bahmni.Common.Constants.deleteVisitsPrivilege],n=_.map(e.currentUser.privileges,function(e){return e.name});return _.some(n,function(e){return _.includes(t,e)})},T=function(){var e=u.instant("REGISTRATION_INSUFFICIENT_PRIVILEGE");s.showMessage("error",e)};t.loadingMoreResults=function(){return l&&!t.noMoreResultsPresent},t.searchPatients=function(){if(S()){var e={};t.results=[],t.searchParameters.name&&(e.name=t.searchParameters.name),t.searchParameters.addressFieldValue&&(e.addressFieldValue=t.searchParameters.addressFieldValue),t.searchParameters.customAttribute&&t.customAttributesSearchConfig.show&&(e.customAttribute=t.searchParameters.customAttribute),t.searchParameters.programAttributeFieldValue&&t.programAttributesSearchConfig.show&&(e.programAttributeFieldName=t.programAttributesSearchConfig.field,e.programAttributeFieldValue=t.searchParameters.programAttributeFieldValue),n.search(e)}else T()},t.resultsPresent=function(){return angular.isDefined(t.results)&&t.results.length>0},t.editPatientUrl=function(e,t){var n=e;for(var r in t)n=n.replace("{{"+r+"}}",t[r]);return n},t.nextPage=function(){if(!t.nextPageLoading){t.nextPageLoading=!0;var e=d(t.results.length);e&&e.then(function(e){angular.forEach(e.pageOfResults,function(e){t.results.push(e)}),t.noMoreResultsPresent=0===e.pageOfResults.length,t.nextPageLoading=!1},function(){t.nextPageLoading=!1})}},t.forPatient=function(e){return t.selectedPatient=e,t},t.doExtensionAction=function(e){var r=a.getAppDescriptor().formatUrl(e.url,{patientUuid:t.selectedPatient.uuid});if("Print"===e.label)if("dialog"===function(e){e=e.substring(e.indexOf("?")+1).split("&");for(var t,n={},r=decodeURIComponent,i=e.length-1;i>=0;i--)n[r((t=e[i].split("="))[0])]=r(t[1]);return n}(r).launch){var i="/"===r.charAt(0)?"#":"#/",o=$("#printPatientFrame")[0];o.src=i+r,o.contentWindow.print()}else n.url(r);else n.url(r)},t.extensionActionText=function(e){return c("titleTranslate")(e)},t.isExtraIdentifierConfigured=function(){return!_.isEmpty(t.extraIdentifierTypes)}}]),angular.module("bahmni.registration").controller("PatientCommonController",["$scope","$rootScope","$http","patientAttributeService","appService","spinner","$location","ngDialog","$window","$state","$translate",function(e,t,n,r,i,o,a,s,u,c,l){var m,f,p,d,h=i.getAppDescriptor().getConfigValue("autoCompleteFields",[]),g=i.getAppDescriptor().getConfigValue("showCasteSameAsLastNameCheckbox"),v=[];e.showMiddleName=i.getAppDescriptor().getConfigValue("showMiddleName"),e.showLastName=i.getAppDescriptor().getConfigValue("showLastName"),e.showSurname=i.getAppDescriptor().getConfigValue("showSurname"),e.isLastNameMandatory=e.showLastName&&i.getAppDescriptor().getConfigValue("isLastNameMandatory"),e.showBirthTime=null==i.getAppDescriptor().getConfigValue("showBirthTime")||i.getAppDescriptor().getConfigValue("showBirthTime"),e.genderCodes=Object.keys(t.genderMap),e.dobMandatory=i.getAppDescriptor().getConfigValue("dobMandatory")||!1,e.readOnlyExtraIdentifiers=i.getAppDescriptor().getConfigValue("readOnlyExtraIdentifiers"),e.showSaveConfirmDialogConfig=i.getAppDescriptor().getConfigValue("showSaveConfirmDialog"),e.showSaveAndContinueButton=!1,e.moduleName=i.getAppDescriptor().getConfigValue("registrationModuleName"),f=Bahmni.Registration.Constants.patientNameDisplayOrder,p=i.getAppDescriptor().getConfigValue("patientNameDisplayOrder")||[],d=_.every(p,function(e){return f.indexOf(e)>=0}),4===p.length&&d?e.patientNameDisplayOrder=p:e.patientNameDisplayOrder=f;var b=!1,y=!1;t.onHomeNavigate=function(t){e.showSaveConfirmDialogConfig&&"patient.visit"!=c.current.name&&(t.preventDefault(),e.targetUrl=t.currentTarget.getAttribute("href"),y=!0,e.confirmationPrompt(t))},e.getTranslatedPatientControls=function(e){return Bahmni.Common.Util.TranslationUtil.translateAttribute(e,Bahmni.Common.Constants.registration,l)};var C=t.$on("$stateChangeStart",function(t,n,r){!e.showSaveConfirmDialogConfig||"/search"!=n.url&&"/patient/new"!=n.url||(e.targetUrl=n.name,y=!1,e.confirmationPrompt(t,n,r))});e.confirmationPrompt=function(t,n){!1===b&&(t&&t.preventDefault(),s.openConfirm({template:"../common/ui-helper/views/saveConfirmation.html",scope:e}))},e.continueWithoutSaving=function(){s.close(),b=!0,!0===y?u.open(e.targetUrl,"_self"):c.go(e.targetUrl)},e.cancelTransition=function(){s.close(),delete e.targetUrl},e.$on("$destroy",function(){C()}),e.getDeathConcepts=function(){return n({url:Bahmni.Common.Constants.globalPropertyUrl,method:"GET",params:{property:"concept.reasonForDeath"},withCredentials:!0,transformResponse:[function(r){_.isEmpty(r)?e.deathConceptExists=!1:n.get(Bahmni.Common.Constants.conceptSearchByFullNameUrl,{params:{name:r,v:"custom:(uuid,name,set,names,setMembers:(uuid,display,name:(uuid,name),names,retired))"},withCredentials:!0}).then(function(n){e.deathConceptExists=!!n.data.results.length,e.deathConcepts=n.data.results[0]?n.data.results[0].setMembers:[];var r=S(e.deathConcepts);_.forEach(r,function(n,i){r[i]=e.updateDisplayFieldToLocaleSpecific(e.filterNamesForLocale(n,t.currentUser.userProperties.defaultLocale,"FULLY_SPECIFIED"))})})}]})},o.forPromise(e.getDeathConcepts());var S=function(e){return _.filter(e,function(e){return!e.retired})};e.filterNamesForLocale=function(e,t,n){var r=_.filter(e.names,function(e){return e.locale==t&&e.conceptNameType==n});return r.length>0&&(e.names=r),e},e.updateDisplayFieldToLocaleSpecific=function(e){e.display=e.names[0].display},e.isAutoComplete=function(e){return!_.isEmpty(h)&&h.indexOf(e)>-1},e.showCasteSameAsLastName=function(){var e=-1!==(v=_.map(t.patientConfiguration.attributeTypes,function(e){return e.name.toLowerCase()})).indexOf("caste");return m=e?t.patientConfiguration.attributeTypes[v.indexOf("caste")].name:void 0,g&&e},e.setCasteAsLastName=function(){e.patient.sameAsLastName&&(e.patient[m]=e.patient.familyName)};var T=function(n){var r,i,o=n(e.patient),a=t.patientConfiguration.getPatientAttributesSections();r=o.show,i=a,_.each(r,function(e){i[e].canShow=!0,i[e].expand=!0}),function(e,t){_.each(e,function(e){t[e].canShow=!1})}(o.hide,a)};e.handleUpdate=function(e){var t=Bahmni.Registration.AttributesConditions.rules&&Bahmni.Registration.AttributesConditions.rules[e];t&&T(t)};e.$watch("patientLoaded",function(){e.patientLoaded&&_.each(Bahmni.Registration.AttributesConditions.rules,function(e){T(e)})}),e.getAutoCompleteList=function(e,t,n){return r.search(e,t,n)},e.getDataResults=function(e){return e.results},e.$watch("patient.familyName",function(){e.patient.sameAsLastName&&(e.patient[m]=e.patient.familyName)}),e.$watch("patient.caste",function(){e.patient.sameAsLastName&&e.patient.familyName!==e.patient[m]&&(e.patient.sameAsLastName=!1)}),e.selectIsDead=function(){(e.patient.causeOfDeath||e.patient.deathDate)&&(e.patient.dead=!0)},e.disableIsDead=function(){return(e.patient.causeOfDeath||e.patient.deathDate)&&e.patient.dead}}]),angular.module("bahmni.registration").controller("CreatePatientController",["$scope","$rootScope","$state","patientService","patient","spinner","appService","messagingService","ngDialog","$q","$translate",function(e,t,n,r,i,o,a,s,u,c,l){var m=Bahmni.Common.Util.DateUtil;e.actions={};var f,p=a.getAppDescriptor().getConfigValue("showEnterID");e.addressHierarchyConfigs=a.getAppDescriptor().getConfigValue("addressHierarchy"),e.disablePhotoCapture=a.getAppDescriptor().getConfigValue("disablePhotoCapture"),e.showEnterID=null===p||p,e.today=Bahmni.Common.Util.DateTimeFormatter.getDateWithoutTime(m.now()),e.moduleName=a.getAppDescriptor().getConfigValue("registrationModuleName");e.getTranslatedPatientIdentifier=function(e){return Bahmni.Common.Util.TranslationUtil.translateAttribute(e,Bahmni.Common.Constants.registration,l)};var d=function(){var n=t.patientConfiguration.attributeTypes,r=a.getAppDescriptor().getConfigValue("patientInformation");if(r&&r.defaults){var i=r.defaults,o=_.keys(i),s=_.chain(n).filter(function(e){return _.includes(o,e.name)}).each(function(t){e.patient[t.name]=i[t.name]}).value();_.chain(s).filter(function(e){return"org.openmrs.Concept"===e.format}).each(function(t){var n=i[t.name];_.chain(t.answers).filter(function(e){return e.fullySpecifiedName===n}).each(function(n){e.patient[t.name]={conceptUuid:n.conceptId,value:n.fullySpecifiedName}}).value()}).value(),_.chain(s).filter(function(e){return"org.openmrs.util.AttributableDate"===e.format}).each(function(t){!function(e){return"today"===i[e.name].toLowerCase()}(t)?e.patient[t.name]="":e.patient[t.name]=new Date}).value()}};e.patient=i.create(),d(),angular.forEach(t.patientConfiguration&&t.patientConfiguration.getPatientAttributesSections(),function(t){var n=_.find(t&&t.attributes,function(t){return void 0!==e.patient[t.name]});t.expand=t.expanded||!!n}),e.patientLoaded=!0;var h;(h=a.getAppDescriptor().getConfigValue("prepopulateFields"))&&_.each(h,function(n){var r=_.find(e.addressLevels,function(e){return e.name===n});r&&(e.patient.address[r.addressField]=t.loggedInLocation[r.addressField])});var g=function(n){return r.create(e.patient,n).then(function(t){!function(t){var n=t.data;e.patient.uuid=n.patient.uuid,e.patient.name=n.patient.person.names[0].display,e.patient.isNew=!0,e.patient.registrationDate=m.now(),e.patient.newlyAddedRelationships=[{}],e.actions.followUpAction(n)}(t)},function(n){if(412===n.status){var r=_.map(n.data,function(e){return{sizeOfTheJump:e.sizeOfJump,identifierName:_.find(t.patientConfiguration.identifierTypes,{uuid:e.identifierType}).name}});(o=(i={template:"views/customIdentifierConfirmation.html",data:r,scope:e,yesCallback:function(){return g(!0)}}).scope.$new()).yes=function(){u.close(),i.yesCallback()},o.no=function(){u.close()},u.open({template:i.template,data:i.data,scope:o})}var i,o;n.isIdentifierDuplicate&&(f=n.message)})};e.create=function(){var t;t=_.filter(e.patient.newlyAddedRelationships,function(e){return e.relationshipType&&e.relationshipType.uuid}),t=_.each(t,function(e){delete e.patientIdentifier,delete e.content,delete e.providerName}),e.patient.relationships=t;var n,r=Bahmni.Common.Util.ValidationUtil.validate(e.patient,e.patientConfiguration.attributeTypes);return r.length>0?(r.forEach(function(e){s.showMessage("error",e)}),c.when({})):o.forPromise((n=c.defer(),g().finally(function(){return n.resolve({})}),n.promise)).then(function(e){f&&(s.showMessage("error",f),f=void 0)})},e.afterSave=function(){s.showMessage("info","REGISTRATION_LABEL_SAVED"),n.go("patient.edit",{patientUuid:e.patient.uuid})}}]),angular.module("bahmni.registration").controller("EditPatientController",["$scope","patientService","encounterService","$stateParams","openmrsPatientMapper","$window","$q","spinner","appService","messagingService","$rootScope","auditLogService",function(e,t,n,r,i,o,a,s,u,c,l,m){var f=Bahmni.Common.Util.DateUtil,p=r.patientUuid;e.patient={},e.actions={},e.addressHierarchyConfigs=u.getAppDescriptor().getConfigValue("addressHierarchy"),e.disablePhotoCapture=u.getAppDescriptor().getConfigValue("disablePhotoCapture"),e.today=f.getDateWithoutTime(f.now());var d,h,g=function(t){e.openMRSPatient=t.patient,e.patient=i.map(t),function(){e.readOnlyFields={};var t=u.getAppDescriptor().getConfigValue("readOnlyFields");angular.forEach(t,function(t){e.patient[t]&&(e.readOnlyFields[t]=!0)})}(),v(),e.patientLoaded=!0},v=function(){angular.forEach(l.patientConfiguration&&l.patientConfiguration.getPatientAttributesSections(),function(t){var n=_.find(t&&t.attributes,function(t){return void 0!==e.patient[t.name]});t.expand=t.expanded||!!n})};d=t.get(p).then(g),(h=n.getDigitized(p)).then(function(t){var n=t.data.results.filter(function(e){return e.obs.length>0});e.isDigitized=n.length>0}),s.forPromise(a.all([d,h])),e.update=function(){b();var n=Bahmni.Common.Util.ValidationUtil.validate(e.patient,e.patientConfiguration.attributeTypes);return n.length>0?(n.forEach(function(e){c.showMessage("error",e)}),a.when({})):s.forPromise(t.update(e.patient,e.openMRSPatient).then(function(t){var n=t.data;n.error||(g(n),e.actions.followUpAction(n))}))};var b=function(){var t=_.filter(e.patient.newlyAddedRelationships,function(e){return e.relationshipType&&e.relationshipType.uuid});t=_.each(t,function(e){delete e.patientIdentifier,delete e.content,delete e.providerName}),e.patient.relationships=_.concat(t,e.patient.deletedRelationships)};e.isReadOnly=function(t){return e.readOnlyFields?!!e.readOnlyFields[t]:void 0},e.afterSave=function(){m.log(e.patient.uuid,Bahmni.Registration.StateNameEvenTypeMap["patient.edit"],void 0,"MODULE_LABEL_REGISTRATION_KEY"),c.showMessage("info","REGISTRATION_LABEL_SAVED")}}]),angular.module("bahmni.registration").directive("patientAction",["$window","$location","$state","spinner","$rootScope","$stateParams","$bahmniCookieStore","appService","visitService","sessionService","encounterService","messagingService","$translate","auditLogService",function(e,t,n,r,i,o,a,s,u,c,l,m,f,p){return{restrict:"E",templateUrl:"views/patientAction.html",controller:function(c){function d(){0===v.length?c.forwardActionKey=h.hasActiveVisit?A()?D():"enterVisitDetails":"startVisit":(c.actionConfig=v[0],c.forwardActionKey="configAction")}var h=this,g=o.patientUuid,v=s.getAppDescriptor().getExtensions(Bahmni.Registration.Constants.nextStepConfigId,"config")||[],b=(s.getAppDescriptor().getExtensions("org.bahmni.registration.conceptSetGroup.observations","config"),a.get(Bahmni.Common.Constants.locationCookieName).uuid),y=i.regEncounterConfiguration.getDefaultVisitType(b);y=y||s.getAppDescriptor().getConfigValue("defaultVisitType");var C=s.getAppDescriptor().getConfigValue("showStartVisitButton"),S=s.getAppDescriptor().getConfigValue("forwardUrlsForVisitTypes");C=!(!_.isUndefined(C)&&!_.isNull(C))||C;var T=i.visitLocation,E=S||!1,A=function(){return _.find(E,function(e){return h.hasActiveVisit?e.visitType===h.activeVisit.visitType.name:e.visitType===c.visitControl.selectedVisitType.name})},D=function(){var e=A();if(e)return c.activeVisitConfig=e,_.isEmpty(_.get(c.activeVisitConfig,"translationKey"))&&(c.activeVisitConfig.translationKey="REGISTRATION_LABEL_ENTER_VISIT",c.activeVisitConfig.shortcutKey="REGISTRATION_ENTER_VISIT_DETAILS_ACCESS_KEY"),"forwardAction"};c.visitControl=new Bahmni.Common.VisitControl(i.regEncounterConfiguration.getVisitTypesAsArray(),y,l,f,u),c.visitControl.onStartVisit=function(){c.setSubmitSource("startVisit")},c.setSubmitSource=function(e){c.actions.submitSource=e},c.showStartVisitButton=function(){return C};c.actions.followUpAction=function(t){switch(m.clearAll(),c.actions.submitSource){case"startVisit":var n=A(),r=n?n.forwardUrl:void 0;return N(t,r);case"forwardAction":return function(t){var n=s.getAppDescriptor().formatUrl(c.activeVisitConfig.forwardUrl,{patientUuid:t.patient.uuid});e.location.href=n}(t);case"enterVisitDetails":return O(t);case"configAction":return w(t);case"save":c.afterSave()}};var w=function(t){var n=s.getAppDescriptor().formatUrl(c.actionConfig.extensionParams.forwardUrl,{patientUuid:t.patient.uuid});h.hasActiveVisit?e.location.href=n:N(t,n)},O=function(e){c.patient.uuid=e.patient.uuid,c.patient.name=e.patient.person.names[0].display,t.path("/patient/"+e.patient.uuid+"/visit")},N=function(t,o){return _.isEmpty(i.visitLocation)?void n.go("patient.edit",{patientUuid:c.patient.uuid}).then(function(){m.showMessage("error","NO_LOCATION_TAGGED_TO_VISIT_LOCATION")}):void r.forPromise(c.visitControl.createVisitOnly(t.patient.uuid,i.visitLocation).then(function(n){if(p.log(t.patient.uuid,"OPEN_VISIT",{visitUuid:n.data.uuid,visitType:n.data.visitType.display},"MODULE_LABEL_REGISTRATION_KEY"),o){var r=s.getAppDescriptor().formatUrl(o,{patientUuid:t.patient.uuid});e.location.href=r}else O(t)},function(){n.go("patient.edit",{patientUuid:c.patient.uuid})}))};!function(){if(_.isEmpty(g))return h.hasActiveVisit=!1,void d();var e={patient:g,includeInactive:!1,v:"custom:(uuid,visitType,location:(uuid))"};r.forPromise(u.search(e).then(function(e){var t,n=e.data.results;n&&(t=_.filter(n,function(e){return e.location.uuid===T})),h.hasActiveVisit=t&&t.length>0,h.hasActiveVisit&&(h.activeVisit=t[0]),d()}))}()}}}]),angular.module("bahmni.registration").controller("VisitController",["$window","$scope","$rootScope","$state","$bahmniCookieStore","patientService","encounterService","$stateParams","spinner","$timeout","$q","appService","openmrsPatientMapper","contextChangeHandler","messagingService","sessionService","visitService","$location","$translate","auditLogService","formService",function(e,t,n,r,i,o,a,s,u,c,l,m,f,p,d,h,g,v,b,y,C){var S=this,T=s.patientUuid,E=m.getAppDescriptor().getExtensions("org.bahmni.registration.conceptSetGroup.observations","config"),A=m.getAppDescriptor().getExtensions("org.bahmni.registration.conceptSetGroup.observations","forms"),D=h.getLoginLocationUuid(),w=n.currentProvider,O=n.regEncounterConfiguration.encounterTypes[Bahmni.Registration.Constants.registrationEncounterType],N=n.visitLocation;t.hideFields=m.getAppDescriptor().getConfigValue("hideFields"),t.back=function(){r.go("patient.edit")},t.updatePatientImage=function(e){var n=o.updateImage(t.patient.uuid,e.replace("data:image/jpeg;base64,",""));return u.forPromise(n),n};var I=function(){t.encounter={patientUuid:t.patient.uuid,locationUuid:D,encounterTypeUuid:O,orders:[],drugOrders:[],extensions:{}},i.put(Bahmni.Common.Constants.grantProviderAccessDataCookieName,w,{path:"/",expires:1}),t.encounter.observations=t.observations,t.encounter.observations=(new Bahmni.Common.Domain.ObservationFilter).filter(t.encounter.observations),j(t.encounter.observations);var e=a.create(t.encounter);return u.forPromise(e),e.then(function(e){var t,n={encounterUuid:e.data.encounterUuid,encounterType:e.data.encounterType};y.log(T,"EDIT_ENCOUNTER",n,"MODULE_LABEL_REGISTRATION_KEY"),t=e.data.visitTypeUuid,g.getVisitType().then(function(e){_.find(e.data.results,function(e){if(e.uuid===t)return e})})})};t.closeVisitIfDischarged=function(){g.getVisitSummary(S.visitUuid).then(function(e){var t=e.data;if(t.admissionDetails&&!t.dischargeDetails){d.showMessage("error","REGISTRATION_VISIT_CANNOT_BE_CLOSED");var n={visitUuid:S.visitUuid,visitType:t.visitType};y.log(T,"CLOSE_VISIT_FAILED",n,"MODULE_LABEL_REGISTRATION_KEY")}else U(t.visitType)})};var U=function(t){e.confirm(b.instant("REGISTRATION_CONFIRM_CLOSE_VISIT"))&&g.endVisit(S.visitUuid).then(function(){v.url(Bahmni.Registration.Constants.patientSearchURL);var e={visitUuid:S.visitUuid,visitType:t};y.log(T,"CLOSE_VISIT",e,"MODULE_LABEL_REGISTRATION_KEY")})};t.getTranslatedPrimaryIdentifierInVisit=function(e){return Bahmni.Common.Util.TranslationUtil.translateAttribute(e,Bahmni.Common.Constants.registration,b)},t.getMessage=function(){return t.message};var B=function(){var e,n,r=M(),i=l.defer(),o=p.execute(),a=o.allow;return n=!0,_.each(t.observationForms,function(e){n&&e.component&&e.component.getValue().errors&&(d.showMessage("error","{{'REGISTRATION_FORM_ERRORS_MESSAGE_KEY' | translate }}"),n=!1)}),n?a?r?(i.resolve(),i.promise):(e="REGISTRATION_LABEL_ENTER_MANDATORY_FIELDS",d.showMessage("error",e),i.reject("Some fields are not valid"),i.promise):(e=o.errorMessage?o.errorMessage:"REGISTRATION_LABEL_CORRECT_ERRORS",d.showMessage("error",e),i.reject("Some fields are not valid"),i.promise):(i.reject("Some fields are not valid"),i.promise)},P=[],M=function(){return V(t.observations),x(P)},V=function(e){var t=_.filter(e,function(e){return R(e)});_.isEmpty(t)||(P=_.union(P,t))},R=function(e){return _.isEmpty(e.groupMembers)?e.conceptUIConfig&&e.conceptUIConfig.required:void V(e.groupMembers)},x=function(e){var t=e.filter(function(e){return!e.hasValue()&&!(e instanceof Bahmni.ConceptSet.Observation&&e.conceptUIConfig&&e.conceptUIConfig.multiSelect)&&(e.isMultiSelect?_.isEmpty(e.getValues()):!e.value)});return _.isEmpty(t)},L=function(){var t=m.getAppDescriptor().getConfigValue("afterVisitSaveForwardUrl");null!=t?e.location.href=m.getAppDescriptor().formatUrl(t,{patientUuid:T}):r.transitionTo(r.current,r.params,{reload:!0,inherit:!1,notify:!0}),d.showMessage("info","REGISTRATION_LABEL_SAVED")};t.submit=function(){return B().then(I).then(L)},t.today=function(){return new Date},t.disableFormSubmitOnEnter=function(){$(".visit-patient").find("input").keypress(function(e){if(13===e.which)return!1})};var F=function(e,r){var i=[],o=t.observations||[];return _.each(e,function(e){var t=e.extensionParams||{},a=_.find(r,function(e){return e.formName===t.formName||e.name===t.formName});if(a){var s=a.formUuid||a.uuid,u=a.name||a.formName,c=a.version||a.formVersion;i.push(new Bahmni.ObservationForm(s,n.currentUser,u,c,o,u,e))}}),i};t.isFormTemplate=function(e){return e.formUuid};var k,j=function(e){t.observationForms&&(_.remove(e,function(e){return e.formNamespace}),_.each(t.observationForms,function(t){if(t.component){var n=t.component.getValue();_.each(n.observations,function(t){e.push(t)})}}))};u.forPromise(l.all([(k=l.defer(),o.get(T).then(function(e){k.resolve(e),t.patient=f.map(e),t.patient.name=e.patient.person.names[0].display,t.patient.uuid=e.patient.uuid}),k.promise),function(){var e=l.defer();return a.find({patientUuid:T,providerUuids:_.isEmpty(t.currentProvider.uuid)?null:[t.currentProvider.uuid],includeAll:!1,locationUuid:D,encounterTypeUuids:[O]}).then(function(n){e.resolve(n),t.encounterUuid=n.data.encounterUuid,t.observations=n.data.observations}),e.promise}(),g.search({patient:T,includeInactive:!1,v:"custom:(uuid,location:(uuid))"}).then(function(e){var r,i=e.data.results;i&&(r=_.filter(i,function(e){return e.location.uuid===N}));var o,a,s=r.length>0;S.visitUuid=s?r[0].uuid:"",t.canCloseVisit=(o=[Bahmni.Common.Constants.closeVisitPrivilege,Bahmni.Common.Constants.deleteVisitsPrivilege],a=_.map(n.currentUser.privileges,function(e){return e.name}),_.some(a,function(e){return _.includes(o,e)})&&s)})]).then(function(){var e;(e=l.defer(),C.getFormList(t.encounterUuid).then(function(r){t.conceptSets=E.map(function(e){return new Bahmni.ConceptSet.ConceptSetSection(e,n.currentUser,{},[],{})}),t.observationForms=F(A,r.data),t.conceptSets=t.conceptSets.concat(t.observationForms),t.availableConceptSets=t.conceptSets.filter(function(e){return e.isAvailable(t.context)}),e.resolve(r.data)}),e.promise).then(function(){var e;e=t.encounterConfig.getVisitTypeByUuid(t.visitTypeUuid),t.context={visitType:e,patient:t.patient}})}))}]),angular.module("bahmni.registration").factory("patientService",["$http","$rootScope","$bahmniCookieStore","$q","patientServiceStrategy","sessionService",function(e,t,n,r,i,o){var a=(Bahmni.Registration.Constants.openmrsUrl,Bahmni.Registration.Constants.baseOpenMRSRESTURL);return{search:function(e,t,n,r,a,s,u,c,l,m,f,p){var d={params:{q:e,identifier:t,s:"byIdOrNameOrVillage",addressFieldName:n,addressFieldValue:r,customAttribute:a,startIndex:s||0,patientAttributes:u,programAttributeFieldName:c,programAttributeFieldValue:l,addressSearchResultsConfig:m,patientSearchResultsConfig:f,loginLocationUuid:o.getLoginLocationUuid(),filterOnAllIdentifiers:p},withCredentials:!0};return i.search(d)},searchByIdentifier:function(t){return e.get(Bahmni.Common.Constants.bahmniSearchUrl+"/patient",{method:"GET",params:{identifier:t,loginLocationUuid:o.getLoginLocationUuid()},withCredentials:!0})},create:function(e,t){return i.create(e,t)},update:function(e,n){return i.update(e,n,t.patientConfiguration.attributeTypes)},get:function(e){return i.get(e)},updateImage:function(t,n){var r=a+"/personimage/",i={person:{uuid:t},base64EncodedImage:n};return e.post(r,i,{withCredentials:!0,headers:{Accept:"application/json","Content-Type":"application/json"}})},searchByNameOrIdentifier:function(t,n){return e.get(Bahmni.Common.Constants.bahmniSearchUrl+"/patient",{method:"GET",params:{q:t,s:"byIdOrName",limit:n,loginLocationUuid:o.getLoginLocationUuid()},withCredentials:!0})}}}]),angular.module("bahmni.registration").factory("patientAttributeService",["$http","$q",function(e,t){var n;n={personName:Bahmni.Common.Constants.bahmniSearchUrl+"/personname",personAttribute:Bahmni.Common.Constants.bahmniSearchUrl+"/personattribute"};return{search:function(t,r,i){var o=n[i],a=r.trimLeft();return e.get(o,{method:"GET",params:{q:a,key:t},withCredentials:!0})}}}]),angular.module("bahmni.registration").factory("addressHierarchyService",["$http",function(e){var t=function(e){for(var t=e.parent;t;){if(t.name)return t.name;t=t.parent}return""};return{search:function(t,n,r){var i={searchString:n,addressField:t,parentUuid:r,limit:defaults.maxAutocompleteResults},o=Bahmni.Registration.Constants.openmrsUrl+"/module/addresshierarchy/ajax/getPossibleAddressHierarchyEntriesWithParents.form";return e.get(o,{method:"GET",params:i,withCredentials:!0})},getNextAvailableParentName:t,getAddressDataResults:function(e){return e.data?e.data.map(function(e){var n=t(e);return{value:e.name,label:e.name+(n?", "+n:""),addressField:e}}):[]}}}]),angular.module("bahmni.registration").factory("registrationCardPrinter",["printer",function(e){return{print:function(t,n,r,i){t=t||"views/nolayoutfound.html",e.print(t,{patient:n,today:new Date,obs:r||{},encounterDateTime:i})}}}]),Bahmni.Common.Domain.AttributeTypeMapper=function(){function e(){}return e.prototype.mapFromOpenmrsAttributeTypes=function(e,t,n,r){var i=[];return angular.forEach(e,function(e){var o={uuid:e.uuid,sortWeight:e.sortWeight,name:e.name,fullySpecifiedName:e.name,description:e.description||e.name,format:e.format||e.datatypeClassname,answers:[],required:!!_.find(t,function(t){return t==e.name}),concept:e.concept||{},excludeFrom:n&&n[e.name]&&n[e.name].excludeFrom||[]};o.concept.dataType=o.concept.datatype&&o.concept.datatype.name,e.concept&&e.concept.answers&&angular.forEach(e.concept.answers,function(e){var t=function(e,t){var n=e.names||[],r=n.find(function(e){return e.locale===t&&"SHORT"===e.conceptNameType});if(r)return r.name;var i=n.find(function(e){return e.locale===t&&"FULLY_SPECIFIED"===e.conceptNameType});return i?i.name:e.name?e.name.display:e.displayString}(e,r),n=function(e,t,n){n=n||"SHORT";var r=_.filter(e.names,function(e){return e.locale==t&&e.conceptNameType==n});return r&&r[0]?r[0].display:null}(e,r,"FULLY_SPECIFIED");n=n||e.name.display,o.answers.push({fullySpecifiedName:n,description:t,conceptId:e.uuid})}),"org.openmrs.customdatatype.datatype.RegexValidatedTextDatatype"==o.format&&(o.pattern=e.datatypeConfig),i.push(o)}),{attributeTypes:i}},e}(),Bahmni.Common.Domain.AttributeFormatter=function(){function e(){}e.prototype.getMrsAttributes=function(e,t){return t.map(function(t){var r={attributeType:{uuid:t.uuid}};return _.isEmpty(e)||n(t,r,e[t.name]),r})},e.prototype.getMrsAttributesForUpdate=function(n,r,i){return _.filter(e.prototype.getMrsAttributes(n,r),function(e){var n=_.find(i,function(t){return e.attributeType.uuid===t.attributeType.uuid});return n&&!n.voided&&(e.uuid=n.uuid),t(e)})},e.prototype.removeUnfilledAttributes=function(e){return _.filter(e,t)};var t=function(e){return e.value||e.uuid},n=function(e,t,n){if(""===n||null==n||null===n.conceptUuid)t.voided=!0;else if("org.openmrs.Concept"===e.format){var r=_.find(e.answers,function(e){if(e.conceptId===n.conceptUuid)return!0});t.value=null!=r?r.description:null,t.hydratedObject=n.conceptUuid}else if("org.openmrs.util.AttributableDate"==e.format||"org.openmrs.customdatatype.datatype.DateDatatype"==e.format){var i=moment(n);t.value=i.format("YYYY-MM-DD")}else t.value=n.toString()};return e}(),angular.module("bahmni.registration").factory("openmrsPatientMapper",["patient","$rootScope","age","identifiers",function(e,t,n,r){var i=e,o=function(e){return t.patientConfiguration.get(e.attributeType.uuid)},a=function(e,n){n.filter(o).forEach(function(n){!function(e,n){var r=t.patientConfiguration.get(n.attributeType.uuid);r&&("org.openmrs.Concept"===r.format&&n.value?e[r.name]={conceptUuid:n.value.uuid,value:n.value.display}:"org.openmrs.util.AttributableDate"===r.format?e[r.name]=s(n.value):e[r.name]=n.value)}(e,n)})},s=function(e){return Bahmni.Common.Util.DateUtil.parseServerDateToDate(e)};return{map:function(e){var t=e.relationships,o=(e=e.patient).person,u=i.create(),c=s(o.birthdate);return u.uuid=e.uuid,u.givenName=o.preferredName.givenName,u.middleName=o.preferredName.middleName,u.familyName=o.preferredName.familyName,u.surname=o.preferredName.surname,u.birthdate=c||null,u.age=c?n.fromBirthDate(c):null,u.gender=o.gender,u.address=o.preferredAddress||{},u.birthtime=s(o.birthtime),u.image=Bahmni.Registration.Constants.patientImageUrlByPatientUuid+e.uuid+"&q="+(new Date).toISOString(),u.registrationDate=Bahmni.Common.Util.DateUtil.parse(o.auditInfo.dateCreated),u.dead=o.dead,u.isDead=u.dead,u.deathDate=s(o.deathDate),u.causeOfDeath=o.causeOfDeath,u.birthdateEstimated=o.birthdateEstimated,u.bloodGroup=o.bloodGroup,a(u,o.attributes),function(e,t){e.relationships=t||[],e.newlyAddedRelationships=[{}],e.hasRelationships=e.relationships.length>0}(u,t),_.assign(u,r.mapIdentifiers(e.identifiers)),u}}}]),Bahmni.Registration.CreatePatientRequestMapper=function(){function e(e){this.currentDate=e}return e.prototype.mapFromPatient=function(e,t){var n=Bahmni.Registration.Constants,r=_.concat(t.extraIdentifiers,t.primaryIdentifier),i=_.filter(r,function(e){return!_.isEmpty(e.selectedIdentifierSource)||void 0!==e.identifier});i=_.map(i,function(e){return{identifier:e.identifier,identifierSourceUuid:e.selectedIdentifierSource?e.selectedIdentifierSource.uuid:void 0,identifierPrefix:e.selectedIdentifierSource?e.selectedIdentifierSource.prefix:void 0,identifierType:e.identifierType.uuid,preferred:e.preferred,voided:e.voided}});var o={patient:{person:{names:[{givenName:t.givenName,middleName:t.middleName,familyName:t.familyName,surname:t.surname,display:t.givenName+(t.familyName?" "+t.familyName:"")+(t.surname?" "+t.surname:""),preferred:!1}],addresses:[_.pick(t.address,n.allAddressFileds)],birthdate:this.getBirthdate(t.birthdate,t.age),birthdateEstimated:t.birthdateEstimated,gender:t.gender,birthtime:Bahmni.Common.Util.DateUtil.parseLongDateToServerFormat(t.birthtime),personDateCreated:t.registrationDate,attributes:(new Bahmni.Common.Domain.AttributeFormatter).getMrsAttributes(t,e),dead:t.dead,deathDate:Bahmni.Common.Util.DateUtil.getDateWithoutTime(t.deathDate),causeOfDeath:t.causeOfDeath?t.causeOfDeath.uuid:"",uuid:t.uuid},identifiers:i,uuid:t.uuid}};return this.setImage(t,o),o.relationships=t.relationships,o},e.prototype.setImage=function(e,t){e.getImageData()&&(t.image=e.getImageData())},e.prototype.getBirthdate=function(e,t){var n;return e?n=moment(e):void 0!==t&&(n=moment(this.currentDate).subtract("days",t.days).subtract("months",t.months).subtract("years",t.years)),n.format("YYYY-MM-DDTHH:mm:ss.SSSZZ")},e}(),Bahmni.Registration.UpdatePatientRequestMapper=function(){var e=function(e){this.currentDate=e};e.prototype.currentDate=void 0,e.prototype.mapFromPatient=function(e,t,n){var r={patient:{person:{names:[{uuid:t.person.names[0].uuid,givenName:n.givenName,middleName:n.middleName,familyName:n.familyName,surname:n.surname,display:n.givenName+(n.familyName?" "+n.familyName:"")+(n.surname?" "+n.surname:""),preferred:!0}],addresses:[_.pick(n.address,Bahmni.Registration.Constants.allAddressFileds)],birthdate:this.getBirthdate(n.birthdate,n.age),birthdateEstimated:n.birthdateEstimated,birthtime:Bahmni.Common.Util.DateUtil.parseLongDateToServerFormat(n.birthtime),gender:n.gender,attributes:this.getMrsAttributes(t,n,e),dead:n.dead,deathDate:Bahmni.Common.Util.DateUtil.getDateWithoutTime(n.deathDate),causeOfDeath:n.causeOfDeath?n.causeOfDeath.uuid:""}}},i=_.concat(n.extraIdentifiers,n.primaryIdentifier),o=_.filter(i,function(e){return e.uuid||e.identifier});return r.patient.identifiers=_.map(o,function(e){return{uuid:e.uuid,identifier:e.identifier,identifierType:e.identifierType.uuid,preferred:e.preferred,voided:e.voided}}),this.setImage(n,r),n.relationships&&(r.relationships=n.relationships),r},e.prototype.setImage=function(e,t){e.getImageData()&&(t.image=e.getImageData())},e.prototype.getMrsAttributes=function(e,n,r){var i=[];return r.forEach(function(r){var o={attributeType:{uuid:r.uuid}},a=e.person.attributes.filter(function(e){return r.uuid===e.attributeType.uuid})[0];a?(o.uuid=a.uuid,t(r,o,n[a.attributeType.display])):t(r,o,n[r.name]),i.push(o)}),i};var t=function(e,t,n){if(""===n||null==n||null===n.conceptUuid)t.voided=!0;else if("org.openmrs.Concept"===e.format)t.hydratedObject=n.conceptUuid;else if("org.openmrs.util.AttributableDate"===e.format){var r=moment(n);t.value=r.format("YYYY-MM-DDTHH:mm:ss.SSSZZ")}else t.value=n.toString()};return e.prototype.getBirthdate=function(e,t){var n;return e?n=moment(e):void 0!==t&&(n=moment(this.currentDate).subtract("days",t.days).subtract("months",t.months).subtract("years",t.years)),n.format("YYYY-MM-DDTHH:mm:ss.SSSZZ")},e}(),angular.module("bahmni.registration").factory("patient",["age","identifiers",function(e,t){return{create:function(){var n=t.create(),r={address:{},age:e.create(),birthdate:null,calculateAge:function(){this.birthdate?this.age=e.fromBirthDate(this.birthdate):this.age=e.create(null,null,null)},image:"../images/blank-user.gif",fullNameLocal:function(){var e=this.givenNameLocal||this.givenName||"",t=this.middleNameLocal||this.middleName||"",n=this.familyNameLocal||this.familyName||"",r=this.surnameLocal||this.surname||"";return(e.trim()+" "+(t?t+" ":"")+n.trim()+r.trim()).trim()},getImageData:function(){return this.image&&0===this.image.indexOf("data")?this.image.replace("data:image/jpeg;base64,",""):null},relationships:[],newlyAddedRelationships:[{}],deletedRelationships:[],calculateBirthDate:function(){this.birthdate=e.calculateBirthDate(this.age)}};return _.assign(r,n)}}}]),Bahmni.Registration.Identifier=function(e){return this.identifierType=e,this.preferred=e.primary,this.voided=!1,this};var Bahmni,prototype=Bahmni.Registration.Identifier.prototype;prototype.hasIdentifierSources=function(){return this.identifierType.identifierSources.length>0},prototype.isPrimary=function(){return this.identifierType.primary},prototype.map=function(e){var t=_.find(e,{identifierType:{uuid:this.identifierType.uuid}});return t&&(this.registrationNumber=t.identifier,this.identifier=t.identifier,this.preferred=t.preferred,this.voided=t.voided,this.uuid=t.uuid),this},prototype.hasIdentifierSourceWithEmptyPrefix=function(){var e=this.identifierType.identifierSources;return 1===e.length&&_.isEmpty(e[0].prefix)},prototype.isIdentifierRequired=function(){return!!this.hasOldIdentifier||!!this.identifierType.required&&!this.hasIdentifierSources()},prototype.generate=function(){this.registrationNumber&&this.registrationNumber.length>0?(this.identifier=this.selectedIdentifierSource?this.selectedIdentifierSource.prefix+this.registrationNumber:this.registrationNumber,this.voided=!1):this.uuid&&(this.voided=!0)},prototype.clearRegistrationNumber=function(){this.registrationNumber=null,this.identifier=null},angular.module("bahmni.registration").factory("identifiers",["$rootScope","preferences",function(e,t){var n=function(e){return _.find(e,{identifierType:{primary:!0}})},r=function(e){return _.filter(e,{identifierType:{primary:!1}})};return{create:function(){var i=[];return _.each(e.patientConfiguration.identifierTypes,function(e){var n=new Bahmni.Registration.Identifier(e);n.isPrimary()&&(n.selectedIdentifierSource=_.find(n.identifierType.identifierSources,{prefix:t.identifierPrefix}),n.hasOldIdentifier=t.hasOldIdentifier),n.selectedIdentifierSource=n.selectedIdentifierSource||n.identifierType.identifierSources[0],i.push(n)}),{primaryIdentifier:n(i),extraIdentifiers:r(i)}},mapIdentifiers:function(t){var i=[];return _.each(e.patientConfiguration.identifierTypes,function(e){var n=new Bahmni.Registration.Identifier(e).map(t);i.push(n)}),{primaryIdentifier:n(i),extraIdentifiers:r(i)}}}}]),angular.module("bahmni.registration").factory("preferences",[function(){return{hasOldIdentifier:!1}}]),Bahmni.Registration.RegistrationEncounterConfig=function(){function e(e,t,n){this.conceptData=e,this.encounterTypes=t,this.visitTypes=n}return e.prototype={getVisitTypesAsArray:function(){var e=[];for(var t in this.visitTypes)e.push({name:t,uuid:this.visitTypes[t]});return e},getDefaultVisitType:function(e){var t=null;return _.each(this.loginLocationToVisitTypeMap.results,function(n){n.entity.uuid===e&&(t=n.mappings[0].name)}),t}},e}(),Bahmni.Registration.PatientConfig=function(){function e(e,t,n){this.attributeTypes=e,this.identifierTypes=t;var r={};if(!this.attributeRows&&this.attributeTypes){if(!n)return void(this.attributeRows=this.splitAsRows(this.attributeTypes));var i=n.hidden&&n.hidden.attributes;delete n.hidden;var o=this.attributeTypes.map(function(e){return e.keyPrefix="PATIENT_ATTRIBUTE_",e}).filter(function(e){return!function(e,t){return e&&e.indexOf(t.name)>-1}(i,e)&&!function(e){return["healthCenter","givenNameLocal","middleNameLocal","familyNameLocal"].indexOf(e.name)>-1}(e)&&!function(e,t,n){return _.find(e,function(e,r){return _.find(e.attributes,function(i){if(i===n.name){var o=t[r];return o||(o={attributes:[],title:e.title,expanded:e.expanded,translationKey:e.translationKey,shortcutKey:e.shortcutKey,order:e.order,canShow:!0}),o.attributes.push(n),t[r]=o,!0}return!1})})}(n,r,e)});this.attributeRows=this.splitAsRows(o),this.patientAttributesSections=r}}return e.prototype={get:function(e){return this.attributeTypes.filter(function(t){return t.uuid===e})[0]},customAttributeRows:function(){return this.attributeRows},getPatientAttributesSections:function(){return this.patientAttributesSections},getOrderedPatientAttributesSections:function(){return _.sortBy(this.patientAttributesSections,"order")},splitAsRows:function(e){var t=[],n=[];for(var r in e)n.push(e[r]),0!==r&&r%2!=0&&(t.push(n),n=[]);return n.length>0&&t.push(n),t},heathCentreAttribute:function(){return this.attributeTypes.filter(function(e){return"healthCenter"===e.name})[0]},local:function(){var e=this.attributeTypes.filter(function(e){return"givenNameLocal"===e.name})[0],t=this.attributeTypes.filter(function(e){return"middleNameLocal"===e.name})[0],n=this.attributeTypes.filter(function(e){return"familyNameLocal"===e.name})[0],r=this.attributeTypes.filter(function(e){return"surnameLocal"===e.name})[0];return e&&t&&n&&r?{showNameField:!0,labelForNameField:e.description,placeholderForGivenName:e.description,placeholderForMiddleName:t.description,placeholderForFamilyName:n.description,placeholderForSurname:r.description}:{showNameField:!1}}},e}(),(Bahmni=Bahmni||{}).Common=Bahmni.Common||{},Bahmni.Common.PatientSearch=Bahmni.Common.PatientSearch||{},Bahmni.Common.PatientSearch.Constants={searchExtensionTileViewType:"tile",searchExtensionTabularViewType:"tabular",tabularViewIgnoreHeadingsList:["display","uuid","image","$$hashKey","activeVisitUuid","hasBeenAdmitted","forwardUrl","programUuid","enrollment"],identifierHeading:["ID","Id","id","identifier","DQ_COLUMN_TITLE_ACTION"],nameHeading:["NAME","Name","name"],patientTileHeight:100,patientTileWidth:100,printIgnoreHeadingsList:["DQ_COLUMN_TITLE_ACTION"],tileLoadRatio:.5},Bahmni.Common.PatientSearch.Search=function(e){function t(e){return(e.name||e.givenName||e.familyName)&&(e.name=e.name||e.givenName+(e.familyName?" "+e.familyName:"")),e.display=_.map(n.searchColumns,function(t){return e[t]}).join(" - "),e.image=Bahmni.Common.Constants.patientImageUrlByPatientUuid+e.uuid,e}var n=this;n.searchTypes=e||[],n.searchType=this.searchTypes[0],n.searchParameter="",n.noResultsMessage=null,n.searchResults=[],n.activePatients=[],n.navigated=!1,n.links=n.searchType&&n.searchType.links?n.searchType.links:[],n.searchColumns=n.searchType&&n.searchType.searchColumns?n.searchType.searchColumns:["identifier","name"],angular.forEach(e,function(e){e.patientCount="..."}),n.switchSearchType=function(e){n.noResultsMessage=null,n.isSelectedSearch(e)||(n.searchParameter="",n.navigated=!0,n.searchType=e,n.activePatients=[],n.searchResults=[],n.links=n.searchType&&n.searchType.links?n.searchType.links:[],n.searchColumns=n.searchType&&n.searchType.searchColumns?n.searchType.searchColumns:["identifier","name"]),n.markPatientEntry()},n.markPatientEntry=function(){n.startPatientSearch=!0,window.setTimeout(function(){n.startPatientSearch=!1})},n.patientsCount=function(){return n.activePatients.length},n.updatePatientList=function(e){n.activePatients=e.map(t),n.searchResults=n.activePatients},n.updateSearchResults=function(e){n.updatePatientList(e),0===n.activePatients.length&&""!=n.searchParameter?n.noResultsMessage="NO_RESULTS_FOUND":n.noResultsMessage=null},n.hasSingleActivePatient=function(){return 1===n.activePatients.length},n.filterPatients=function(e){e=e||r,n.searchResults=n.searchParameter?n.activePatients.filter(e):n.activePatients},n.filterPatientsByIdentifier=function(){n.filterPatients(i)},n.isSelectedSearch=function(e){return n.searchType&&n.searchType.id==e.id},n.isCurrentSearchLookUp=function(){return n.searchType&&n.searchType.handler},n.isTileView=function(){return n.searchType&&n.searchType.view===Bahmni.Common.PatientSearch.Constants.searchExtensionTileViewType},n.isTabularView=function(){return n.searchType&&n.searchType.view===Bahmni.Common.PatientSearch.Constants.searchExtensionTabularViewType},n.showPatientCountOnSearchParameter=function(e){return o(e)&&n.searchParameter};var r=function(e){return-1!==e.display.toLowerCase().indexOf(n.searchParameter.toLowerCase())},i=function(e){return-1!==e.identifier.toLowerCase().indexOf(n.searchParameter.toLowerCase())},o=function(e){return n.isSelectedSearch(e)&&n.isCurrentSearchLookUp()}},angular.module("bahmni.common.patientSearch",["bahmni.common.patient","infinite-scroll"]),angular.module("bahmni.common.patientSearch").controller("PatientsListController",["$scope","$window","patientService","$rootScope","appService","spinner","$stateParams","$bahmniCookieStore","printer","configurationService",function(e,t,n,r,i,o,a,s,u,c){var l,m=i.getAppDescriptor().getConfigValue("patientSearch");e.searchPatients=function(){return o.forPromise(n.search(e.search.searchParameter)).then(function(t){e.search.updateSearchResults(t.data.pageOfResults),e.search.hasSingleActivePatient()&&e.forwardPatient(e.search.activePatients[0])})},e.filterPatientsAndSubmit=function(){1==e.search.searchResults.length&&e.forwardPatient(e.search.searchResults[0])};var f=function(t,i){if(t.handler){var a={q:t.handler,v:"full",location_uuid:s.get(Bahmni.Common.Constants.locationCookieName).uuid,provider_uuid:r.currentProvider.uuid};t.additionalParams&&(a.additionalParams=t.additionalParams),n.findPatients(a).then(function(n){t.patientCount=n.data.length,e.search.isSelectedSearch(t)&&e.search.updatePatientList(n.data),i&&p(o,i,$(".tab-content"))})}},p=function(e,t,n){e.hide(t,n),$(n).children("patient-list-spinner").hide()};e.getHeadings=function(e){return e&&e.length>0?_.chain(e[0]).keys().filter(function(e){return-1===_.indexOf(Bahmni.Common.PatientSearch.Constants.tabularViewIgnoreHeadingsList,e)}).value():[]},e.isHeadingOfLinkColumn=function(t){var n=_.includes(Bahmni.Common.PatientSearch.Constants.identifierHeading,t);return n||(e.search.searchType&&e.search.searchType.links?_.find(e.search.searchType.links,{linkColumn:t}):e.search.searchType&&e.search.searchType.linkColumn?_.includes([e.search.searchType.linkColumn],t):void 0)},e.isHeadingOfName=function(e){return _.includes(Bahmni.Common.PatientSearch.Constants.nameHeading,e)},e.getPrintableHeadings=function(t){return e.getHeadings(t).filter(function(e){return-1===_.indexOf(Bahmni.Common.PatientSearch.Constants.printIgnoreHeadingsList,e)})},e.printPage=function(){null!=e.search.searchType.printHtmlLocation&&u.printFromScope(e.search.searchType.printHtmlLocation,e)};var d=function(e){return{name:e.label,display:e.extensionParams.display,handler:e.extensionParams.searchHandler,forwardUrl:e.extensionParams.forwardUrl,id:e.id,params:e.extensionParams.searchParams,refreshTime:e.extensionParams.refreshTime||0,view:e.extensionParams.view||Bahmni.Common.PatientSearch.Constants.searchExtensionTileViewType,showPrint:e.extensionParams.showPrint||!1,printHtmlLocation:e.extensionParams.printHtmlLocation||null,additionalParams:e.extensionParams.additionalParams,searchColumns:e.extensionParams.searchColumns,translationKey:e.extensionParams.translationKey,linkColumn:e.extensionParams.linkColumn,links:e.extensionParams.links}},h=_.debounce(function(e,t){f(e,t)},m&&m.fetchDelay||2e3,{}),g=function(t){var n,i;void 0!==l&&p(o,l,$(".tab-content")),r.currentSearchType=t,e.search.isCurrentSearchLookUp()&&(n=o,i=$(".tab-content"),$(i).children("patient-list-spinner").show(),l=n.show(i),m&&m.debounceSearch?h(t,l):f(t,l))};e.forwardPatient=function(n,o){var s=$.extend({},a);r.patientAdmitLocationStatus=n.Status,$.extend(s,{patientUuid:n.uuid,visitUuid:n.activeVisitUuid||null,encounterUuid:a.encounterUuid||"active",programUuid:n.programUuid||null,enrollment:n.enrollment||null,forwardUrl:n.forwardUrl||null,dateEnrolled:n.dateEnrolled||null});var u=s.forwardUrl?{url:s.forwardUrl,newTab:!0}:{url:e.search.searchType.forwardUrl,newTab:!1};e.search.searchType.links&&(u=_.find(e.search.searchType.links,{linkColumn:o})||u),u.url&&null!==u.url&&t.open(i.getAppDescriptor().formatUrl(u.url,s,!0),u.newTab?"_blank":"_self")};var v,b=function(t){if(t!==e.search.searchTypes.length){var i=e.search.searchTypes[t];if(i.handler){var o={q:i.handler,v:"full",location_uuid:s.get(Bahmni.Common.Constants.locationCookieName).uuid,provider_uuid:r.currentProvider.uuid};i.additionalParams&&(o.additionalParams=i.additionalParams),n.findPatients(o).then(function(n){return i.patientCount=n.data.length,e.search.isSelectedSearch(i)&&e.search.updatePatientList(n.data),b(t+1)})}}};v=i.getAppDescriptor().getExtensions("org.bahmni.patient.search","config").map(d),e.search=new Bahmni.Common.PatientSearch.Search(_.without(v,void 0)),e.search.markPatientEntry(),e.$watch("search.searchType",function(e){_.isEmpty(e)||g(e)}),e.$watch("search.activePatients",function(e){e.length>0&&l&&p(o,l,$(".tab-content"))}),m&&m.serializeSearch?b(0):_.each(e.search.searchTypes,function(t){_.isEmpty(t)||e.search.searchType!=t&&f(t,null)}),null!=r.currentSearchType&&e.search.switchSearchType(r.currentSearchType),c.getConfigurations(["identifierTypesConfig"]).then(function(t){e.primaryIdentifier=_.find(t.identifierTypesConfig,{primary:!0}).name})}]);